<!doctype html>
<html lang="fr" data-page-role="operator">
<head>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Gestion des membres - AG-VOTE">
  <title>Membres — AG-VOTE</title>
  <link rel="stylesheet" href="/assets/css/app.css">
  <link rel="stylesheet" href="/assets/css/members.css">
</head>
<body>
  <!-- Skip links -->
  <a href="#membersList" class="skip-link">Aller à la liste des membres</a>
  <a href="#main-nav" class="skip-link">Aller à la navigation</a>

  <div class="app-shell">
    <aside class="app-sidebar" data-include-sidebar data-page="members"></aside>

    <!-- Header -->
    <header class="app-header">
      <div class="flex items-center gap-4">
        <div>
          <h1 class="text-xl font-bold">Membres</h1>
          <p class="text-sm text-secondary">Gestion des participants et pondération</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a class="btn btn-secondary btn-sm" href="/api/v1/members_export_csv.php" target="_blank">
          <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-download"></use></svg>
          Exporter CSV
        </a>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="context" title="Séance en cours">
          <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-menu"></use></svg>
        </button>
      </div>
    </header>

    <main class="app-main members-main">
      <!-- Stats bar -->
      <div class="stats-bar">
        <div class="stat-item total">
          <div class="stat-value" id="kpiTotal">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-item active">
          <div class="stat-value" id="kpiActive">0</div>
          <div class="stat-label">Actifs</div>
        </div>
        <div class="stat-item inactive">
          <div class="stat-value" id="kpiInactive">0</div>
          <div class="stat-label">Inactifs</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="kpiPower">0</div>
          <div class="stat-label">Voix totales</div>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="kpiAvgPower">—</span>
          <span class="stat-label">Pouvoir moyen</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="kpiEmailCoverage">—</span>
          <span class="stat-label">Couv. email</span>
        </div>
      </div>
      <div id="notif_box" class="alert hidden mb-4" style="margin: 1rem 1.5rem 0;"></div>

      <!-- Management panels (collapsible, above the two-column layout) -->
      <div class="members-management">
        <!-- Create member card -->
        <div class="create-card">
          <h3>
            <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-user-plus"></use></svg>
            Ajouter un membre
          </h3>
          <div class="create-form">
            <div class="form-group">
              <label for="mName">Nom complet *</label>
              <input class="form-input" type="text" id="mName" placeholder="Jean Dupont" required>
            </div>
            <div class="form-group">
              <label for="mEmail">Email</label>
              <input class="form-input" type="email" id="mEmail" placeholder="jean@exemple.com">
            </div>
            <div class="form-group">
              <label for="mPower">
                Nombre de voix
                <ag-popover title="Nombre de voix" content="Nombre de voix que ce membre représente. La valeur par défaut est 1. Pour une pondération, utilisez un nombre supérieur (ex: 2 = 2 voix). Affecte le calcul du quorum et les résultats des votes." position="top"></ag-popover>
              </label>
              <input class="form-input" type="number" id="mPower" value="1" min="0" step="1">
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <label class="flex items-center gap-2">
                <input type="checkbox" id="mActive" checked>
                <span>Actif</span>
              </label>
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <button class="btn btn-primary" id="btnCreate">Ajouter</button>
            </div>
          </div>
        </div>

        <!-- Management tabs -->
        <div class="mgmt-panels-row">
          <div class="mgmt-tabs" role="tablist" aria-label="Gestion des membres">
            <button class="mgmt-tab active" role="tab" aria-selected="true" aria-controls="groupsPanel" data-mgmt-tab="groups">
              <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-users"></use></svg>
              Groupes
            </button>
            <button class="mgmt-tab" role="tab" aria-selected="false" aria-controls="importPanel" data-mgmt-tab="import">
              <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-upload"></use></svg>
              Importation CSV
            </button>
          </div>

          <!-- Groups tab panel -->
          <div class="mgmt-tab-panel" id="groupsPanel" role="tabpanel">
            <p class="text-sm text-muted mb-4">
              Organisez vos membres par catégories, collèges électoraux, départements, etc.
              <ag-popover title="Groupes de membres" content="Catégorisez vos membres par collèges électoraux, départements, ou tout autre critère. Les groupes facilitent le filtrage et permettent d'obtenir des statistiques par catégorie." position="right" trigger="click"></ag-popover>
            </p>
            <div class="create-group-form">
              <div class="form-group">
                <label for="groupName">Nom du groupe</label>
                <input class="form-input" type="text" id="groupName" placeholder="Ex: Collège A, Cadres...">
              </div>
              <div class="form-group form-group-color">
                <label for="groupColor">Couleur</label>
                <input type="color" id="groupColor" value="#6366f1">
              </div>
              <button class="btn btn-primary" id="btnCreateGroup">Créer groupe</button>
            </div>
            <div class="groups-grid" id="groupsList">
              <div class="text-muted text-sm">Chargement...</div>
            </div>
          </div>

          <!-- Import tab panel -->
          <div class="mgmt-tab-panel" id="importPanel" role="tabpanel" style="display: none;">
            <div class="import-card-desc">
              Colonnes : <code>nom</code>, <code>email</code>, <code>ponderation</code>, <code>actif</code>, <code>groupes</code> (séparés par <code>|</code>). Séparateur <code>;</code> ou <code>,</code> auto-détecté.
              <ag-popover title="Format du fichier CSV" content="Exemple : Jean Dupont;jean@exemple.com;1;oui;Collège A|Cadres. Les groupes non existants seront créés automatiquement. Colonnes alternatives acceptées : name, full_name, voting_power, is_active, groups, college, categorie…" position="right" trigger="click"></ag-popover>
            </div>
            <div class="import-template-link flex gap-3 flex-wrap">
              <a href="/assets/modele_import_membres.csv" download class="btn btn-ghost btn-sm">
                <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-download"></use></svg>
                Modèle vierge CSV
              </a>
              <a href="/assets/demo_membres_ag.csv" download class="btn btn-ghost btn-sm">
                <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-download"></use></svg>
                Exemple avec 25 membres (démo)
              </a>
            </div>
            <div class="upload-zone" id="uploadZone">
              <input type="file" id="csvFile" accept=".csv,text/csv" style="display: none;" aria-label="Importer un fichier CSV">
              <div class="upload-zone-icon">
                <svg class="icon" style="width:2rem;height:2rem;" aria-hidden="true"><use href="/assets/icons.svg#icon-upload"></use></svg>
              </div>
              <div class="upload-zone-text">Glisser un fichier CSV ici</div>
              <div class="upload-zone-hint">ou cliquer pour sélectionner</div>
            </div>
            <div class="flex gap-2 mt-4">
              <button class="btn btn-primary" id="btnImport" disabled>Importer</button>
              <button class="btn btn-secondary" id="btnSeed">Générer fictifs</button>
              <span class="text-sm text-muted file-name-text" id="fileName">Aucun fichier sélectionné</span>
            </div>
            <div id="importOut" class="import-result" style="display: none;"></div>
          </div>
        </div>
      </div>

      <!-- Two-column layout: filters sidebar + results grid -->
      <div class="members-layout">

        <!-- LEFT: Search & Filters panel -->
        <aside class="members-filters-panel" aria-label="Recherche et filtres">
          <div class="filters-panel-header">
            <h2>Recherche</h2>
            <span class="filters-hint" id="activeFiltersHint">0 filtre</span>
          </div>
          <div class="filters-panel-body">
            <!-- Search -->
            <div class="field">
              <label for="searchInput">Nom, email…</label>
              <div class="search-input-wrap">
                <svg class="icon search-input-icon" aria-hidden="true"><use href="/assets/icons.svg#icon-search"></use></svg>
                <input class="form-input search-input-field" type="search" id="searchInput" placeholder="Rechercher un membre...">
              </div>
            </div>

            <!-- Status filter -->
            <div class="field">
              <label>Statut</label>
              <div class="filter-chips" role="group" aria-label="Filtrer par statut">
                <button class="filter-chip active" data-filter="all">Tous</button>
                <button class="filter-chip" data-filter="active">Actifs</button>
                <button class="filter-chip" data-filter="inactive">Inactifs</button>
              </div>
            </div>

            <!-- Group filters -->
            <div class="field" id="groupFiltersField" style="display: none;">
              <label>Groupes</label>
              <div class="filter-chips filter-chips-col" id="groupFilters" role="group" aria-label="Filtrer par groupe">
                <!-- Populated by JavaScript -->
              </div>
            </div>

            <!-- Sort -->
            <div class="field">
              <label for="sortSelect">Trier par</label>
              <select class="form-input" id="sortSelect">
                <option value="nameAsc">Nom (A → Z)</option>
                <option value="nameDesc">Nom (Z → A)</option>
                <option value="powerDesc">Nombre de voix (décroissant)</option>
                <option value="powerAsc">Nombre de voix (croissant)</option>
              </select>
            </div>
          </div>
        </aside>

        <!-- RIGHT: Results -->
        <section class="members-results" aria-label="Résultats">
          <div class="results-meta">
            <div class="results-meta-left">
              <span class="results-count" id="membersCount">0 membre</span>
              <span class="results-subtitle" id="resultsSubtitle">Affichage de l'ensemble des membres</span>
            </div>
          </div>
          <div class="members-grid" id="membersList">
            <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
            <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
            <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
            <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
          </div>
          <nav class="pagination" id="pagination" aria-label="Pagination des membres">
            <button class="pagination-btn" id="paginPrev" type="button" disabled aria-label="Page précédente">
              <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-chevron-left"></use></svg>
            </button>
            <span class="pagination-info" id="paginInfo">Page 1 / 1</span>
            <button class="pagination-btn" id="paginNext" type="button" disabled aria-label="Page suivante">
              <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-chevron-right"></use></svg>
            </button>
            <select class="form-input pagination-size" id="paginSize" aria-label="Membres par page">
              <option value="12">12 / page</option>
              <option value="24">24 / page</option>
              <option value="48">48 / page</option>
              <option value="96">96 / page</option>
            </select>
          </nav>
        </section>

      </div>
    </main>
  </div>

  <!-- Member detail dialog -->
  <dialog id="memberDetailDialog" aria-labelledby="memberDetailTitle">
    <div class="dialog-header">
      <h3 id="memberDetailTitle">Fiche membre</h3>
      <button class="btn btn-ghost btn-icon btn-sm" id="closeMemberDetail" type="button" aria-label="Fermer">
        <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-x"></use></svg>
      </button>
    </div>
    <div class="dialog-body" id="memberDetailBody"></div>
  </dialog>

  <!-- Drawer -->
  <div class="drawer-backdrop" data-drawer-close></div>
  <aside class="drawer" id="drawer" role="dialog" aria-modal="true" aria-label="Panneau latéral">
    <div class="drawer-header">
      <div id="drawerTitle" class="font-semibold">Menu</div>
      <button class="btn btn-ghost btn-icon btn-sm" type="button" data-drawer-close aria-label="Fermer le panneau">✕</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
  </aside>

  <!-- Scripts -->
  <script type="module" src="/assets/js/components/index.js"></script>
  <script src="/assets/js/core/utils.js"></script>
  <script src="/assets/js/core/shared.js"></script>
  <script src="/assets/js/core/shell.js"></script>
  <script src="/assets/js/services/meeting-context.js"></script>

  <script>
  (function() {
    'use strict';

    const searchInput = document.getElementById('searchInput');
    const membersList = document.getElementById('membersList');
    const membersCount = document.getElementById('membersCount');
    const resultsSubtitle = document.getElementById('resultsSubtitle');
    const filterChips = document.querySelectorAll('.filter-chip[data-filter]');
    const uploadZone = document.getElementById('uploadZone');
    const csvFile = document.getElementById('csvFile');
    const btnImport = document.getElementById('btnImport');
    const fileName = document.getElementById('fileName');
    const groupsList = document.getElementById('groupsList');
    const groupFilters = document.getElementById('groupFilters');
    const groupFiltersField = document.getElementById('groupFiltersField');
    const sortSelect = document.getElementById('sortSelect');
    const activeFiltersHint = document.getElementById('activeFiltersHint');
    const memberDetailDialog = document.getElementById('memberDetailDialog');
    const memberDetailBody = document.getElementById('memberDetailBody');

    let allMembers = [];
    let allGroups = [];
    let memberGroups = {}; // memberId -> [groupIds]
    let currentFilter = 'all';
    let currentGroupFilter = null; // null = all groups
    let currentPage = 1;
    let pageSize = 12;

    const paginPrev = document.getElementById('paginPrev');
    const paginNext = document.getElementById('paginNext');
    const paginInfo = document.getElementById('paginInfo');
    const paginSizeSelect = document.getElementById('paginSize');

    // Format voting power (avoid showing 1.0000, show 1 for integers)
    function formatVotingPower(vp) {
      const val = parseFloat(vp) || 1;
      return Number.isInteger(val) ? val : val.toFixed(2).replace(/\.?0+$/, '');
    }

    // Management tabs switching
    document.querySelectorAll('.mgmt-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.mgmt-tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
        document.querySelectorAll('.mgmt-tab-panel').forEach(p => { p.style.display = 'none'; });
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');
        const panelId = tab.getAttribute('aria-controls');
        if (panelId) document.getElementById(panelId).style.display = '';
      });
    });

    // Update active filters count hint
    function updateFiltersHint() {
      let n = 0;
      if (searchInput.value.trim()) n++;
      if (currentFilter !== 'all') n++;
      if (currentGroupFilter) n++;
      activeFiltersHint.textContent = n + (n > 1 ? ' filtres' : ' filtre');

      resultsSubtitle.textContent = n > 0
        ? 'Filtré selon vos critères'
        : 'Affichage de l\'ensemble des membres';
    }

    // Update stats
    function updateStats(members) {
      const total = members.length;
      const active = members.filter(m => m.is_active).length;
      const inactive = total - active;
      const power = members.filter(m => m.is_active).reduce((sum, m) => {
        const vp = parseFloat(m.voting_power) || 1;
        return sum + vp;
      }, 0);

      document.getElementById('kpiTotal').textContent = total;
      document.getElementById('kpiActive').textContent = active;
      document.getElementById('kpiInactive').textContent = inactive;
      document.getElementById('kpiPower').textContent = Number.isInteger(power) ? power : power.toFixed(2);

      // Average voting power per active member
      var kpiAvgPower = document.getElementById('kpiAvgPower');
      if (kpiAvgPower) {
        if (active > 0) {
          var avg = power / active;
          kpiAvgPower.textContent = Number.isInteger(avg) ? avg : avg.toFixed(2);
        } else {
          kpiAvgPower.textContent = '\u2014';
        }
      }

      // Email coverage (active members with email / active members)
      var kpiEmailCoverage = document.getElementById('kpiEmailCoverage');
      if (kpiEmailCoverage) {
        if (active > 0) {
          var withEmail = members.filter(function(m) { return m.is_active && m.email; }).length;
          var pct = Math.round((withEmail / active) * 100);
          kpiEmailCoverage.textContent = pct + '%';
        } else {
          kpiEmailCoverage.textContent = '\u2014';
        }
      }
    }

    // Filter members
    function filterMembers(members, filter, search = '', groupId = null) {
      let filtered = members;

      if (filter === 'active') {
        filtered = filtered.filter(m => m.is_active);
      } else if (filter === 'inactive') {
        filtered = filtered.filter(m => !m.is_active);
      }

      if (search) {
        const s = search.toLowerCase();
        filtered = filtered.filter(m =>
          (m.full_name || m.name || '').toLowerCase().includes(s) ||
          (m.email || '').toLowerCase().includes(s)
        );
      }

      if (groupId) {
        filtered = filtered.filter(m => {
          const groups = memberGroups[m.id] || [];
          return groups.includes(groupId);
        });
      }

      return filtered;
    }

    // Sort members
    function sortMembers(members) {
      const v = sortSelect.value;
      const norm = s => (s || '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '');
      const copy = [...members];

      if (v === 'nameAsc') copy.sort((a, b) => norm(a.full_name || a.name).localeCompare(norm(b.full_name || b.name)));
      if (v === 'nameDesc') copy.sort((a, b) => norm(b.full_name || b.name).localeCompare(norm(a.full_name || a.name)));
      if (v === 'powerDesc') copy.sort((a, b) => (parseFloat(b.voting_power) || 1) - (parseFloat(a.voting_power) || 1));
      if (v === 'powerAsc') copy.sort((a, b) => (parseFloat(a.voting_power) || 1) - (parseFloat(b.voting_power) || 1));

      return copy;
    }

    // ==========================================
    // GROUPS MANAGEMENT
    // ==========================================

    async function fetchGroups() {
      try {
        const { body } = await api('/api/v1/member_groups.php');
        allGroups = body?.data?.groups || [];
        renderGroups();
        renderGroupFilters();
      } catch (err) {
        console.error('Fetch groups error:', err);
        groupsList.innerHTML = '<div class="text-danger text-sm">Erreur de chargement</div>';
      }
    }

    function renderGroups() {
      if (!allGroups.length) {
        groupsList.innerHTML = '<div class="text-muted text-sm">Aucun groupe créé</div>';
        return;
      }

      groupsList.innerHTML = allGroups.map(g => `
        <div class="group-card" data-group-id="${g.id}">
          <div class="group-info">
            <div class="group-color-dot" style="background-color: ${escapeHtml(g.color || '#6366f1')}"></div>
            <div class="group-details">
              <div class="group-name">${escapeHtml(g.name)}</div>
              <div class="group-count">${g.member_count || 0} membre${(g.member_count || 0) > 1 ? 's' : ''}</div>
            </div>
          </div>
          <div class="group-actions">
            <button class="member-action-btn" data-action="edit-group" data-id="${g.id}" title="Modifier"><svg class="icon"><use href="/assets/icons.svg#icon-edit"></use></svg></button>
            <button class="member-action-btn danger" data-action="delete-group" data-id="${g.id}" title="Supprimer"><svg class="icon"><use href="/assets/icons.svg#icon-trash"></use></svg></button>
          </div>
        </div>
      `).join('');
    }

    function renderGroupFilters() {
      if (!allGroups.length) {
        groupFilters.innerHTML = '';
        groupFiltersField.style.display = 'none';
        return;
      }

      groupFiltersField.style.display = '';
      const allBtn = `<button class="filter-chip ${!currentGroupFilter ? 'active' : ''}" data-action="filter-group" data-group-id="">Tous les groupes</button>`;
      const groupBtns = allGroups.map(g => `
        <button class="filter-chip ${currentGroupFilter === g.id ? 'active' : ''}" data-action="filter-group" data-group-id="${g.id}">
          <span class="group-color-dot-sm" style="background-color: ${escapeHtml(g.color || '#6366f1')}"></span>
          ${escapeHtml(g.name)}
        </button>
      `).join('');

      groupFilters.innerHTML = allBtn + groupBtns;
    }

    window.filterByGroup = function(groupId) {
      currentGroupFilter = groupId;
      currentPage = 1;
      renderGroupFilters();
      renderMembers(allMembers);
      updateFiltersHint();
    };

    document.getElementById('btnCreateGroup').addEventListener('click', async () => {
      const name = document.getElementById('groupName').value.trim();
      const color = document.getElementById('groupColor').value || '#6366f1';

      if (!name) {
        setNotif('error', 'Le nom du groupe est requis');
        return;
      }

      const btn = document.getElementById('btnCreateGroup');
      Shared.btnLoading(btn, true);

      try {
        const { body } = await api('/api/v1/member_groups.php', { name, color });

        if (body?.ok) {
          setNotif('success', 'Groupe créé');
          document.getElementById('groupName').value = '';
          await fetchGroups();
        } else {
          setNotif('error', body?.detail || body?.error || 'Erreur');
        }
      } catch (err) {
        setNotif('error', err.message);
      } finally {
        Shared.btnLoading(btn, false);
      }
    });

    window.editGroup = function(groupId) {
      const group = allGroups.find(g => g.id === groupId);
      if (!group) return;

      Shared.openModal({
        title: 'Modifier le groupe',
        body: `
          <div class="form-group mb-3">
            <label class="form-label">Nom du groupe *</label>
            <input class="form-input" type="text" id="editGroupName" value="${escapeHtml(group.name)}" placeholder="Nom du groupe">
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-input" id="editGroupDesc" placeholder="Description optionnelle" rows="2">${escapeHtml(group.description || '')}</textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Couleur</label>
            <input type="color" id="editGroupColor" value="${group.color || '#6366f1'}">
          </div>
        `,
        confirmText: 'Enregistrer',
        onConfirm: async function(modal) {
          const newName = modal.querySelector('#editGroupName').value.trim();
          const newDesc = modal.querySelector('#editGroupDesc').value.trim();
          const newColor = modal.querySelector('#editGroupColor').value;

          if (!newName) {
            setNotif('error', 'Le nom est requis');
            return false;
          }

          try {
            const { body } = await api('/api/v1/member_groups.php', {
              id: groupId,
              name: newName,
              description: newDesc || null,
              color: newColor
            }, 'PATCH');

            if (body?.ok) {
              setNotif('success', 'Groupe modifié');
              await fetchGroups();
              return true;
            } else {
              setNotif('error', body?.detail || body?.error || 'Erreur');
              return false;
            }
          } catch (err) {
            setNotif('error', err.message);
            return false;
          }
        }
      });
    };

    window.deleteGroup = async function(groupId) {
      const group = allGroups.find(g => g.id === groupId);
      if (!group) return;

      if (!confirm(`Supprimer le groupe "${group.name}" ? Les membres ne seront pas supprimés.`)) return;

      try {
        const { body } = await api(`/api/v1/member_groups.php?id=${encodeURIComponent(groupId)}`, null, 'DELETE');

        if (body?.ok) {
          setNotif('success', 'Groupe supprimé');
          if (currentGroupFilter === groupId) {
            currentGroupFilter = null;
          }
          await fetchGroups();
          await fetchMembers();
        } else {
          setNotif('error', body?.detail || body?.error || 'Erreur');
        }
      } catch (err) {
        setNotif('error', err.message);
      }
    };

    function getMemberGroupBadges(memberId) {
      const groups = memberGroups[memberId] || [];
      if (!groups.length) return '';

      return groups.map(gid => {
        const g = allGroups.find(x => x.id === gid);
        if (!g) return '';
        return `<span class="group-badge" style="background-color: ${escapeHtml(g.color || '#6366f1')}20; color: ${escapeHtml(g.color || '#6366f1')}">
          <span class="group-badge-dot" style="background-color: ${escapeHtml(g.color || '#6366f1')}"></span>
          ${escapeHtml(g.name)}
        </span>`;
      }).join('');
    }

    async function fetchMemberGroups() {
      memberGroups = {};
      for (const m of allMembers) {
        if (m.groups) {
          memberGroups[m.id] = m.groups.map(g => g.id);
        }
      }
    }

    // ==========================================
    // MEMBER DETAIL DIALOG
    // ==========================================

    window.openMemberDetail = function(memberId) {
      const m = allMembers.find(x => x.id === memberId);
      if (!m) return;

      const name = m.full_name || m.name || '—';
      const initials = name.split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
      const groupBadges = getMemberGroupBadges(m.id);

      memberDetailBody.innerHTML = `
        <div class="detail-header-row">
          <div class="detail-avatar ${m.is_active ? 'is-active' : ''}">${escapeHtml(initials)}</div>
          <div>
            <div class="detail-name">${escapeHtml(name)}</div>
            <div class="detail-status">${m.is_active
              ? '<span class="badge badge-success badge-sm">Actif</span>'
              : '<span class="badge badge-neutral badge-sm">Inactif</span>'}</div>
          </div>
        </div>
        <div class="detail-grid">
          <div class="detail-field">
            <div class="detail-label">Email</div>
            <div class="detail-value">${m.email
              ? '<a href="mailto:' + encodeURIComponent(m.email) + '">' + escapeHtml(m.email) + '</a>'
              : '<span class="text-muted">Non renseigné</span>'}</div>
          </div>
          <div class="detail-field">
            <div class="detail-label">Nombre de voix</div>
            <div class="detail-value detail-value-mono">${formatVotingPower(m.voting_power)}</div>
          </div>
          <div class="detail-field">
            <div class="detail-label">Identifiant</div>
            <div class="detail-value detail-value-mono" style="font-size: 0.75rem;">${escapeHtml(m.id)}</div>
          </div>
          ${groupBadges ? `
          <div class="detail-field detail-field-full">
            <div class="detail-label">Groupes</div>
            <div class="detail-value"><div class="member-groups">${groupBadges}</div></div>
          </div>` : ''}
        </div>
        <div class="detail-actions">
          <button class="btn btn-primary btn-sm" data-action="edit-member" data-id="${m.id}">
            <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-edit"></use></svg>
            Modifier
          </button>
          <button class="btn btn-secondary btn-sm" data-action="toggle-active" data-id="${m.id}" data-active="${!m.is_active}">
            <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-${m.is_active ? 'pause' : 'play'}"></use></svg>
            ${m.is_active ? 'Désactiver' : 'Activer'}
          </button>
          ${m.email ? `<a class="btn btn-ghost btn-sm" href="mailto:${encodeURIComponent(m.email)}">
            <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-mail"></use></svg>
            Contacter
          </a>` : ''}
        </div>
      `;

      if (typeof memberDetailDialog.showModal === 'function') memberDetailDialog.showModal();
      else memberDetailDialog.setAttribute('open', 'open');
    };

    document.getElementById('closeMemberDetail').addEventListener('click', () => memberDetailDialog.close());
    memberDetailDialog.addEventListener('click', (e) => {
      const r = memberDetailDialog.getBoundingClientRect();
      const inside = r.top <= e.clientY && e.clientY <= r.bottom && r.left <= e.clientX && e.clientX <= r.right;
      if (!inside) memberDetailDialog.close();
    });

    // ==========================================
    // RENDER MEMBERS
    // ==========================================

    function updatePagination(totalFiltered) {
      const totalPages = Math.max(1, Math.ceil(totalFiltered / pageSize));
      if (currentPage > totalPages) currentPage = totalPages;
      paginPrev.disabled = currentPage <= 1;
      paginNext.disabled = currentPage >= totalPages;
      paginInfo.textContent = `Page ${currentPage} / ${totalPages}`;
    }

    function renderMembers(members) {
      const search = searchInput.value.trim();
      const filtered = sortMembers(filterMembers(members, currentFilter, search, currentGroupFilter));
      const n = filtered.length;
      membersCount.textContent = `${n} membre${n > 1 ? 's' : ''}`;

      updatePagination(n);

      if (!n) {
        membersList.innerHTML = Shared.emptyState({
          icon: 'members',
          title: 'Aucun membre',
          description: 'Ajoutez des membres avec le formulaire ci-dessus ou importez un fichier CSV.'
        });
        return;
      }

      const start = (currentPage - 1) * pageSize;
      const paged = filtered.slice(start, start + pageSize);

      membersList.innerHTML = paged.map(m => {
        const name = m.full_name || m.name || '—';
        const initials = name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
        const cardClass = m.is_active ? 'is-active' : 'is-inactive';
        const statusBadge = m.is_active
          ? '<span class="badge badge-success badge-sm">Actif</span>'
          : '<span class="badge badge-neutral badge-sm">Inactif</span>';
        const groupBadges = getMemberGroupBadges(m.id);
        const vp = formatVotingPower(m.voting_power);

        return `
          <article class="member-card ${cardClass}" data-member-id="${m.id}" data-action="open-detail" data-id="${m.id}" aria-label="${escapeHtml(name)}">
            <div class="member-avatar">${escapeHtml(initials)}</div>
            <div class="member-card-body">
              <div class="member-card-main">
                <h3 class="member-name">${escapeHtml(name)}</h3>
                ${m.email ? '<span class="member-email">' + escapeHtml(m.email) + '</span>' : ''}
              </div>
              <div class="member-card-meta">
                <span class="member-weight" title="Nombre de voix">${vp} voix</span>
                ${statusBadge}
                ${groupBadges}
              </div>
            </div>
            <div class="member-card-actions">
              <button class="member-action-icon" data-action="edit-member" data-id="${m.id}" title="Modifier" aria-label="Modifier ${escapeHtml(name)}">
                <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-edit"></use></svg>
              </button>
              <button class="member-action-icon danger" data-action="delete-member" data-id="${m.id}" title="Supprimer" aria-label="Supprimer ${escapeHtml(name)}">
                <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-trash"></use></svg>
              </button>
            </div>
          </article>
        `;
      }).join('');
    }

    // ==========================================
    // DATA LOADING
    // ==========================================

    async function fetchMembers() {
      membersList.innerHTML = '<div class="text-center p-6 text-muted members-loading">Chargement...</div>';

      try {
        const { body } = await api('/api/v1/members.php?include_groups=1');
        allMembers = body?.data?.members || [];
        await fetchMemberGroups();
        updateStats(allMembers);
        renderMembers(allMembers);
      } catch (err) {
        membersList.innerHTML = `<div class="alert alert-danger members-loading">Erreur: ${escapeHtml(err.message)}</div>`;
      }
    }

    // ==========================================
    // CREATE MEMBER
    // ==========================================

    document.getElementById('btnCreate').addEventListener('click', async () => {
      const full_name = document.getElementById('mName').value.trim();
      const email = document.getElementById('mEmail').value.trim();
      const voting_power = parseInt(document.getElementById('mPower').value) || 1;
      const is_active = document.getElementById('mActive').checked;

      if (!full_name) {
        setNotif('error', 'Le nom est requis');
        document.getElementById('mName').focus();
        return;
      }

      const btn = document.getElementById('btnCreate');
      Shared.btnLoading(btn, true);

      try {
        const { body } = await api('/api/v1/members.php', {
          full_name,
          email: email || null,
          voting_power,
          is_active
        });

        if (body?.ok) {
          setNotif('success', 'Membre ajouté');
          document.getElementById('mName').value = '';
          document.getElementById('mEmail').value = '';
          document.getElementById('mPower').value = '1';
          document.getElementById('mActive').checked = true;
          await fetchMembers();
        } else {
          setNotif('error', body?.detail || body?.error || 'Erreur');
        }
      } catch (err) {
        setNotif('error', err.message);
      } finally {
        Shared.btnLoading(btn, false);
      }
    });

    // ==========================================
    // MEMBER ACTIONS
    // ==========================================

    window.toggleActive = async function(memberId, newStatus) {
      const member = allMembers.find(m => m.id === memberId);
      if (!member) return;

      try {
        const { body } = await api('/api/v1/members.php', {
          member_id: memberId,
          full_name: member.full_name || member.name,
          email: member.email || '',
          voting_power: member.voting_power || 1,
          is_active: newStatus
        }, 'PATCH');

        if (body?.ok) {
          member.is_active = newStatus;
          updateStats(allMembers);
          renderMembers(allMembers);
        } else {
          setNotif('error', body?.detail || body?.error || 'Erreur');
        }
      } catch (err) {
        setNotif('error', err.message);
      }
    };

    window.deleteMember = async function(memberId) {
      if (!confirm('Supprimer ce membre ?')) return;

      try {
        const { body } = await api('/api/v1/members.php', { member_id: memberId }, 'DELETE');

        if (body?.ok) {
          setNotif('success', 'Membre supprimé');
          await fetchMembers();
        } else {
          setNotif('error', body?.detail || body?.error || 'Erreur');
        }
      } catch (err) {
        setNotif('error', err.message);
      }
    };

    window.editMember = function(memberId) {
      const member = allMembers.find(m => m.id === memberId);
      if (!member) return;

      const name = member.full_name || member.name || '';
      const currentMemberGroups = memberGroups[memberId] || [];

      let groupsHtml = '';
      if (allGroups.length) {
        groupsHtml = `
          <div class="form-group mb-3">
            <label class="form-label">Groupes</label>
            <div class="groups-checkbox-list">
              ${allGroups.map(g => `
                <label class="group-checkbox-item">
                  <input type="checkbox" name="memberGroup" value="${g.id}" ${currentMemberGroups.includes(g.id) ? 'checked' : ''}>
                  <span class="group-color-dot" style="background-color: ${escapeHtml(g.color || '#6366f1')}"></span>
                  <span>${escapeHtml(g.name)}</span>
                </label>
              `).join('')}
            </div>
          </div>
        `;
      }

      Shared.openModal({
        title: 'Modifier le membre',
        body: `
          <div class="form-group mb-3">
            <label class="form-label">Nom complet *</label>
            <input class="form-input" type="text" id="editMemberName" value="${escapeHtml(name)}" placeholder="Jean Dupont">
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Email</label>
            <input class="form-input" type="email" id="editMemberEmail" value="${escapeHtml(member.email || '')}" placeholder="jean@exemple.com">
          </div>
          <div class="form-group mb-3">
            <label class="form-label">Nombre de voix</label>
            <input class="form-input" type="number" id="editMemberPower" value="${member.voting_power || 1}" min="0" step="1">
          </div>
          <div class="form-group mb-3">
            <label class="flex items-center gap-2">
              <input type="checkbox" id="editMemberActive" ${member.is_active ? 'checked' : ''}>
              <span>Membre actif</span>
            </label>
          </div>
          ${groupsHtml}
        `,
        confirmText: 'Enregistrer',
        onConfirm: async function(modal) {
          const newName = modal.querySelector('#editMemberName').value.trim();
          const newEmail = modal.querySelector('#editMemberEmail').value.trim();
          const newPower = parseInt(modal.querySelector('#editMemberPower').value) || 1;
          const newActive = modal.querySelector('#editMemberActive').checked;

          const selectedGroups = Array.from(modal.querySelectorAll('input[name="memberGroup"]:checked')).map(cb => cb.value);

          if (!newName) {
            setNotif('error', 'Le nom est requis');
            return false;
          }

          try {
            const { body } = await api('/api/v1/members.php', {
              member_id: memberId,
              full_name: newName,
              email: newEmail || null,
              voting_power: newPower,
              is_active: newActive
            }, 'PATCH');

            if (!body?.ok) {
              setNotif('error', body?.detail || body?.error || 'Erreur');
              return false;
            }

            const groupsChanged = JSON.stringify(selectedGroups.sort()) !== JSON.stringify(currentMemberGroups.sort());
            if (groupsChanged) {
              await api('/api/v1/member_group_assignments.php', {
                member_id: memberId,
                group_ids: selectedGroups
              }, 'PUT');
            }

            setNotif('success', 'Membre modifié');
            await fetchGroups();
            await fetchMembers();
            return true;
          } catch (err) {
            setNotif('error', err.message);
            return false;
          }
        }
      });
    };

    // ==========================================
    // EVENT LISTENERS
    // ==========================================

    // Filter chips (status)
    filterChips.forEach(chip => {
      chip.addEventListener('click', () => {
        filterChips.forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        currentFilter = chip.dataset.filter;
        currentPage = 1;
        renderMembers(allMembers);
        updateFiltersHint();
      });
    });

    // Search
    searchInput.addEventListener('input', () => {
      currentPage = 1;
      renderMembers(allMembers);
      updateFiltersHint();
    });

    // Sort
    sortSelect.addEventListener('change', () => {
      renderMembers(allMembers);
    });

    // Pagination
    paginPrev.addEventListener('click', () => {
      if (currentPage > 1) { currentPage--; renderMembers(allMembers); }
    });
    paginNext.addEventListener('click', () => {
      currentPage++; renderMembers(allMembers);
    });
    paginSizeSelect.addEventListener('change', () => {
      pageSize = parseInt(paginSizeSelect.value) || 20;
      currentPage = 1;
      renderMembers(allMembers);
    });

    // CSV upload
    uploadZone.addEventListener('click', () => csvFile.click());
    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });
    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });
    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        csvFile.files = e.dataTransfer.files;
        handleFileSelect();
      }
    });
    csvFile.addEventListener('change', handleFileSelect);

    function handleFileSelect() {
      if (csvFile.files.length) {
        fileName.textContent = csvFile.files[0].name;
        btnImport.disabled = false;
      }
    }

    // Import CSV
    btnImport.addEventListener('click', async () => {
      if (!csvFile.files.length) return;

      const formData = new FormData();
      formData.append('csv_file', csvFile.files[0]);

      Shared.btnLoading(btnImport, true);
      const importOut = document.getElementById('importOut');

      try {
        const resp = await fetch('/api/v1/members_import_csv.php', {
          method: 'POST',
          body: formData
        });
        const body = await resp.json();

        importOut.style.display = 'block';
        if (body?.ok) {
          const d = body.data || {};
          const imported = d.imported || 0;
          const skipped = d.skipped || 0;
          const errors = d.errors || [];

          let html = `<div class="import-summary import-summary-ok">
            <strong>${imported} membre${imported > 1 ? 's' : ''} importé${imported > 1 ? 's' : ''}</strong>`;
          if (skipped) html += ` — ${skipped} ligne${skipped > 1 ? 's' : ''} ignorée${skipped > 1 ? 's' : ''}`;
          html += '</div>';

          if (errors.length) {
            html += '<div class="import-errors"><div class="import-errors-title">Lignes en erreur :</div><ul>';
            errors.forEach(e => {
              html += `<li>Ligne ${e.line || '?'} : ${escapeHtml(e.error || e.message || 'Erreur')}</li>`;
            });
            html += '</ul></div>';
          }

          importOut.innerHTML = html;
          importOut.className = 'import-result';
          setNotif('success', `Import terminé : ${imported} membres`);
          await fetchMembers();
        } else {
          importOut.innerHTML = `<div class="import-summary import-summary-err">${escapeHtml(body?.error || body?.detail || 'Erreur import')}</div>`;
          importOut.className = 'import-result';
        }
      } catch (err) {
        importOut.style.display = 'block';
        importOut.innerHTML = `<div class="import-summary import-summary-err">${escapeHtml(err.message)}</div>`;
        importOut.className = 'import-result';
      } finally {
        Shared.btnLoading(btnImport, false);
        csvFile.value = '';
        fileName.textContent = 'Aucun fichier sélectionné';
        btnImport.disabled = true;
      }
    });

    // Generate seed members
    document.getElementById('btnSeed').addEventListener('click', async () => {
      if (!confirm('Générer 10 membres fictifs ?')) return;

      const btn = document.getElementById('btnSeed');
      Shared.btnLoading(btn, true);

      try {
        const { body } = await api('/api/v1/dev_seed_members.php', { count: 10 });

        if (body?.ok) {
          setNotif('success', `${body.data?.created || 0} membres générés`);
          await fetchMembers();
        } else {
          setNotif('error', body?.detail || body?.error || 'Erreur');
        }
      } catch (err) {
        setNotif('error', err.message);
      } finally {
        Shared.btnLoading(btn, false);
      }
    });

    // Enter key shortcuts
    document.getElementById('mName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('btnCreate').click();
    });

    document.getElementById('groupName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('btnCreateGroup').click();
    });

    // ==========================================
    // EVENT DELEGATION (replaces inline onclick)
    // ==========================================

    document.addEventListener('click', function(e) {
      var btn = e.target.closest('[data-action]');
      if (!btn) return;
      var action = btn.dataset.action;
      var id = btn.dataset.id;

      switch (action) {
        case 'edit-group':
          window.editGroup(id);
          break;
        case 'delete-group':
          window.deleteGroup(id);
          break;
        case 'filter-group':
          window.filterByGroup(btn.dataset.groupId || null);
          break;
        case 'open-detail':
          // Ignore if the click was on an action button inside the card
          if (e.target.closest('[data-action="edit-member"]') || e.target.closest('[data-action="delete-member"]')) return;
          window.openMemberDetail(id);
          break;
        case 'edit-member':
          e.stopPropagation();
          window.editMember(id);
          if (memberDetailDialog.open) memberDetailDialog.close();
          break;
        case 'delete-member':
          e.stopPropagation();
          window.deleteMember(id);
          break;
        case 'toggle-active':
          window.toggleActive(id, btn.dataset.active === 'true');
          if (memberDetailDialog.open) memberDetailDialog.close();
          break;
      }
    });

    // ==========================================
    // INIT
    // ==========================================

    fetchGroups();
    fetchMembers();
  })();
  </script>
</body>
</html>
