<!doctype html>
<html lang="fr" data-page-role="operator">
<head>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#4f46e5" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#1e293b" media="(prefers-color-scheme: dark)">
  <meta name="description" content="Gestion des membres - AG-VOTE">
  <title>Membres — AG-VOTE</title>
  <script>!function(){var t=localStorage.getItem('ag-vote-theme');if(!t&&matchMedia('(prefers-color-scheme:dark)').matches)t='dark';if(t)document.documentElement.setAttribute('data-theme',t)}()</script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap">
  <link rel="stylesheet" href="/assets/css/app.css">
  <link rel="stylesheet" href="/assets/css/members.css">
</head>
<body>
  <!-- Skip links -->
  <a href="#membersList" class="skip-link">Aller à la liste des membres</a>
  <a href="#main-nav" class="skip-link">Aller à la navigation</a>

  <div class="app-shell">
    <aside class="app-sidebar" data-include-sidebar data-page="members"></aside>

    <!-- Header -->
    <header class="app-header">
      <div class="flex items-center gap-4">
        <div>
          <h1 class="text-xl font-bold">Membres</h1>
          <p class="text-sm text-secondary">Gestion des participants et pondération</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <a class="btn btn-secondary btn-sm" href="/api/v1/export_members_csv.php" target="_blank">
          <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-download"></use></svg>
          Exporter CSV
        </a>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="context" title="Séance en cours">
          <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-menu"></use></svg>
        </button>
      </div>
    </header>

    <main class="app-main members-main">
      <!-- Stats bar -->
      <div class="stats-bar">
        <div class="stat-item total">
          <div class="stat-value" id="kpiTotal">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-item active">
          <div class="stat-value" id="kpiActive">0</div>
          <div class="stat-label">Actifs</div>
        </div>
        <div class="stat-item inactive">
          <div class="stat-value" id="kpiInactive">0</div>
          <div class="stat-label">Inactifs</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="kpiPower">0</div>
          <div class="stat-label">Voix totales</div>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="kpiAvgPower">—</span>
          <span class="stat-label">Pouvoir moyen</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="kpiEmailCoverage">—</span>
          <span class="stat-label">Couv. email</span>
        </div>
      </div>

      <!-- Onboarding strip: guides user through member setup -->
      <div class="members-onboarding" id="membersOnboarding" hidden>
        <div class="onboarding-steps" id="onboardingSteps">
          <span class="onboarding-step pending" id="onbStepMembers" data-scroll-to="create-form">
            <span class="onboarding-step-num">1</span>
            Ajouter des membres
          </span>
          <span class="onboarding-arrow">›</span>
          <span class="onboarding-step pending" id="onbStepWeights">
            <span class="onboarding-step-num">2</span>
            Vérifier les pondérations
          </span>
          <span class="onboarding-arrow">›</span>
          <span class="onboarding-step pending" id="onbStepGroups" data-scroll-to="groups-panel">
            <span class="onboarding-step-num">3</span>
            Organiser en groupes
            <span class="onboarding-optional">optionnel</span>
          </span>
          <span class="onboarding-arrow">›</span>
          <span class="onboarding-step pending" id="onbStepMeeting">
            <span class="onboarding-step-num">4</span>
            Préparer une séance
          </span>
        </div>
      </div>

      <div id="notif_box" class="alert hidden mb-4" style="margin: 1rem 1.5rem 0;"></div>

      <!-- Management panels (collapsible, above the two-column layout) -->
      <div class="members-management">
        <!-- Create member card -->
        <div class="create-card" id="create-form">
          <h3>
            <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-user-plus"></use></svg>
            Ajouter un membre
          </h3>
          <div class="create-form">
            <div class="form-group">
              <label for="mName">Nom complet *</label>
              <input class="form-input" type="text" id="mName" placeholder="Jean Dupont" required>
            </div>
            <div class="form-group">
              <label for="mEmail">Email</label>
              <input class="form-input" type="email" id="mEmail" placeholder="jean@exemple.com">
            </div>
            <div class="form-group">
              <label for="mPower">
                Nombre de voix
                <ag-popover title="Nombre de voix" content="Nombre de voix que ce membre représente. La valeur par défaut est 1. Pour une pondération, utilisez un nombre supérieur (ex: 2 = 2 voix). Affecte le calcul du quorum et les résultats des votes." position="top"></ag-popover>
              </label>
              <input class="form-input" type="number" id="mPower" value="1" min="0" step="1">
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <label class="flex items-center gap-2">
                <input type="checkbox" id="mActive" checked>
                <span>Actif</span>
              </label>
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <button class="btn btn-primary" id="btnCreate">Ajouter</button>
            </div>
          </div>
        </div>

        <!-- Management tabs -->
        <div class="mgmt-panels-row">
          <div class="mgmt-tabs" role="tablist" aria-label="Gestion des membres">
            <button class="mgmt-tab active" role="tab" aria-selected="true" aria-controls="groupsPanel" data-mgmt-tab="groups">
              <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-users"></use></svg>
              Groupes
            </button>
            <button class="mgmt-tab" role="tab" aria-selected="false" aria-controls="importPanel" data-mgmt-tab="import">
              <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-upload"></use></svg>
              Importation CSV
            </button>
          </div>

          <!-- Groups tab panel -->
          <div class="mgmt-tab-panel" id="groupsPanel" data-scroll-target="groups-panel" role="tabpanel">
            <p class="text-sm text-muted mb-4">
              Organisez vos membres par catégories, collèges électoraux, départements, etc.
              <ag-popover title="Groupes de membres" content="Catégorisez vos membres par collèges électoraux, départements, ou tout autre critère. Les groupes facilitent le filtrage et permettent d'obtenir des statistiques par catégorie." position="right" trigger="click"></ag-popover>
            </p>
            <div class="create-group-form">
              <div class="form-group">
                <label for="groupName">Nom du groupe</label>
                <input class="form-input" type="text" id="groupName" placeholder="Ex: Collège A, Cadres...">
              </div>
              <div class="form-group form-group-color">
                <label for="groupColor">Couleur</label>
                <input type="color" id="groupColor" value="#6366f1">
              </div>
              <button class="btn btn-primary" id="btnCreateGroup">Créer groupe</button>
            </div>
            <div class="groups-grid" id="groupsList">
              <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
            </div>
          </div>

          <!-- Import tab panel -->
          <div class="mgmt-tab-panel" id="importPanel" role="tabpanel" style="display: none;">
            <div class="import-card-desc">
              Colonnes : <code>nom</code>, <code>email</code>, <code>ponderation</code>, <code>actif</code>, <code>groupes</code> (séparés par <code>|</code>). Séparateur <code>;</code> ou <code>,</code> auto-détecté.
              <ag-popover title="Format du fichier CSV" content="Exemple : Jean Dupont;jean@exemple.com;1;oui;Collège A|Cadres. Les groupes non existants seront créés automatiquement. Colonnes alternatives acceptées : name, full_name, voting_power, is_active, groups, college, categorie…" position="right" trigger="click"></ag-popover>
            </div>
            <div class="import-template-link flex gap-3 flex-wrap">
              <a href="/assets/modele_import_membres.csv" download class="btn btn-ghost btn-sm">
                <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-download"></use></svg>
                Modèle vierge CSV
              </a>
              <a href="/assets/demo_membres_ag.csv" download class="btn btn-ghost btn-sm">
                <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-download"></use></svg>
                Exemple avec 25 membres (démo)
              </a>
            </div>
            <div class="upload-zone" id="uploadZone">
              <input type="file" id="csvFile" accept=".csv,text/csv" style="display: none;" aria-label="Importer un fichier CSV">
              <div class="upload-zone-icon">
                <svg class="icon icon-xl" aria-hidden="true"><use href="/assets/icons.svg#icon-upload"></use></svg>
              </div>
              <div class="upload-zone-text">Glisser un fichier CSV ici</div>
              <div class="upload-zone-hint">ou cliquer pour sélectionner</div>
            </div>
            <div class="flex gap-2 mt-4">
              <button class="btn btn-primary" id="btnImport" disabled>Importer</button>
              <button class="btn btn-secondary" id="btnSeed">Générer fictifs</button>
              <span class="text-sm text-muted file-name-text" id="fileName">Aucun fichier sélectionné</span>
            </div>
            <div id="importOut" class="import-result" style="display: none;"></div>
          </div>
        </div>
      </div>

      <!-- Two-column layout: filters sidebar + results grid -->
      <div class="members-layout">

        <!-- LEFT: Search & Filters panel -->
        <aside class="members-filters-panel" aria-label="Recherche et filtres">
          <div class="filters-panel-header">
            <h2>Recherche</h2>
            <span class="filters-hint" id="activeFiltersHint">0 filtre</span>
          </div>
          <div class="filters-panel-body">
            <!-- Search -->
            <div class="field">
              <label for="searchInput">Nom, email…</label>
              <div class="search-input-wrap">
                <svg class="icon search-input-icon" aria-hidden="true"><use href="/assets/icons.svg#icon-search"></use></svg>
                <input class="form-input search-input-field" type="search" id="searchInput" placeholder="Rechercher un membre...">
              </div>
            </div>

            <!-- Status filter -->
            <div class="field">
              <label>Statut</label>
              <div class="filter-chips" role="group" aria-label="Filtrer par statut">
                <button class="filter-chip active" data-filter="all">Tous</button>
                <button class="filter-chip" data-filter="active">Actifs</button>
                <button class="filter-chip" data-filter="inactive">Inactifs</button>
              </div>
            </div>

            <!-- Group filters -->
            <div class="field" id="groupFiltersField" style="display: none;">
              <label>Groupes</label>
              <div class="filter-chips filter-chips-col" id="groupFilters" role="group" aria-label="Filtrer par groupe">
                <!-- Populated by JavaScript -->
              </div>
            </div>

            <!-- Sort -->
            <div class="field">
              <label for="sortSelect">Trier par</label>
              <select class="form-input" id="sortSelect">
                <option value="nameAsc">Nom (A → Z)</option>
                <option value="nameDesc">Nom (Z → A)</option>
                <option value="powerDesc">Nombre de voix (décroissant)</option>
                <option value="powerAsc">Nombre de voix (croissant)</option>
              </select>
            </div>
          </div>
        </aside>

        <!-- RIGHT: Results -->
        <section class="members-results" aria-label="Résultats">
          <div class="results-meta">
            <div class="results-meta-left">
              <span class="results-count" id="membersCount">0 membre</span>
              <span class="results-subtitle" id="resultsSubtitle">Affichage de l'ensemble des membres</span>
            </div>
          </div>
          <div class="members-grid" id="membersList">
            <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
            <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
            <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
            <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
          </div>
          <nav class="pagination" id="pagination" aria-label="Pagination des membres">
            <button class="pagination-btn" id="paginPrev" type="button" disabled aria-label="Page précédente">
              <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-chevron-left"></use></svg>
            </button>
            <span class="pagination-info" id="paginInfo">Page 1 / 1</span>
            <button class="pagination-btn" id="paginNext" type="button" disabled aria-label="Page suivante">
              <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-chevron-right"></use></svg>
            </button>
            <select class="form-input pagination-size" id="paginSize" aria-label="Membres par page">
              <option value="12">12 / page</option>
              <option value="24">24 / page</option>
              <option value="48">48 / page</option>
              <option value="96">96 / page</option>
            </select>
          </nav>
        </section>

      </div>
    </main>
  </div>

  <!-- Member detail dialog -->
  <dialog id="memberDetailDialog" class="member-detail-dialog" aria-labelledby="memberDetailTitle">
    <div class="dialog-header">
      <h3 id="memberDetailTitle">Fiche membre</h3>
      <button class="btn btn-ghost btn-icon btn-sm" id="closeMemberDetail" type="button" aria-label="Fermer">
        <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-x"></use></svg>
      </button>
    </div>
    <div class="dialog-body" id="memberDetailBody"></div>
  </dialog>

  <!-- Drawer -->
  <div class="drawer-backdrop" data-drawer-close></div>
  <aside class="drawer" id="drawer" role="dialog" aria-modal="true" aria-label="Panneau latéral">
    <div class="drawer-header">
      <div id="drawerTitle" class="font-semibold">Menu</div>
      <button class="btn btn-ghost btn-icon btn-sm" type="button" data-drawer-close aria-label="Fermer le panneau">✕</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
  </aside>

  <!-- Scripts -->
  <script type="module" src="/assets/js/components/index.js"></script>
  <script src="/assets/js/core/utils.js"></script>
  <script src="/assets/js/core/shared.js"></script>
  <script src="/assets/js/core/shell.js"></script>
  <script src="/assets/js/services/meeting-context.js"></script>

  <script src="/assets/js/pages/members.js"></script>
</body>
</html>
