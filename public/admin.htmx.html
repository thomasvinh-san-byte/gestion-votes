<!doctype html>
<html lang="fr">
<head>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Administration â€” AG-VOTE">
  <title>Administration â€” AG-VOTE</title>
  <link rel="stylesheet" href="/assets/css/app.css">
  <style>
    /* Tabs */
    .admin-tabs { display: flex; gap: 0; border-bottom: 2px solid var(--color-border); margin-bottom: var(--space-6); }
    .admin-tab {
      padding: var(--space-3) var(--space-5);
      font-weight: var(--font-semibold);
      font-size: var(--text-sm);
      color: var(--color-text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      background: none;
      border-top: none; border-left: none; border-right: none;
      transition: all 0.15s;
    }
    .admin-tab:hover { color: var(--color-text); }
    .admin-tab.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
    .admin-panel { display: none; }
    .admin-panel.active { display: block; }

    /* Users table */
    .users-table { width: 100%; border-collapse: collapse; font-size: var(--text-sm); }
    .users-table th { text-align: left; padding: var(--space-2) var(--space-3); border-bottom: 2px solid var(--color-border); font-weight: var(--font-semibold); color: var(--color-text-secondary); font-size: var(--text-xs); text-transform: uppercase; letter-spacing: 0.05em; }
    .users-table td { padding: var(--space-2) var(--space-3); border-bottom: 1px solid var(--color-border-subtle); }
    .users-table tr:hover td { background: var(--color-bg-subtle); }

    /* Role badge */
    .role-badge { display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: var(--text-xs); font-weight: var(--font-semibold); }
    .role-badge.admin { background: #fef2f2; color: #dc2626; }
    .role-badge.operator { background: #eff6ff; color: #2563eb; }
    .role-badge.auditor { background: #fefce8; color: #ca8a04; }
    .role-badge.viewer { background: #f0fdf4; color: #16a34a; }
    .role-badge.president { background: #faf5ff; color: #9333ea; }
    .role-badge.assessor { background: #fff7ed; color: #ea580c; }
    .role-badge.voter { background: #ecfeff; color: #0891b2; }

    /* Permission matrix */
    .perm-matrix { width: 100%; border-collapse: collapse; font-size: var(--text-xs); }
    .perm-matrix th, .perm-matrix td { padding: 4px 8px; border: 1px solid var(--color-border-subtle); text-align: center; }
    .perm-matrix th { background: var(--color-bg-subtle); font-weight: var(--font-semibold); }
    .perm-matrix td:first-child { text-align: left; font-family: var(--font-mono); font-weight: 500; }
    .perm-check { color: #16a34a; font-weight: bold; }
    .perm-none { color: var(--color-border); }

    /* State machine */
    .state-flow { display: flex; align-items: center; gap: var(--space-2); flex-wrap: wrap; padding: var(--space-4) 0; }
    .state-node { padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); font-size: var(--text-sm); font-weight: var(--font-semibold); background: var(--color-bg-subtle); border: 1px solid var(--color-border); }
    .state-arrow { color: var(--color-text-muted); font-size: var(--text-lg); }

    /* System stat */
    .system-stat { display: flex; align-items: center; justify-content: space-between; padding: var(--space-3); border-bottom: 1px solid var(--color-border-subtle); }
    .system-stat:last-child { border-bottom: none; }
    .system-stat-label { font-size: var(--text-sm); color: var(--color-text-secondary); }
    .system-stat-value { font-weight: var(--font-semibold); font-family: var(--font-mono); }

    /* Inline form */
    .inline-form { display: flex; gap: var(--space-2); align-items: flex-end; flex-wrap: wrap; }
    .inline-form .form-group { flex: 1; min-width: 140px; }
    .inline-form .form-label { font-size: var(--text-xs); margin-bottom: 2px; }
    .inline-form .form-input { font-size: var(--text-sm); padding: var(--space-2); }

    .meeting-role-tag { display: inline-flex; align-items: center; gap: 4px; padding: 1px 6px; border-radius: 4px; font-size: 10px; background: var(--color-bg-subtle); border: 1px solid var(--color-border-subtle); }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Sidebar -->
    <aside class="app-sidebar">
      <div class="p-4 border-b">
        <a href="/" class="brand"><span class="brand-logo">AG-VOTE</span></a>
      </div>
      <nav class="nav">
        <a class="nav-item" href="/meetings.htmx.html"><span class="nav-item-icon">ğŸ›ï¸</span><span>Tableau de bord</span></a>
        <a class="nav-item" href="/operator.htmx.html"><span class="nav-item-icon">ğŸ—‚ï¸</span><span>Fiche sÃ©ance</span></a>
        <a class="nav-item" href="/members.htmx.html"><span class="nav-item-icon">ğŸ‘¥</span><span>Membres</span></a>
        <a class="nav-item" href="/trust.htmx.html"><span class="nav-item-icon">ğŸ›¡ï¸</span><span>ContrÃ´le</span></a>
        <a class="nav-item" href="/archives.htmx.html"><span class="nav-item-icon">ğŸ“š</span><span>Archives</span></a>
        <div class="border-t mt-4 pt-4">
          <a class="nav-item active" href="/admin.htmx.html"><span class="nav-item-icon">âš™ï¸</span><span>Administration</span></a>
        </div>
      </nav>
    </aside>

    <!-- Header -->
    <header class="app-header">
      <div class="flex items-center gap-4">
        <div>
          <h1 class="text-xl font-bold">Administration</h1>
          <p class="text-sm text-secondary">Utilisateurs, rÃ´les, politiques, systÃ¨me</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn btn-secondary btn-sm" id="btnRefresh">Actualiser</button>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="guide" title="Guide">?</button>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="menu" title="Menu">â˜°</button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
      <div class="container">
        <div id="notif_box" class="hidden mb-4"></div>

        <!-- Tabs -->
        <div class="admin-tabs">
          <button class="admin-tab active" data-tab="users">Utilisateurs</button>
          <button class="admin-tab" data-tab="roles">Permissions</button>
          <button class="admin-tab" data-tab="states">Machine Ã  Ã©tats</button>
          <button class="admin-tab" data-tab="system">SystÃ¨me</button>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- TAB 1 : UTILISATEURS                      -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="admin-panel active" id="panel-users">
          <!-- Create user form -->
          <div class="card mb-4">
            <div class="card-header"><h3 class="card-title">Ajouter un utilisateur</h3></div>
            <div class="card-body">
              <div class="inline-form" id="createUserForm">
                <div class="form-group">
                  <label class="form-label">Nom</label>
                  <input class="form-input" type="text" id="newName" placeholder="Jean Dupont">
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input class="form-input" type="email" id="newEmail" placeholder="jean@example.com">
                </div>
                <div class="form-group" style="min-width:120px">
                  <label class="form-label">RÃ´le systÃ¨me</label>
                  <select class="form-input" id="newRole">
                    <option value="viewer">Observateur</option>
                    <option value="operator">OpÃ©rateur</option>
                    <option value="auditor">Auditeur</option>
                    <option value="admin">Administrateur</option>
                  </select>
                </div>
                <button class="btn btn-primary" id="btnCreateUser" style="margin-bottom:1px">Ajouter</button>
              </div>
            </div>
          </div>

          <!-- Filter -->
          <div class="flex items-center gap-3 mb-4">
            <label class="text-sm font-semibold">Filtrer par rÃ´le :</label>
            <select class="form-input" id="filterRole" style="width:auto;font-size:var(--text-sm);padding:4px 8px;">
              <option value="">Tous</option>
              <option value="admin">Administrateur</option>
              <option value="operator">OpÃ©rateur</option>
              <option value="auditor">Auditeur</option>
              <option value="viewer">Observateur</option>
            </select>
          </div>

          <!-- Users table -->
          <div class="card">
            <div class="card-body p-0">
              <table class="users-table">
                <thead>
                  <tr>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>RÃ´le systÃ¨me</th>
                    <th>RÃ´les sÃ©ance</th>
                    <th>Actif</th>
                    <th>ClÃ© API</th>
                    <th style="width:180px">Actions</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <tr><td colspan="7" class="text-center p-4 text-muted">Chargement...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- TAB 2 : PERMISSIONS                       -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="admin-panel" id="panel-roles">
          <div class="card mb-4">
            <div class="card-header">
              <h3 class="card-title">Matrice des permissions</h3>
              <p class="card-description">RÃ´les systÃ¨me (S) et rÃ´les de sÃ©ance (M)</p>
            </div>
            <div class="card-body" style="overflow-x:auto">
              <div id="permMatrix">Chargement...</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="card">
              <div class="card-header"><h3 class="card-title">RÃ´les systÃ¨me</h3><p class="card-description">Permanents, liÃ©s au compte</p></div>
              <div class="card-body" id="systemRolesInfo">Chargement...</div>
            </div>
            <div class="card">
              <div class="card-header"><h3 class="card-title">RÃ´les de sÃ©ance</h3><p class="card-description">Temporaires, attribuÃ©s par sÃ©ance</p></div>
              <div class="card-body" id="meetingRolesInfo">Chargement...</div>
            </div>
          </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- TAB 3 : MACHINE Ã€ Ã‰TATS                   -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="admin-panel" id="panel-states">
          <div class="card mb-4">
            <div class="card-header">
              <h3 class="card-title">Cycle de vie d'une sÃ©ance</h3>
              <p class="card-description">Chaque transition requiert un rÃ´le spÃ©cifique</p>
            </div>
            <div class="card-body">
              <div class="state-flow" id="stateFlow">Chargement...</div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3 class="card-title">Transitions autorisÃ©es</h3></div>
            <div class="card-body p-0">
              <table class="users-table" id="transitionsTable">
                <thead><tr><th>De</th><th>Vers</th><th>RÃ´le requis</th><th>Description</th></tr></thead>
                <tbody id="transitionsBody"><tr><td colspan="4" class="text-center p-4 text-muted">Chargement...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <!-- TAB 4 : SYSTÃˆME                           -->
        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="admin-panel" id="panel-system">
          <div class="card mb-4">
            <div class="card-header">
              <div class="flex items-center justify-between">
                <div><h3 class="card-title">Statut systÃ¨me</h3><p class="card-description">Connexions, latence, compteurs</p></div>
                <span class="badge badge-success badge-dot" id="systemStatus">En ligne</span>
              </div>
            </div>
            <div class="card-body p-0" id="systemStats">
              <div class="system-stat"><span class="system-stat-label">Base de donnÃ©es</span><span class="system-stat-value" id="statDbStatus">Chargement...</span></div>
              <div class="system-stat"><span class="system-stat-label">Latence DB</span><span class="system-stat-value" id="statDbLatency">â€”</span></div>
              <div class="system-stat"><span class="system-stat-label">Connexions actives</span><span class="system-stat-value" id="statDbConnections">â€”</span></div>
              <div class="system-stat"><span class="system-stat-label">SÃ©ances en cours</span><span class="system-stat-value" id="statActiveMeetings">â€”</span></div>
              <div class="system-stat"><span class="system-stat-label">Total sÃ©ances</span><span class="system-stat-value" id="statTotalMeetings">â€”</span></div>
              <div class="system-stat"><span class="system-stat-label">Membres actifs</span><span class="system-stat-value" id="statTotalMembers">â€”</span></div>
              <div class="system-stat"><span class="system-stat-label">Version PHP</span><span class="system-stat-value" id="statPhpVersion">â€”</span></div>
              <div class="system-stat"><span class="system-stat-label">MÃ©moire</span><span class="system-stat-value" id="statMemory">â€”</span></div>
            </div>
          </div>
          <!-- Policies -->
          <div class="grid grid-cols-2 gap-6 mb-6">
            <div class="card">
              <div class="card-header"><h3 class="card-title">Politiques de quorum</h3></div>
              <div class="card-body"><div id="quorumList" class="text-center p-4 text-muted">Chargement...</div></div>
            </div>
            <div class="card">
              <div class="card-header"><h3 class="card-title">Politiques de vote</h3></div>
              <div class="card-body"><div id="voteList" class="text-center p-4 text-muted">Chargement...</div></div>
            </div>
          </div>
          <!-- Danger Zone -->
          <div class="card" style="border-color: var(--color-danger);">
            <div class="card-header" style="background: var(--color-danger-subtle);"><h3 class="card-title text-danger">Zone dangereuse</h3></div>
            <div class="card-body">
              <div class="flex items-center justify-between gap-4 p-4 bg-surface rounded-lg border">
                <div><div class="font-semibold">RÃ©initialiser les donnÃ©es de dÃ©mo</div><div class="text-sm text-muted">Supprime toutes les sÃ©ances et recharge les donnÃ©es de test</div></div>
                <button class="btn btn-danger" id="btnResetDemo">RÃ©initialiser</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Drawer -->
  <div class="drawer-backdrop" data-drawer-close></div>
  <aside class="drawer" id="drawer">
    <div class="drawer-header">
      <div id="drawerTitle" class="font-semibold">Menu</div>
      <button class="btn btn-ghost btn-icon btn-sm" type="button" data-drawer-close title="Fermer">âœ•</button>
    </div>
    <div id="drawerBody" class="drawer-body"></div>
  </aside>

  <!-- Scripts -->
  <script src="/assets/js/utils.js"></script>
  <script src="/assets/js/shell.js"></script>
  <script>
  (function() {
    'use strict';

    var roleLabelsSystem = {admin:'Administrateur',operator:'OpÃ©rateur',auditor:'Auditeur',viewer:'Observateur'};
    var roleLabelsSeance = {president:'PrÃ©sident',assessor:'Assesseur',voter:'Ã‰lecteur'};
    var allRoleLabels = Object.assign({}, roleLabelsSystem, roleLabelsSeance);

    // â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll('.admin-tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.admin-tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelectorAll('.admin-panel').forEach(function(p) { p.classList.remove('active'); });
        tab.classList.add('active');
        document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
      });
    });

    // â”€â”€â”€ Users â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var _users = [];

    async function loadUsers() {
      try {
        var filter = document.getElementById('filterRole').value;
        var url = '/api/v1/admin_users.php' + (filter ? '?role=' + filter : '');
        var r = await api(url);
        if (r.body && r.body.ok && r.body.data) {
          _users = r.body.data.items || [];
          renderUsersTable(_users);
        }
      } catch (e) { console.error('loadUsers', e); }
    }

    function renderUsersTable(users) {
      var tbody = document.getElementById('usersTableBody');
      if (!users.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-muted">Aucun utilisateur</td></tr>';
        return;
      }
      tbody.innerHTML = users.map(function(u) {
        var meetingTags = (u.meeting_roles || []).map(function(mr) {
          return '<span class="meeting-role-tag"><span class="role-badge ' + escapeHtml(mr.role) + '">' +
            escapeHtml(allRoleLabels[mr.role] || mr.role) + '</span> ' +
            escapeHtml(mr.meeting_title || '') + '</span>';
        }).join(' ');

        return '<tr data-user-id="' + u.id + '">' +
          '<td><strong>' + escapeHtml(u.name || '') + '</strong></td>' +
          '<td>' + escapeHtml(u.email || '') + '</td>' +
          '<td><span class="role-badge ' + escapeHtml(u.role) + '">' + escapeHtml(roleLabelsSystem[u.role] || u.role) + '</span></td>' +
          '<td>' + (meetingTags || '<span class="text-muted">â€”</span>') + '</td>' +
          '<td>' + (u.is_active ? '<span class="text-success">Oui</span>' : '<span class="text-danger">Non</span>') + '</td>' +
          '<td>' + (u.has_api_key ? '<span class="text-success">Oui</span>' : '<span class="text-muted">Non</span>') + '</td>' +
          '<td class="flex gap-1 flex-wrap">' +
            '<button class="btn btn-ghost btn-xs btn-edit-user" data-id="' + u.id + '">Modifier</button>' +
            '<button class="btn btn-ghost btn-xs btn-toggle-user" data-id="' + u.id + '" data-active="' + (u.is_active ? '1' : '0') + '">' + (u.is_active ? 'DÃ©sactiver' : 'Activer') + '</button>' +
            '<button class="btn btn-ghost btn-xs btn-key-user" data-id="' + u.id + '">ClÃ© API</button>' +
          '</td></tr>';
      }).join('');
    }

    document.getElementById('filterRole').addEventListener('change', loadUsers);

    // Create user
    document.getElementById('btnCreateUser').addEventListener('click', async function() {
      var name = document.getElementById('newName').value.trim();
      var email = document.getElementById('newEmail').value.trim();
      var role = document.getElementById('newRole').value;
      if (!name || !email) { setNotif('error', 'Nom et email requis'); return; }
      try {
        var r = await api('/api/v1/admin_users.php', {action:'create', name:name, email:email, role:role});
        if (r.body && r.body.ok) {
          setNotif('success', 'Utilisateur crÃ©Ã©. ClÃ© API : ' + (r.body.data.api_key || ''));
          document.getElementById('newName').value = '';
          document.getElementById('newEmail').value = '';
          loadUsers();
        } else {
          setNotif('error', r.body.error || 'Erreur');
        }
      } catch (e) { setNotif('error', e.message); }
    });

    // Delegated clicks on users table
    document.getElementById('usersTableBody').addEventListener('click', async function(e) {
      var btn;

      // Toggle active
      btn = e.target.closest('.btn-toggle-user');
      if (btn) {
        var active = btn.dataset.active === '1' ? 0 : 1;
        var label = active ? 'activer' : 'dÃ©sactiver';
        if (!confirm('Voulez-vous ' + label + ' cet utilisateur ?')) return;
        try {
          await api('/api/v1/admin_users.php', {action:'toggle', user_id:btn.dataset.id, is_active:active});
          loadUsers();
        } catch(err) { setNotif('error', err.message); }
        return;
      }

      // Rotate API key
      btn = e.target.closest('.btn-key-user');
      if (btn) {
        if (!confirm('GÃ©nÃ©rer une nouvelle clÃ© API ? L\'ancienne sera invalidÃ©e.')) return;
        try {
          var r = await api('/api/v1/admin_users.php', {action:'rotate_key', user_id:btn.dataset.id});
          if (r.body && r.body.ok) {
            setNotif('success', 'Nouvelle clÃ© API : ' + r.body.data.api_key);
            loadUsers();
          }
        } catch(err) { setNotif('error', err.message); }
        return;
      }

      // Edit user
      btn = e.target.closest('.btn-edit-user');
      if (btn) {
        var user = _users.find(function(u) { return u.id === btn.dataset.id; });
        if (!user) return;
        var newName = prompt('Nom :', user.name);
        if (newName === null) return;
        var newEmail = prompt('Email :', user.email);
        if (newEmail === null) return;
        var roleOpts = Object.keys(roleLabelsSystem);
        var newRole = prompt('RÃ´le systÃ¨me (' + roleOpts.join(', ') + ') :', user.role);
        if (newRole === null) return;
        try {
          var r = await api('/api/v1/admin_users.php', {action:'update', user_id:user.id, name:newName, email:newEmail, role:newRole});
          if (r.body && r.body.ok) { setNotif('success', 'Utilisateur modifiÃ©'); loadUsers(); }
          else { setNotif('error', r.body.error || 'Erreur'); }
        } catch(err) { setNotif('error', err.message); }
        return;
      }
    });

    // â”€â”€â”€ Roles / Permissions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadRoles() {
      try {
        var r = await api('/api/v1/admin_roles.php');
        if (!r.body || !r.body.ok) return;
        var d = r.body.data;

        // System roles info
        var sysInfo = Object.entries(d.system_roles || {}).map(function(e) {
          var cnt = (d.users_by_system_role || []).find(function(x) { return x.role === e[0]; });
          return '<div class="flex items-center justify-between py-2 border-b" style="border-color:var(--color-border-subtle)">' +
            '<span class="role-badge ' + e[0] + '">' + escapeHtml(e[1]) + '</span>' +
            '<span class="text-sm text-muted">' + ((cnt && cnt.count) || 0) + ' utilisateur(s)</span></div>';
        }).join('');
        document.getElementById('systemRolesInfo').innerHTML = sysInfo;

        // Meeting roles info
        var mtgInfo = Object.entries(d.meeting_roles || {}).map(function(e) {
          var cnt = (d.meeting_role_counts || []).find(function(x) { return x.role === e[0]; });
          return '<div class="flex items-center justify-between py-2 border-b" style="border-color:var(--color-border-subtle)">' +
            '<span class="role-badge ' + e[0] + '">' + escapeHtml(e[1]) + '</span>' +
            '<span class="text-sm text-muted">' + ((cnt && cnt.users) || 0) + ' personne(s), ' + ((cnt && cnt.meetings) || 0) + ' sÃ©ance(s)</span></div>';
        }).join('');
        document.getElementById('meetingRolesInfo').innerHTML = mtgInfo;

        // Permission matrix
        var perms = d.permissions_by_role || {};
        var allPermsSet = {};
        var roleOrder = ['admin','operator','auditor','viewer','president','assessor','voter'];
        roleOrder.forEach(function(role) {
          (perms[role] || []).forEach(function(p) { allPermsSet[p.permission] = true; });
        });
        var allPerms = Object.keys(allPermsSet).sort();

        // Group by resource
        var groups = {};
        allPerms.forEach(function(p) {
          var parts = p.split(':');
          var g = parts[0];
          if (!groups[g]) groups[g] = [];
          groups[g].push(p);
        });

        var permsByRole = {};
        roleOrder.forEach(function(role) {
          permsByRole[role] = {};
          (perms[role] || []).forEach(function(p) { permsByRole[role][p.permission] = true; });
        });

        var html = '<table class="perm-matrix"><thead><tr><th>Permission</th>';
        roleOrder.forEach(function(role) {
          var isSys = !!roleLabelsSystem[role];
          html += '<th><span class="role-badge ' + role + '">' + escapeHtml(allRoleLabels[role] || role) + '</span><br><span class="text-xs text-muted">' + (isSys ? 'S' : 'M') + '</span></th>';
        });
        html += '</tr></thead><tbody>';

        Object.keys(groups).sort().forEach(function(g) {
          html += '<tr><td colspan="' + (roleOrder.length + 1) + '" style="background:var(--color-bg-subtle);font-weight:700;text-transform:uppercase;font-size:10px;letter-spacing:0.1em;padding:6px 8px">' + escapeHtml(g) + '</td></tr>';
          groups[g].forEach(function(perm) {
            html += '<tr><td>' + escapeHtml(perm) + '</td>';
            roleOrder.forEach(function(role) {
              html += '<td>' + (permsByRole[role][perm] ? '<span class="perm-check">&#10003;</span>' : '<span class="perm-none">-</span>') + '</td>';
            });
            html += '</tr>';
          });
        });
        html += '</tbody></table>';
        document.getElementById('permMatrix').innerHTML = html;

      } catch (e) { console.error('loadRoles', e); }
    }

    // â”€â”€â”€ State Machine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadStates() {
      try {
        var r = await api('/api/v1/admin_roles.php');
        if (!r.body || !r.body.ok) return;
        var d = r.body.data;
        var statuses = d.statuses || {};
        var transitions = d.state_transitions || [];

        // Flow diagram
        var flow = ['draft','scheduled','frozen','live','closed','validated','archived'];
        document.getElementById('stateFlow').innerHTML = flow.map(function(s, i) {
          var label = statuses[s] || s;
          return (i > 0 ? '<span class="state-arrow">&rarr;</span>' : '') +
            '<span class="state-node">' + escapeHtml(label) + '</span>';
        }).join('');

        // Transitions table
        document.getElementById('transitionsBody').innerHTML = transitions.map(function(t) {
          return '<tr>' +
            '<td><span class="state-node" style="font-size:12px;padding:2px 8px">' + escapeHtml(statuses[t.from_status] || t.from_status) + '</span></td>' +
            '<td><span class="state-node" style="font-size:12px;padding:2px 8px">' + escapeHtml(statuses[t.to_status] || t.to_status) + '</span></td>' +
            '<td><span class="role-badge ' + escapeHtml(t.required_role) + '">' + escapeHtml(allRoleLabels[t.required_role] || t.required_role) + '</span></td>' +
            '<td class="text-sm">' + escapeHtml(t.description || '') + '</td></tr>';
        }).join('');

      } catch (e) { console.error('loadStates', e); }
    }

    // â”€â”€â”€ System Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadSystemStatus() {
      try {
        var r = await api('/api/v1/admin_system_status.php');
        if (r.body && r.body.ok && r.body.data) {
          var s = r.body.data.system || r.body.data;
          document.getElementById('statDbStatus').textContent = 'ConnectÃ©e';
          document.getElementById('statDbStatus').className = 'system-stat-value text-success';
          document.getElementById('statDbLatency').textContent = s.db_latency_ms != null ? s.db_latency_ms + ' ms' : 'â€”';
          document.getElementById('statDbConnections').textContent = s.db_active_connections || 'â€”';
          document.getElementById('statActiveMeetings').textContent = s.active_meetings || 'â€”';
          document.getElementById('statTotalMeetings').textContent = s.count_meetings || 'â€”';
          document.getElementById('statTotalMembers').textContent = s.total_members || 'â€”';
          document.getElementById('statPhpVersion').textContent = s.php_version || 'â€”';
          document.getElementById('statMemory').textContent = s.memory_usage || 'â€”';
          document.getElementById('systemStatus').className = 'badge badge-success badge-dot';
          document.getElementById('systemStatus').textContent = 'En ligne';
        } else {
          document.getElementById('statDbStatus').textContent = 'Erreur';
          document.getElementById('statDbStatus').className = 'system-stat-value text-danger';
          document.getElementById('systemStatus').className = 'badge badge-danger';
          document.getElementById('systemStatus').textContent = 'Erreur';
        }
      } catch (e) {
        document.getElementById('statDbStatus').textContent = 'Hors ligne';
        document.getElementById('statDbStatus').className = 'system-stat-value text-danger';
        document.getElementById('systemStatus').className = 'badge badge-danger';
        document.getElementById('systemStatus').textContent = 'Erreur';
      }
    }

    async function loadQuorumPolicies() {
      try {
        var r = await api('/api/v1/quorum_policies.php');
        if (r.body && r.body.ok && r.body.data && Array.isArray(r.body.data.items)) {
          var items = r.body.data.items;
          var el = document.getElementById('quorumList');
          if (!items.length) { el.innerHTML = '<div class="text-center text-muted">Aucune politique</div>'; return; }
          el.innerHTML = items.map(function(p) {
            return '<div class="flex items-center justify-between py-2 border-b" style="border-color:var(--color-border-subtle)">' +
              '<div><div class="font-semibold text-sm">' + escapeHtml(p.name) + '</div>' +
              '<div class="text-xs text-muted">' + escapeHtml(p.description || p.mode || '') + ' â€” seuil ' + Math.round((p.threshold||0)*100) + '%</div></div></div>';
          }).join('');
        }
      } catch(e) {}
    }

    async function loadVotePolicies() {
      try {
        var r = await api('/api/v1/vote_policies.php');
        if (r.body && r.body.ok && r.body.data && Array.isArray(r.body.data.items)) {
          var items = r.body.data.items;
          var el = document.getElementById('voteList');
          if (!items.length) { el.innerHTML = '<div class="text-center text-muted">Aucune politique</div>'; return; }
          el.innerHTML = items.map(function(p) {
            return '<div class="flex items-center justify-between py-2 border-b" style="border-color:var(--color-border-subtle)">' +
              '<div><div class="font-semibold text-sm">' + escapeHtml(p.name) + '</div>' +
              '<div class="text-xs text-muted">' + escapeHtml(p.description || p.base || '') + ' â€” seuil ' + Math.round((p.threshold||0)*100) + '%</div></div></div>';
          }).join('');
        }
      } catch(e) {}
    }

    // Reset demo
    document.getElementById('btnResetDemo').addEventListener('click', async function() {
      if (!confirm('Cette action va supprimer TOUTES les donnÃ©es et rÃ©initialiser la dÃ©mo. Continuer ?')) return;
      try {
        var r = await api('/api/v1/admin_reset_demo.php', {});
        if (r.body && r.body.ok) { setNotif('success', 'DonnÃ©es de dÃ©mo rÃ©initialisÃ©es'); refreshAll(); }
        else { setNotif('error', r.body.error || 'Erreur'); }
      } catch(e) { setNotif('error', e.message); }
    });

    // â”€â”€â”€ Refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function refreshAll() {
      loadUsers();
      loadRoles();
      loadStates();
      loadSystemStatus();
      loadQuorumPolicies();
      loadVotePolicies();
    }

    document.getElementById('btnRefresh').addEventListener('click', refreshAll);

    // Guide drawer
    if (window.ShellDrawer && window.ShellDrawer.register) {
      window.ShellDrawer.register('guide', 'Guide', function(mid, body) {
        body.innerHTML =
          '<div style="display:flex;flex-direction:column;gap:16px;padding:4px 0;">' +
            '<div><div style="font-weight:600;margin-bottom:8px">ModÃ¨le de rÃ´les</div>' +
              '<div class="text-sm"><strong>RÃ´les systÃ¨me</strong> (permanents) :<br>' +
              'Admin, OpÃ©rateur, Auditeur, Observateur<br><br>' +
              '<strong>RÃ´les de sÃ©ance</strong> (par sÃ©ance) :<br>' +
              'PrÃ©sident, Assesseur, Ã‰lecteur<br><br>' +
              'Un opÃ©rateur peut Ãªtre prÃ©sident d\'une sÃ©ance et assesseur d\'une autre.</div></div>' +
            '<div><div style="font-weight:600;margin-bottom:8px">Machine Ã  Ã©tats</div>' +
              '<div class="text-sm">Brouillon &rarr; PlanifiÃ©e &rarr; VerrouillÃ©e &rarr; En cours &rarr; ClÃ´turÃ©e &rarr; ValidÃ©e &rarr; ArchivÃ©e<br><br>' +
              'Le prÃ©sident verrouille, ouvre, clÃ´ture et valide.<br>L\'admin archive et peut dÃ©geler.</div></div>' +
            '<div><div style="font-weight:600;margin-bottom:8px">Setup DB</div>' +
              '<pre class="text-xs" style="background:var(--color-bg-subtle,#f5f5f5);padding:8px;border-radius:6px;overflow-x:auto">sudo bash database/setup.sh</pre></div>' +
          '</div>';
      });
    }

    // Initial load
    refreshAll();
  })();
  </script>
</body>
</html>
