<!doctype html>
<html lang="fr">
<head>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Administration — AG-VOTE">
  <title>Administration — AG-VOTE</title>
  <link rel="stylesheet" href="/assets/css/app.css">
</head>
<body>
  <div class="app-shell">
    <!-- Sidebar (loaded from shared partial) -->
    <aside class="app-sidebar" data-include-sidebar data-page="admin"></aside>

    <!-- Header -->
    <header class="app-header">
      <div class="flex items-center gap-4">
        <div>
          <h1 class="text-xl font-bold">Administration</h1>
          <p class="text-sm text-secondary">Utilisateurs, rôles, politiques, système</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn btn-secondary btn-sm" id="btnRefresh">Actualiser</button>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="guide" title="Guide">?</button>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="menu" title="Menu">☰</button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
      <div class="container">
        <div id="notif_box" class="hidden mb-4"></div>

        <!-- Tabs -->
        <div class="admin-tabs" role="tablist" aria-label="Sections d'administration">
          <button class="admin-tab active" data-tab="users" role="tab" aria-selected="true" aria-controls="panel-users" id="tab-users">Utilisateurs</button>
          <button class="admin-tab" data-tab="roles" role="tab" aria-selected="false" aria-controls="panel-roles" id="tab-roles">Permissions</button>
          <button class="admin-tab" data-tab="states" role="tab" aria-selected="false" aria-controls="panel-states" id="tab-states">Machine à états</button>
          <button class="admin-tab" data-tab="system" role="tab" aria-selected="false" aria-controls="panel-system" id="tab-system">Système</button>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 1 : UTILISATEURS                      -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="admin-panel active" id="panel-users" role="tabpanel" aria-labelledby="tab-users">
          <!-- Create user form -->
          <div class="card mb-4">
            <div class="card-header"><h3 class="card-title">Ajouter un utilisateur</h3></div>
            <div class="card-body">
              <div class="inline-form" id="createUserForm">
                <div class="form-group">
                  <label class="form-label">Nom</label>
                  <input class="form-input" type="text" id="newName" placeholder="Jean Dupont">
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input class="form-input" type="email" id="newEmail" placeholder="jean@example.com">
                </div>
                <div class="form-group">
                  <label class="form-label">Rôle système</label>
                  <select class="form-input" id="newRole">
                    <option value="viewer">Observateur</option>
                    <option value="operator">Opérateur</option>
                    <option value="auditor">Auditeur</option>
                    <option value="admin">Administrateur</option>
                  </select>
                </div>
                <button class="btn btn-primary" id="btnCreateUser">Ajouter</button>
              </div>
            </div>
          </div>

          <!-- Filter -->
          <div class="flex items-center gap-3 mb-4">
            <label class="text-sm font-semibold">Filtrer par rôle :</label>
            <select class="form-input btn-sm" id="filterRole" style="width:auto">
              <option value="">Tous</option>
              <option value="admin">Administrateur</option>
              <option value="operator">Opérateur</option>
              <option value="auditor">Auditeur</option>
              <option value="viewer">Observateur</option>
            </select>
          </div>

          <!-- Users table -->
          <div class="card">
            <div class="card-body p-0">
              <table class="users-table">
                <thead>
                  <tr>
                    <th>Nom</th>
                    <th>Email</th>
                    <th>Rôle système</th>
                    <th>Rôles séance</th>
                    <th>Actif</th>
                    <th>Clé API</th>
                    <th style="width:180px">Actions</th>
                  </tr>
                </thead>
                <tbody id="usersTableBody">
                  <tr><td colspan="7" class="text-center p-4 text-muted">Chargement...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 2 : PERMISSIONS                       -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="admin-panel" id="panel-roles" role="tabpanel" aria-labelledby="tab-roles">
          <div class="card mb-4">
            <div class="card-header">
              <h3 class="card-title">Matrice des permissions</h3>
              <p class="card-description">Rôles système (S) et rôles de séance (M)</p>
            </div>
            <div class="card-body" style="overflow-x:auto">
              <div id="permMatrix">Chargement...</div>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="card">
              <div class="card-header"><h3 class="card-title">Rôles système</h3><p class="card-description">Permanents, liés au compte</p></div>
              <div class="card-body" id="systemRolesInfo">Chargement...</div>
            </div>
            <div class="card">
              <div class="card-header"><h3 class="card-title">Rôles de séance</h3><p class="card-description">Temporaires, attribués par séance</p></div>
              <div class="card-body" id="meetingRolesInfo">Chargement...</div>
            </div>
          </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 3 : MACHINE À ÉTATS                   -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="admin-panel" id="panel-states" role="tabpanel" aria-labelledby="tab-states">
          <div class="card mb-4">
            <div class="card-header">
              <h3 class="card-title">Cycle de vie d'une séance</h3>
              <p class="card-description">Chaque transition requiert un rôle spécifique</p>
            </div>
            <div class="card-body">
              <div class="state-flow" id="stateFlow">Chargement...</div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><h3 class="card-title">Transitions autorisées</h3></div>
            <div class="card-body p-0">
              <table class="users-table" id="transitionsTable">
                <thead><tr><th>De</th><th>Vers</th><th>Rôle requis</th><th>Description</th></tr></thead>
                <tbody id="transitionsBody"><tr><td colspan="4" class="text-center p-4 text-muted">Chargement...</td></tr></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 4 : SYSTÈME                           -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="admin-panel" id="panel-system" role="tabpanel" aria-labelledby="tab-system">
          <div class="card mb-4">
            <div class="card-header">
              <div class="flex items-center justify-between">
                <div><h3 class="card-title">Statut système</h3><p class="card-description">Connexions, latence, compteurs</p></div>
                <span class="badge badge-success badge-dot" id="systemStatus">En ligne</span>
              </div>
            </div>
            <div class="card-body p-0" id="systemStats">
              <div class="system-stat"><span class="system-stat-label">Base de données</span><span class="system-stat-value" id="statDbStatus">Chargement...</span></div>
              <div class="system-stat"><span class="system-stat-label">Latence DB</span><span class="system-stat-value" id="statDbLatency">—</span></div>
              <div class="system-stat"><span class="system-stat-label">Connexions actives</span><span class="system-stat-value" id="statDbConnections">—</span></div>
              <div class="system-stat"><span class="system-stat-label">Séances en cours</span><span class="system-stat-value" id="statActiveMeetings">—</span></div>
              <div class="system-stat"><span class="system-stat-label">Total séances</span><span class="system-stat-value" id="statTotalMeetings">—</span></div>
              <div class="system-stat"><span class="system-stat-label">Membres actifs</span><span class="system-stat-value" id="statTotalMembers">—</span></div>
              <div class="system-stat"><span class="system-stat-label">Version PHP</span><span class="system-stat-value" id="statPhpVersion">—</span></div>
              <div class="system-stat"><span class="system-stat-label">Mémoire</span><span class="system-stat-value" id="statMemory">—</span></div>
            </div>
          </div>
          <!-- Policies -->
          <div class="grid grid-cols-2 gap-6 mb-6">
            <div class="card">
              <div class="card-header"><h3 class="card-title">Politiques de quorum</h3></div>
              <div class="card-body"><div id="quorumList" class="text-center p-4 text-muted">Chargement...</div></div>
            </div>
            <div class="card">
              <div class="card-header"><h3 class="card-title">Politiques de vote</h3></div>
              <div class="card-body"><div id="voteList" class="text-center p-4 text-muted">Chargement...</div></div>
            </div>
          </div>
          <!-- Danger Zone -->
          <div class="card card-danger">
            <div class="card-header"><h3 class="card-title text-danger">Zone dangereuse</h3></div>
            <div class="card-body">
              <div class="flex items-center justify-between gap-4 p-4 bg-surface rounded-lg border">
                <div><div class="font-semibold">Réinitialiser les données de démo</div><div class="text-sm text-muted">Supprime toutes les séances et recharge les données de test</div></div>
                <button class="btn btn-danger" id="btnResetDemo">Réinitialiser</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Drawer -->
  <div class="drawer-backdrop" data-drawer-close></div>
  <aside class="drawer" id="drawer">
    <div class="drawer-header">
      <div id="drawerTitle" class="font-semibold">Menu</div>
      <button class="btn btn-ghost btn-icon btn-sm" type="button" data-drawer-close title="Fermer">✕</button>
    </div>
    <div id="drawerBody" class="drawer-body"></div>
  </aside>

  <!-- Scripts -->
  <script src="/assets/js/utils.js"></script>
  <script src="/assets/js/shared.js"></script>
  <script src="/assets/js/shell.js"></script>
  <script>
  (function() {
    'use strict';

    var roleLabelsSystem = Shared.ROLE_LABELS_SYSTEM;
    var roleLabelsSeance = Shared.ROLE_LABELS_MEETING;
    var allRoleLabels = Shared.ROLE_LABELS_ALL;

    // ─── Tabs (with ARIA support) ────────────────────────
    document.querySelectorAll('.admin-tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.admin-tab').forEach(function(t) {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });
        document.querySelectorAll('.admin-panel').forEach(function(p) { p.classList.remove('active'); });
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');
        document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
      });
    });

    // ─── Users ───────────────────────────────────────────
    var _users = [];

    async function loadUsers() {
      try {
        var filter = document.getElementById('filterRole').value;
        var url = '/api/v1/admin_users.php' + (filter ? '?role=' + filter : '');
        var r = await api(url);
        if (r.body && r.body.ok && r.body.data) {
          _users = r.body.data.items || [];
          renderUsersTable(_users);
        }
      } catch (e) { console.error('loadUsers', e); }
    }

    function renderUsersTable(users) {
      var tbody = document.getElementById('usersTableBody');
      if (!users.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-muted">Aucun utilisateur</td></tr>';
        return;
      }
      tbody.innerHTML = users.map(function(u) {
        var meetingTags = (u.meeting_roles || []).map(function(mr) {
          return '<span class="meeting-role-tag"><span class="role-badge ' + escapeHtml(mr.role) + '">' +
            escapeHtml(allRoleLabels[mr.role] || mr.role) + '</span> ' +
            escapeHtml(mr.meeting_title || '') + '</span>';
        }).join(' ');

        return '<tr data-user-id="' + u.id + '">' +
          '<td><strong>' + escapeHtml(u.name || '') + '</strong></td>' +
          '<td>' + escapeHtml(u.email || '') + '</td>' +
          '<td><span class="role-badge ' + escapeHtml(u.role) + '">' + escapeHtml(roleLabelsSystem[u.role] || u.role) + '</span></td>' +
          '<td>' + (meetingTags || '<span class="text-muted">—</span>') + '</td>' +
          '<td>' + (u.is_active ? '<span class="text-success">Oui</span>' : '<span class="text-danger">Non</span>') + '</td>' +
          '<td>' + (u.has_api_key ? '<span class="text-success">Oui</span>' : '<span class="text-muted">Non</span>') + '</td>' +
          '<td class="flex gap-1 flex-wrap">' +
            '<button class="btn btn-ghost btn-xs btn-edit-user" data-id="' + u.id + '">Modifier</button>' +
            '<button class="btn btn-ghost btn-xs btn-toggle-user" data-id="' + u.id + '" data-active="' + (u.is_active ? '1' : '0') + '">' + (u.is_active ? 'Désactiver' : 'Activer') + '</button>' +
            '<button class="btn btn-ghost btn-xs btn-key-user" data-id="' + u.id + '">Clé API</button>' +
          '</td></tr>';
      }).join('');
    }

    document.getElementById('filterRole').addEventListener('change', loadUsers);

    // Create user
    document.getElementById('btnCreateUser').addEventListener('click', async function() {
      var name = document.getElementById('newName').value.trim();
      var email = document.getElementById('newEmail').value.trim();
      var role = document.getElementById('newRole').value;
      if (!name || !email) { setNotif('error', 'Nom et email requis'); return; }
      try {
        var r = await api('/api/v1/admin_users.php', {action:'create', name:name, email:email, role:role});
        if (r.body && r.body.ok) {
          setNotif('success', 'Utilisateur créé. Clé API : ' + (r.body.data.api_key || ''));
          document.getElementById('newName').value = '';
          document.getElementById('newEmail').value = '';
          loadUsers();
        } else {
          setNotif('error', r.body.error || 'Erreur');
        }
      } catch (e) { setNotif('error', e.message); }
    });

    // Delegated clicks on users table
    document.getElementById('usersTableBody').addEventListener('click', async function(e) {
      var btn;

      // Toggle active
      btn = e.target.closest('.btn-toggle-user');
      if (btn) {
        var active = btn.dataset.active === '1' ? 0 : 1;
        var label = active ? 'activer' : 'désactiver';
        if (!confirm('Voulez-vous ' + label + ' cet utilisateur ?')) return;
        try {
          await api('/api/v1/admin_users.php', {action:'toggle', user_id:btn.dataset.id, is_active:active});
          loadUsers();
        } catch(err) { setNotif('error', err.message); }
        return;
      }

      // Rotate API key
      btn = e.target.closest('.btn-key-user');
      if (btn) {
        if (!confirm('Générer une nouvelle clé API ? L\'ancienne sera invalidée.')) return;
        try {
          var r = await api('/api/v1/admin_users.php', {action:'rotate_key', user_id:btn.dataset.id});
          if (r.body && r.body.ok) {
            setNotif('success', 'Nouvelle clé API : ' + r.body.data.api_key);
            loadUsers();
          }
        } catch(err) { setNotif('error', err.message); }
        return;
      }

      // Edit user (modal dialog)
      btn = e.target.closest('.btn-edit-user');
      if (btn) {
        var user = _users.find(function(u) { return u.id === btn.dataset.id; });
        if (!user) return;

        var roleOptions = Object.keys(roleLabelsSystem).map(function(k) {
          var sel = k === user.role ? ' selected' : '';
          return '<option value="' + k + '"' + sel + '>' + escapeHtml(roleLabelsSystem[k]) + '</option>';
        }).join('');

        Shared.openModal({
          title: 'Modifier l\'utilisateur',
          body:
            '<div class="form-group mb-4">' +
              '<label class="form-label">Nom</label>' +
              '<input class="form-input" type="text" id="editName" value="' + escapeHtml(user.name || '') + '">' +
            '</div>' +
            '<div class="form-group mb-4">' +
              '<label class="form-label">Email</label>' +
              '<input class="form-input" type="email" id="editEmail" value="' + escapeHtml(user.email || '') + '">' +
            '</div>' +
            '<div class="form-group">' +
              '<label class="form-label">Rôle système</label>' +
              '<select class="form-input" id="editRole">' + roleOptions + '</select>' +
            '</div>',
          confirmText: 'Enregistrer',
          onConfirm: function(modal) {
            var newName = modal.querySelector('#editName').value.trim();
            var newEmail = modal.querySelector('#editEmail').value.trim();
            var newRole = modal.querySelector('#editRole').value;
            if (!newName || !newEmail) { setNotif('error', 'Nom et email requis'); return false; }
            api('/api/v1/admin_users.php', {action:'update', user_id:user.id, name:newName, email:newEmail, role:newRole})
              .then(function(r) {
                if (r.body && r.body.ok) { setNotif('success', 'Utilisateur modifié'); loadUsers(); }
                else { setNotif('error', r.body.error || 'Erreur'); }
              })
              .catch(function(err) { setNotif('error', err.message); });
          }
        });
        return;
      }
    });

    // ─── Roles / Permissions ─────────────────────────────
    async function loadRoles() {
      try {
        var r = await api('/api/v1/admin_roles.php');
        if (!r.body || !r.body.ok) return;
        var d = r.body.data;

        // System roles info
        var sysInfo = Object.entries(d.system_roles || {}).map(function(e) {
          var cnt = (d.users_by_system_role || []).find(function(x) { return x.role === e[0]; });
          return '<div class="flex items-center justify-between py-2 border-b" style="border-color:var(--color-border-subtle)">' +
            '<span class="role-badge ' + e[0] + '">' + escapeHtml(e[1]) + '</span>' +
            '<span class="text-sm text-muted">' + ((cnt && cnt.count) || 0) + ' utilisateur(s)</span></div>';
        }).join('');
        document.getElementById('systemRolesInfo').innerHTML = sysInfo;

        // Meeting roles info
        var mtgInfo = Object.entries(d.meeting_roles || {}).map(function(e) {
          var cnt = (d.meeting_role_counts || []).find(function(x) { return x.role === e[0]; });
          return '<div class="flex items-center justify-between py-2 border-b" style="border-color:var(--color-border-subtle)">' +
            '<span class="role-badge ' + e[0] + '">' + escapeHtml(e[1]) + '</span>' +
            '<span class="text-sm text-muted">' + ((cnt && cnt.users) || 0) + ' personne(s), ' + ((cnt && cnt.meetings) || 0) + ' séance(s)</span></div>';
        }).join('');
        document.getElementById('meetingRolesInfo').innerHTML = mtgInfo;

        // Permission matrix
        var perms = d.permissions_by_role || {};
        var allPermsSet = {};
        var roleOrder = ['admin','operator','auditor','viewer','president','assessor','voter'];
        roleOrder.forEach(function(role) {
          (perms[role] || []).forEach(function(p) { allPermsSet[p.permission] = true; });
        });
        var allPerms = Object.keys(allPermsSet).sort();

        // Group by resource
        var groups = {};
        allPerms.forEach(function(p) {
          var parts = p.split(':');
          var g = parts[0];
          if (!groups[g]) groups[g] = [];
          groups[g].push(p);
        });

        var permsByRole = {};
        roleOrder.forEach(function(role) {
          permsByRole[role] = {};
          (perms[role] || []).forEach(function(p) { permsByRole[role][p.permission] = true; });
        });

        var html = '<table class="perm-matrix"><thead><tr><th>Permission</th>';
        roleOrder.forEach(function(role) {
          var isSys = !!roleLabelsSystem[role];
          html += '<th><span class="role-badge ' + role + '">' + escapeHtml(allRoleLabels[role] || role) + '</span><br><span class="text-xs text-muted">' + (isSys ? 'S' : 'M') + '</span></th>';
        });
        html += '</tr></thead><tbody>';

        Object.keys(groups).sort().forEach(function(g) {
          html += '<tr><td colspan="' + (roleOrder.length + 1) + '" style="background:var(--color-bg-subtle);font-weight:700;text-transform:uppercase;font-size:10px;letter-spacing:0.1em;padding:6px 8px">' + escapeHtml(g) + '</td></tr>';
          groups[g].forEach(function(perm) {
            html += '<tr><td>' + escapeHtml(perm) + '</td>';
            roleOrder.forEach(function(role) {
              html += '<td>' + (permsByRole[role][perm] ? '<span class="perm-check">&#10003;</span>' : '<span class="perm-none">-</span>') + '</td>';
            });
            html += '</tr>';
          });
        });
        html += '</tbody></table>';
        document.getElementById('permMatrix').innerHTML = html;

      } catch (e) { console.error('loadRoles', e); }
    }

    // ─── State Machine ───────────────────────────────────
    async function loadStates() {
      try {
        var r = await api('/api/v1/admin_roles.php');
        if (!r.body || !r.body.ok) return;
        var d = r.body.data;
        var statuses = d.statuses || {};
        var transitions = d.state_transitions || [];

        // Flow diagram
        var flow = ['draft','scheduled','frozen','live','closed','validated','archived'];
        document.getElementById('stateFlow').innerHTML = flow.map(function(s, i) {
          var label = statuses[s] || s;
          return (i > 0 ? '<span class="state-arrow">&rarr;</span>' : '') +
            '<span class="state-node">' + escapeHtml(label) + '</span>';
        }).join('');

        // Transitions table
        document.getElementById('transitionsBody').innerHTML = transitions.map(function(t) {
          return '<tr>' +
            '<td><span class="state-node state-node-sm">' + escapeHtml(statuses[t.from_status] || t.from_status) + '</span></td>' +
            '<td><span class="state-node state-node-sm">' + escapeHtml(statuses[t.to_status] || t.to_status) + '</span></td>' +
            '<td><span class="role-badge ' + escapeHtml(t.required_role) + '">' + escapeHtml(allRoleLabels[t.required_role] || t.required_role) + '</span></td>' +
            '<td class="text-sm">' + escapeHtml(t.description || '') + '</td></tr>';
        }).join('');

      } catch (e) { console.error('loadStates', e); }
    }

    // ─── System Status ───────────────────────────────────
    async function loadSystemStatus() {
      try {
        var r = await api('/api/v1/admin_system_status.php');
        if (r.body && r.body.ok && r.body.data) {
          var s = r.body.data.system || r.body.data;
          document.getElementById('statDbStatus').textContent = 'Connectée';
          document.getElementById('statDbStatus').className = 'system-stat-value text-success';
          document.getElementById('statDbLatency').textContent = s.db_latency_ms != null ? s.db_latency_ms + ' ms' : '—';
          document.getElementById('statDbConnections').textContent = s.db_active_connections || '—';
          document.getElementById('statActiveMeetings').textContent = s.active_meetings || '—';
          document.getElementById('statTotalMeetings').textContent = s.count_meetings || '—';
          document.getElementById('statTotalMembers').textContent = s.total_members || '—';
          document.getElementById('statPhpVersion').textContent = s.php_version || '—';
          document.getElementById('statMemory').textContent = s.memory_usage || '—';
          document.getElementById('systemStatus').className = 'badge badge-success badge-dot';
          document.getElementById('systemStatus').textContent = 'En ligne';
        } else {
          document.getElementById('statDbStatus').textContent = 'Erreur';
          document.getElementById('statDbStatus').className = 'system-stat-value text-danger';
          document.getElementById('systemStatus').className = 'badge badge-danger';
          document.getElementById('systemStatus').textContent = 'Erreur';
        }
      } catch (e) {
        document.getElementById('statDbStatus').textContent = 'Hors ligne';
        document.getElementById('statDbStatus').className = 'system-stat-value text-danger';
        document.getElementById('systemStatus').className = 'badge badge-danger';
        document.getElementById('systemStatus').textContent = 'Erreur';
      }
    }

    async function loadQuorumPolicies() {
      try {
        var r = await api('/api/v1/quorum_policies.php');
        if (r.body && r.body.ok && r.body.data && Array.isArray(r.body.data.items)) {
          var items = r.body.data.items;
          var el = document.getElementById('quorumList');
          if (!items.length) { el.innerHTML = '<div class="text-center text-muted">Aucune politique</div>'; return; }
          el.innerHTML = items.map(function(p) {
            return '<div class="flex items-center justify-between py-2 border-b" style="border-color:var(--color-border-subtle)">' +
              '<div><div class="font-semibold text-sm">' + escapeHtml(p.name) + '</div>' +
              '<div class="text-xs text-muted">' + escapeHtml(p.description || p.mode || '') + ' — seuil ' + Math.round((p.threshold||0)*100) + '%</div></div></div>';
          }).join('');
        }
      } catch(e) {}
    }

    async function loadVotePolicies() {
      try {
        var r = await api('/api/v1/vote_policies.php');
        if (r.body && r.body.ok && r.body.data && Array.isArray(r.body.data.items)) {
          var items = r.body.data.items;
          var el = document.getElementById('voteList');
          if (!items.length) { el.innerHTML = '<div class="text-center text-muted">Aucune politique</div>'; return; }
          el.innerHTML = items.map(function(p) {
            return '<div class="flex items-center justify-between py-2 border-b" style="border-color:var(--color-border-subtle)">' +
              '<div><div class="font-semibold text-sm">' + escapeHtml(p.name) + '</div>' +
              '<div class="text-xs text-muted">' + escapeHtml(p.description || p.base || '') + ' — seuil ' + Math.round((p.threshold||0)*100) + '%</div></div></div>';
          }).join('');
        }
      } catch(e) {}
    }

    // Reset demo
    document.getElementById('btnResetDemo').addEventListener('click', async function() {
      if (!confirm('Cette action va supprimer TOUTES les données et réinitialiser la démo. Continuer ?')) return;
      try {
        var r = await api('/api/v1/admin_reset_demo.php', {});
        if (r.body && r.body.ok) { setNotif('success', 'Données de démo réinitialisées'); refreshAll(); }
        else { setNotif('error', r.body.error || 'Erreur'); }
      } catch(e) { setNotif('error', e.message); }
    });

    // ─── Refresh ─────────────────────────────────────────
    function refreshAll() {
      loadUsers();
      loadRoles();
      loadStates();
      loadSystemStatus();
      loadQuorumPolicies();
      loadVotePolicies();
    }

    document.getElementById('btnRefresh').addEventListener('click', refreshAll);

    // Guide drawer
    if (window.ShellDrawer && window.ShellDrawer.register) {
      window.ShellDrawer.register('guide', 'Guide', function(mid, body) {
        body.innerHTML =
          '<div style="display:flex;flex-direction:column;gap:16px;padding:4px 0;">' +
            '<div><div style="font-weight:600;margin-bottom:8px">Modèle de rôles</div>' +
              '<div class="text-sm"><strong>Rôles système</strong> (permanents) :<br>' +
              'Admin, Opérateur, Auditeur, Observateur<br><br>' +
              '<strong>Rôles de séance</strong> (par séance) :<br>' +
              'Président, Assesseur, Électeur<br><br>' +
              'Un opérateur peut être président d\'une séance et assesseur d\'une autre.</div></div>' +
            '<div><div style="font-weight:600;margin-bottom:8px">Machine à états</div>' +
              '<div class="text-sm">Brouillon &rarr; Planifiée &rarr; Verrouillée &rarr; En cours &rarr; Clôturée &rarr; Validée &rarr; Archivée<br><br>' +
              'Le président verrouille, ouvre, clôture et valide.<br>L\'admin archive et peut dégeler.</div></div>' +
            '<div><div style="font-weight:600;margin-bottom:8px">Setup DB</div>' +
              '<pre class="text-xs" style="background:var(--color-bg-subtle,#f5f5f5);padding:8px;border-radius:6px;overflow-x:auto">sudo bash database/setup.sh</pre></div>' +
          '</div>';
      });
    }

    // Initial load
    refreshAll();
  })();
  </script>
</body>
</html>
