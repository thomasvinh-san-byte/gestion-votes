<!doctype html>
<html lang="fr" data-page-role="admin">
<head>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#4f46e5" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#1e293b" media="(prefers-color-scheme: dark)">
  <meta name="description" content="Administration — AG-VOTE">
  <title>Administration — AG-VOTE</title>
  <script>!function(){var t=localStorage.getItem('ag-vote-theme');if(!t&&matchMedia('(prefers-color-scheme:dark)').matches)t='dark';if(t)document.documentElement.setAttribute('data-theme',t)}()</script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap">
  <link rel="stylesheet" href="/assets/css/app.css">
  <link rel="stylesheet" href="/assets/css/admin.css">
</head>
<body>
  <!-- Skip links -->
  <a href="#panel-users" class="skip-link">Aller au contenu principal</a>
  <a href="#main-nav" class="skip-link">Aller à la navigation</a>

  <div class="app-shell">
    <!-- Sidebar (loaded from shared partial) -->
    <aside class="app-sidebar" data-include-sidebar data-page="admin"></aside>

    <!-- Header -->
    <header class="app-header">
      <div class="flex items-center gap-4">
        <div>
          <h1 class="text-xl font-bold">Administration</h1>
          <p class="text-sm text-secondary">Utilisateurs, rôles, politiques, système</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn btn-secondary btn-sm" id="btnRefresh">Actualiser</button>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="guide" title="Guide">?</button>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="context" title="Séance en cours"><svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-menu"></use></svg></button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
      <div class="container">
        <div id="notif_box" class="hidden mb-4"></div>

        <!-- Tabs -->
        <div class="admin-tabs" role="tablist" aria-label="Sections d'administration">
          <button class="admin-tab active" data-tab="users" role="tab" aria-selected="true" aria-controls="panel-users" id="tab-users">Utilisateurs</button>
          <button class="admin-tab" data-tab="meeting-roles" role="tab" aria-selected="false" aria-controls="panel-meeting-roles" id="tab-meeting-roles">Rôles de séance</button>
          <button class="admin-tab" data-tab="policies" role="tab" aria-selected="false" aria-controls="panel-policies" id="tab-policies">Politiques</button>
          <button class="admin-tab" data-tab="roles" role="tab" aria-selected="false" aria-controls="panel-roles" id="tab-roles">Permissions</button>
          <button class="admin-tab" data-tab="states" role="tab" aria-selected="false" aria-controls="panel-states" id="tab-states">Machine à états</button>
          <button class="admin-tab" data-tab="system" role="tab" aria-selected="false" aria-controls="panel-system" id="tab-system">Système</button>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 1 : UTILISATEURS                      -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="admin-panel active" id="panel-users" role="tabpanel" aria-labelledby="tab-users">
          <!-- Create user form -->
          <div class="card mb-4">
            <div class="card-header">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="card-title">Ajouter un utilisateur</h3>
                  <p class="card-description">Créez un compte avec accès au système</p>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="inline-form" id="createUserForm">
                <div class="form-group">
                  <label class="form-label" for="newName">Nom *</label>
                  <input class="form-input" type="text" id="newName" placeholder="Jean Dupont" required maxlength="255">
                </div>
                <div class="form-group">
                  <label class="form-label" for="newEmail">Email *</label>
                  <input class="form-input" type="email" id="newEmail" placeholder="jean@example.com" required maxlength="320">
                </div>
                <div class="form-group">
                  <label class="form-label" for="newPassword">Mot de passe *</label>
                  <input class="form-input" type="password" id="newPassword" placeholder="Min. 8 caractères" autocomplete="new-password" required minlength="8">
                  <div class="password-strength" id="passwordStrength" hidden>
                    <div class="password-strength-bar"><div class="password-strength-fill" id="passwordStrengthFill"></div></div>
                    <span class="password-strength-text" id="passwordStrengthText">—</span>
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Rôle système</label>
                  <select class="form-input" id="newRole">
                    <option value="viewer">Observateur</option>
                    <option value="operator">Opérateur</option>
                    <option value="auditor">Auditeur</option>
                    <option value="admin">Administrateur</option>
                  </select>
                </div>
                <button class="btn btn-primary" id="btnCreateUser">Ajouter</button>
              </div>
            </div>
          </div>

          <!-- Filter and search -->
          <div class="card mb-4">
            <div class="card-body">
              <div class="flex items-center gap-4 flex-wrap">
                <div class="form-group form-group-search">
                  <label class="form-label" for="searchUser">Rechercher</label>
                  <input class="form-input" type="text" id="searchUser" placeholder="Nom ou email...">
                </div>
                <div class="form-group form-group-filter">
                  <label class="form-label">Filtrer par rôle</label>
                  <select class="form-input" id="filterRole">
                    <option value="">Tous les rôles</option>
                    <option value="admin">Administrateur</option>
                    <option value="operator">Opérateur</option>
                    <option value="auditor">Auditeur</option>
                    <option value="viewer">Observateur</option>
                  </select>
                </div>
                <div class="text-sm text-muted users-count" id="usersCount">— utilisateurs</div>
              </div>
            </div>
          </div>

          <!-- Users list -->
          <div class="card">
            <div class="card-body p-0">
              <div class="users-list" id="usersTableBody" aria-busy="true" aria-label="Liste des utilisateurs">
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 2 : RÔLES DE SÉANCE                   -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="admin-panel" id="panel-meeting-roles" role="tabpanel" aria-labelledby="tab-meeting-roles">
          <!-- Assign form -->
          <div class="card mb-4">
            <div class="card-header"><h3 class="card-title">Assigner un rôle de séance</h3></div>
            <div class="card-body">
              <div class="inline-form">
                <div class="form-group">
                  <label class="form-label">Séance</label>
                  <ag-searchable-select
                    id="mrMeeting"
                    placeholder="Rechercher une séance..."
                    empty-text="Aucune séance trouvée"
                  ></ag-searchable-select>
                </div>
                <div class="form-group">
                  <label class="form-label">Utilisateur</label>
                  <ag-searchable-select
                    id="mrUser"
                    placeholder="Rechercher un utilisateur..."
                    empty-text="Aucun utilisateur trouvé"
                  ></ag-searchable-select>
                </div>
                <div class="form-group">
                  <label class="form-label">Rôle</label>
                  <select class="form-input" id="mrRole">
                    <option value="voter">Électeur</option>
                    <option value="assessor">Assesseur</option>
                    <option value="president">Président</option>
                  </select>
                </div>
                <button class="btn btn-primary" id="btnAssignRole">Assigner</button>
                <button class="btn btn-secondary" id="btnBulkAssign" title="Assigner un rôle à plusieurs utilisateurs">Assignation en masse</button>
              </div>
            </div>
          </div>
          <!-- Roles by meeting -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Rôles assignés</h3>
              <p class="card-description">Sélectionnez une séance pour voir les rôles ou affichez le résumé global</p>
            </div>
            <div class="card-body p-0">
              <table class="users-table">
                <thead>
                  <tr><th scope="col">Séance</th><th scope="col">Utilisateur</th><th scope="col">Rôle</th><th scope="col" class="table-col-actions-sm">Actions</th></tr>
                </thead>
                <tbody id="meetingRolesBody">
                  <tr><td colspan="4"><div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div></td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 3 : POLITIQUES                         -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="admin-panel" id="panel-policies" role="tabpanel" aria-labelledby="tab-policies">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Quorum policies -->
            <div class="card">
              <div class="card-header">
                <div class="flex items-center justify-between">
                  <div><h3 class="card-title">Politiques de quorum</h3><p class="card-description">Règles de quorum applicables aux séances</p></div>
                  <button class="btn btn-primary btn-sm" id="btnAddQuorum">Ajouter</button>
                </div>
              </div>
              <div class="card-body" id="quorumList"><div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div><div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div></div>
            </div>
            <!-- Vote policies -->
            <div class="card">
              <div class="card-header">
                <div class="flex items-center justify-between">
                  <div><h3 class="card-title">Politiques de vote</h3><p class="card-description">Règles de majorité applicables aux résolutions</p></div>
                  <button class="btn btn-primary btn-sm" id="btnAddVote">Ajouter</button>
                </div>
              </div>
              <div class="card-body" id="voteList"><div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div><div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div></div>
            </div>
          </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 4 : PERMISSIONS                        -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="admin-panel" id="panel-roles" role="tabpanel" aria-labelledby="tab-roles">
          <div class="card mb-4">
            <div class="card-header">
              <h3 class="card-title">
                Matrice des permissions
                <ag-popover title="Matrice des permissions" content="S = Rôle système (permanent, lié au compte utilisateur). M = Rôle de séance (temporaire, attribué par séance). Chaque cellule indique si le rôle possède cette permission." position="right"></ag-popover>
              </h3>
              <p class="card-description">Rôles système (S) et rôles de séance (M)</p>
            </div>
            <div class="card-body card-body-scroll">
              <div class="mb-3">
                <input class="form-input" type="search" id="permSearch" placeholder="Filtrer les permissions..." aria-label="Filtrer les permissions">
              </div>
              <div id="permMatrix" aria-live="polite" aria-busy="true"><div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div><div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div></div>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  Rôles système
                  <ag-popover title="Rôles système" content="Rôles permanents attachés au compte utilisateur. Ils définissent les permissions globales : admin (tout accès), operator (gestion des séances), auditor (lecture seule), viewer (accès limité)." position="right"></ag-popover>
                </h3>
                <p class="card-description">Permanents, liés au compte</p>
              </div>
              <div class="card-body" id="systemRolesInfo"><div class="skeleton-row"><div class="skeleton skeleton-line" style="width:60%"></div></div></div>
            </div>
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">
                  Rôles de séance
                  <ag-popover title="Rôles de séance" content="Rôles temporaires assignés pour une séance spécifique. Président : dirige la séance. Assesseur : assiste au dépouillement. Électeur : peut voter." position="right"></ag-popover>
                </h3>
                <p class="card-description">Temporaires, attribués par séance</p>
              </div>
              <div class="card-body" id="meetingRolesInfo"><div class="skeleton-row"><div class="skeleton skeleton-line" style="width:60%"></div></div></div>
            </div>
          </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 3 : MACHINE À ÉTATS                   -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="admin-panel" id="panel-states" role="tabpanel" aria-labelledby="tab-states">
          <div class="card mb-4">
            <div class="card-header">
              <h3 class="card-title">Cycle de vie d'une séance</h3>
              <p class="card-description">Visualisation des états et transitions possibles</p>
            </div>
            <div class="card-body">
              <div class="state-flow-visual" id="stateFlow"><div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div></div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="card">
              <div class="card-header"><h3 class="card-title">Légende des états</h3></div>
              <div class="card-body">
                <div class="flex flex-wrap gap-2">
                  <span class="state-node-visual draft">Brouillon</span>
                  <span class="state-node-visual scheduled">Programmée</span>
                  <span class="state-node-visual frozen">Verrouillée</span>
                  <span class="state-node-visual live">En cours</span>
                  <span class="state-node-visual closed">Clôturée</span>
                  <span class="state-node-visual validated">Validée</span>
                  <span class="state-node-visual archived">Archivée</span>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header"><h3 class="card-title">Statistiques actuelles</h3></div>
              <div class="card-body" id="stateStats">
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><h3 class="card-title">Transitions autorisées</h3></div>
            <div class="card-body p-0">
              <table class="users-table" id="transitionsTable">
                <thead><tr><th scope="col">De</th><th scope="col">Vers</th><th scope="col">Rôle requis</th><th scope="col">Description</th></tr></thead>
                <tbody id="transitionsBody"><tr><td colspan="4"><div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div></td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- P5-5: Dé-archivage -->
          <div class="card mt-4">
            <div class="card-header">
              <h3 class="card-title">Séances archivées</h3>
              <p class="card-description">Restaurer une séance archivée vers l'état « Validée » pour corrections</p>
            </div>
            <div class="card-body p-0" id="archivedMeetingsList">
              <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
            </div>
          </div>
        </div>

        <!-- ═══════════════════════════════════════════ -->
        <!-- TAB 6 : SYSTÈME                           -->
        <!-- ═══════════════════════════════════════════ -->
        <div class="admin-panel" id="panel-system" role="tabpanel" aria-labelledby="tab-system">
          <div class="admin-health-strip">
            <div class="admin-health-kpi" id="healthUptime">
              <span class="admin-health-icon success">●</span>
              <div>
                <span class="admin-health-value">En ligne</span>
                <span class="admin-health-label">Statut système</span>
              </div>
            </div>
            <div class="admin-health-kpi" id="healthLatency" title="Vert : < 50ms · Orange : < 200ms · Rouge : ≥ 200ms">
              <span class="admin-health-icon" id="healthLatencyDot" aria-hidden="true">●</span>
              <div>
                <span class="admin-health-value" id="healthLatencyValue">—</span>
                <span class="admin-health-label">Latence BDD</span>
              </div>
            </div>
            <div class="admin-health-kpi" id="healthMemory" title="Vert : < 70% · Orange : < 90% · Rouge : ≥ 90%">
              <span class="admin-health-icon" id="healthMemoryDot" aria-hidden="true">●</span>
              <div>
                <span class="admin-health-value" id="healthMemoryValue">—</span>
                <span class="admin-health-label">Mémoire</span>
              </div>
            </div>
            <div class="admin-health-kpi" id="healthMeetings">
              <span class="admin-health-icon primary">●</span>
              <div>
                <span class="admin-health-value" id="healthMeetingsValue">—</span>
                <span class="admin-health-label">Séances actives</span>
              </div>
            </div>
          </div>
          <div class="card mb-4">
            <div class="card-header">
              <div class="flex items-center justify-between">
                <div><h3 class="card-title">Statut système</h3><p class="card-description">Connexions, latence, compteurs</p></div>
                <span class="badge badge-success badge-dot" id="systemStatus">En ligne</span>
              </div>
            </div>
            <div class="card-body p-0" id="systemStats">
              <div class="system-stat"><span class="system-stat-label">Base de données</span><span class="system-stat-value" id="statDbStatus"><span class="skeleton skeleton-line" style="width:60px;display:inline-block"></span></span></div>
              <div class="system-stat"><span class="system-stat-label">Latence DB <ag-popover title="Latence de la base de données" content="Temps de réponse pour une requête simple. Normal : < 10ms. Acceptable : < 50ms. Lent : > 100ms." position="right"></ag-popover></span><span class="system-stat-value" id="statDbLatency">—</span></div>
              <div class="system-stat"><span class="system-stat-label">Connexions actives</span><span class="system-stat-value" id="statDbConnections">—</span></div>
              <div class="system-stat"><span class="system-stat-label">Séances en cours</span><span class="system-stat-value" id="statActiveMeetings">—</span></div>
              <div class="system-stat"><span class="system-stat-label">Total séances</span><span class="system-stat-value" id="statTotalMeetings">—</span></div>
              <div class="system-stat"><span class="system-stat-label">Membres actifs</span><span class="system-stat-value" id="statTotalMembers">—</span></div>
              <div class="system-stat"><span class="system-stat-label">Version PHP</span><span class="system-stat-value" id="statPhpVersion">—</span></div>
              <div class="system-stat"><span class="system-stat-label">Mémoire</span><span class="system-stat-value" id="statMemory">—</span></div>
            </div>
          </div>
          <!-- System alerts -->
          <div class="card mb-4">
            <div class="card-header">
              <h3 class="card-title">Alertes système</h3>
              <p class="card-description">Alertes automatiques : latence, disque, authentification</p>
            </div>
            <div class="card-body p-0" id="systemAlerts">
              <div class="skeleton-row"><div class="skeleton skeleton-cell"></div></div>
            </div>
          </div>

          <!-- Journal d'audit admin (P7-2) -->
          <div class="card mb-4">
            <div class="card-header">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="card-title">Journal des actions admin</h3>
                  <p class="card-description">Historique des créations, modifications et suppressions d'utilisateurs, rôles et politiques</p>
                </div>
                <div class="flex gap-2 items-center">
                  <select class="form-input form-input-sm" id="adminAuditAction" style="max-width:220px;" aria-label="Filtrer par type d'action">
                    <option value="">Toutes les actions</option>
                  </select>
                  <input class="form-input form-input-sm" type="search" id="adminAuditSearch" placeholder="Rechercher..." style="max-width:200px;" aria-label="Rechercher dans le journal">
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              <div id="adminAuditList" style="max-height:400px;overflow:auto;">
                <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
              </div>
              <div class="flex items-center justify-between p-3 border-top" id="adminAuditPagination" style="display:none;">
                <span class="text-sm text-muted" id="adminAuditCount"></span>
                <div class="flex gap-2">
                  <button class="btn btn-ghost btn-xs" id="adminAuditPrev" disabled>Précédent</button>
                  <button class="btn btn-ghost btn-xs" id="adminAuditNext">Suivant</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="card card-danger">
            <div class="card-header"><h3 class="card-title text-danger">Zone dangereuse</h3></div>
            <div class="card-body">
              <div class="flex items-center justify-between gap-4 p-4 bg-surface rounded-lg border">
                <div>
                  <div class="font-semibold">
                    Réinitialiser les données de démo
                    <ag-popover title="Attention - Action irréversible" content="Cette action supprimera TOUTES les séances, résolutions, votes et présences. Seuls les utilisateurs et la configuration seront conservés. Les données d'exemple seront rechargées." position="top"></ag-popover>
                  </div>
                  <div class="text-sm text-muted">Supprime toutes les séances et recharge les données de test</div>
                </div>
                <button class="btn btn-danger" id="btnResetDemo">Réinitialiser</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Drawer -->
  <div class="drawer-backdrop" data-drawer-close></div>
  <aside class="drawer" id="drawer" role="dialog" aria-modal="true" aria-label="Panneau latéral">
    <div class="drawer-header">
      <div id="drawerTitle" class="font-semibold">Menu</div>
      <button class="btn btn-ghost btn-icon btn-sm" type="button" data-drawer-close aria-label="Fermer le panneau">✕</button>
    </div>
    <div id="drawerBody" class="drawer-body"></div>
  </aside>

  <!-- Scripts -->
  <script type="module" src="/assets/js/components/index.js"></script>
  <script src="/assets/js/core/utils.js"></script>
  <script src="/assets/js/core/shared.js"></script>
  <script src="/assets/js/core/shell.js"></script>
  <script src="/assets/js/pages/admin.js"></script>
</body>
</html>
