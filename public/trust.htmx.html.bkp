<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Console Pr√©sident ‚Äî √âcran de confiance</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    :root {
        --primary: #1e3a8a;
        --secondary: #3b82f6;
        --bg: #f3f4f6;
        --danger: #dc2626;
        --warning: #ea580c;
        --success: #16a34a;
        --muted: #6b7280;
        --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
        margin: 0;
        padding: 20px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg);
        color: #111827;
    }
    h1 { margin-top: 0; font-size: 22px; }
    .layout {
        max-width: 1100px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1.5fr 1.5fr;
        gap: 24px;
    }
    .card {
        background: white;
        border-radius: 10px;
        padding: 20px 24px;
        box-shadow: 0 2px 6px rgba(0,0,0,.08);
        margin-bottom: 16px;
        border: 1px solid var(--border);
    }
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }
    .badge {
        display: inline-block;
        padding: 3px 12px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 500;
        background: #e5e7eb;
        color: #374151;
        border: 1px solid transparent;
    }
    .badge.live {
        background: #dcfce7;
        color: #166534;
        border-color: #bbf7d0;
    }
    .badge.closed {
        background: #fee2e2;
        color: #b91c1c;
        border-color: #fecaca;
    }
    .badge.unknown {
        background: #f3f4f6;
        color: #6b7280;
        border-color: #e5e7eb;
    }
    .badge.muted {
        background: #f3f4f6;
        color: #6b7280;
        font-size: 11px;
        padding: 1px 8px;
        border: none;
    }
    .badge.small {
        font-size: 10px;
        padding: 1px 8px;
        margin-left: 6px;
    }
    .title-main {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 4px;
    }
    .subtitle {
        font-size: 14px;
        color: var(--muted);
        line-height: 1.4;
    }
    .motion-title {
        font-size: 18px;
        font-weight: 600;
        margin: 4px 0;
    }
    .muted {
        color: var(--muted);
        font-size: 13px;
    }
    .agenda-title {
        font-weight: 600;
        font-size: 15px;
        margin-bottom: 6px;
        padding-bottom: 4px;
        border-bottom: 1px dashed #e5e7eb;
    }
    .motion-line {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 13px;
        color: #374151;
        margin-bottom: 2px;
        transition: background 0.2s;
    }
    .motion-line:hover {
        background: #f8fafc;
    }
    .motion-line.current {
        background: #eff6ff;
        border-left: 3px solid var(--primary);
        padding-left: 10px;
    }
    .list {
        margin-top: 8px;
        max-height: 300px;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        padding: 10px;
    }
    .status-line {
        font-size: 13px;
        color: #4b5563;
        margin-top: 6px;
        line-height: 1.4;
    }
    .evote-results {
        background: #f8fafc;
        border-radius: 8px;
        padding: 12px;
        margin-top: 12px;
        border: 1px solid #e2e8f0;
        font-size: 13px;
    }
    .evote-results strong {
        display: block;
        margin-bottom: 6px;
        color: #1e293b;
    }
    .evote-row {
        display: flex;
        gap: 16px;
        margin-top: 4px;
    }
    .evote-item {
        flex: 1;
    }
    .evote-item span {
        font-weight: 600;
        color: var(--primary);
    }
    .quorum-info {
        font-size: 12px;
        color: #64748b;
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px dashed #e2e8f0;
    }
    .notif {
        max-width: 1100px;
        margin: 0 auto 16px auto;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 13px;
        display: none;
    }
    .notif.error {
        display: block;
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
    .notif.success {
        display: block;
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }
    .notif.warning {
        display: block;
        background: #ffedd5;
        color: #9a3412;
        border: 1px solid #fdba74;
    }
    input, select {
        width: 100%;
        padding: 8px 12px;
        font-size: 14px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        background: #f9fafb;
        margin-bottom: 8px;
    }
    input:focus, select:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
    }
    button {
        padding: 8px 16px;
        border-radius: 8px;
        border: none;
        background: var(--primary);
        color: white;
        font-weight: 500;
        cursor: pointer;
        font-size: 13px;
        transition: background 0.2s;
    }
    button:hover { background: var(--secondary); }
    button:disabled { opacity: .5; cursor: not-allowed; }
    button.warning {
        background: var(--warning);
    }
    button.warning:hover {
        background: #c2410c;
    }
    .validation-warning {
        font-size: 12px;
        color: var(--warning);
        margin-top: 6px;
        padding: 6px 8px;
        background: #ffedd5;
        border-radius: 4px;
        border-left: 3px solid var(--warning);
        display: none;
    }
    .validation-warning.show {
        display: block;
    }
    .last-validated {
        background: #f0f9ff;
        border-radius: 8px;
        padding: 12px;
        margin-top: 12px;
        border: 1px solid #bae6fd;
        font-size: 13px;
    }
    .last-validated strong {
        display: block;
        margin-bottom: 4px;
        color: #0369a1;
    }
    .time-ago {
        font-size: 11px;
        color: #64748b;
    }
    hr {
        border: none;
        border-top: 1px solid #e5e7eb;
        margin: 16px 0;
    }
    .flex-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    .statut-line {
        font-size: 13px;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-top: 2px;
    }
    .statut-open {
        background: #dcfce7;
        color: #166534;
    }
    .statut-closed-adopted {
        background: #bbf7d0;
        color: #166534;
        font-weight: 500;
    }
    .statut-closed-rejected {
        background: #fee2e2;
        color: #b91c1c;
        font-weight: 500;
    }
    .statut-draft {
        background: #f3f4f6;
        color: #6b7280;
    }
</style>
<link rel="stylesheet" href="/assets/css/app.css">
<script src="/assets/js/ui.js"></script>
</head>
<body>
<header class="app-topbar">
  <div class="row">
    <div class="brand"><span class="dot"></span><span>gestion_votes</span></div>
    <nav class="nav">
      <a href="/trust.htmx.html" class="active">Trust</a>
      <a href="/proxies.htmx.html" class="">Procurations</a>
      <a href="/report.htmx.html" class="">PV</a>
    </nav>
  </div>
</header>


<h1>Console Pr√©sident ‚Äî √âcran de confiance</h1>
<p class="subtitle">
    Suivi de la s√©ance et validation officielle par le Pr√©sident.
</p>

<div id="notif_box" class="notif" role="status" aria-live="polite"></div>

<div class="layout">
    <!-- Colonne gauche : s√©ance & r√©solution en cours + validation -->
    <div>
        <!-- Carte : Statut de la s√©ance -->
        <div class="card">
            <div class="card-header">
                <div style="flex: 1;">
                    <div class="title-main" id="meeting_title">Aucune s√©ance en cours</div>
                    <div class="subtitle" id="meeting_info"></div>
                </div>
                <span class="badge unknown" id="meeting_badge">hors s√©ance</span>
            </div>
            
            <div id="validation_block" class="muted" style="font-size:12px;"></div>
            
            <!-- Derni√®re s√©ance valid√©e (visible uniquement hors s√©ance) -->
            <div id="last_validated_block" class="last-validated" style="display:none;">
                <strong>üìã Derni√®re s√©ance valid√©e</strong>
                <div id="last_validated_content"></div>
            </div>
        </div>

        <!-- Carte : R√©solution en cours -->
        <div class="card">
            <h2 style="font-size:16px; margin-top:0; margin-bottom:12px;">üìã R√©solution en cours</h2>
            
            <div id="current_motion_title" class="motion-title">
                Aucune r√©solution ouverte.
            </div>
            
            <div id="current_motion_status" class="statut-line statut-draft"></div>
            
            <!-- R√©sultats e-vote -->
            <div id="evote_results" class="evote-results" style="display:none;">
                <strong>üìä R√©sultats e-vote</strong>
                <div id="cm_decision_line" style="margin-bottom:8px; font-weight:500;"></div>
                <div class="evote-row">
                    <div class="evote-item">Pour : <span id="cm_for_count">0</span> (<span id="cm_for_weight">0</span>)</div>
                    <div class="evote-item">Contre : <span id="cm_against_count">0</span> (<span id="cm_against_weight">0</span>)</div>
                    <div class="evote-item">Abstention : <span id="cm_abstain_count">0</span> (<span id="cm_abstain_weight">0</span>)</div>
                </div>
                <div class="quorum-info">
                    Quorum : <span id="cm_quorum_status">‚Äì</span>
                    (ratio <span id="cm_quorum_ratio">‚Äì</span>, seuil <span id="cm_quorum_threshold">‚Äì</span>)
                </div>
            </div>
            
            <div id="no_current_motion" class="muted" style="margin-top:8px;">
                Aucune r√©solution n'est actuellement ouverte au vote.
            </div>
        </div>

        <!-- Carte : Validation -->
        <div class="card">
            <h2 style="font-size:16px; margin-top:0; margin-bottom:12px;">‚úÖ Validation par le Pr√©sident</h2>
            
            <p class="muted" style="margin-bottom:8px;">
                Une fois tous les votes termin√©s, validez la s√©ance pour la cl√¥turer d√©finitivement et l'archiver.
            </p>

            <!-- Nouveau : message de statut de signature (ready_to_sign / manque comptage / etc.) -->
            <div id="sign_status_info" class="muted" style="font-size:13px; margin-bottom:8px;"></div>
            
            <label for="president_select" style="font-size:12px; font-weight:500; display:block; margin-bottom:4px;">
                Pr√©sident (depuis la base)
            </label>
            <select id="president_select">
                <option value="">‚Äì S√©lectionner un pr√©sident ‚Äì</option>
            </select>
            
            <label for="president_name" style="font-size:12px; font-weight:500; display:block; margin-bottom:4px;">
                Nom du Pr√©sident
            </label>
            <input id="president_name" placeholder="Nom Pr√©nom">
            
            <div id="validation_warning" class="validation-warning"></div>
            
            <button id="btn_validate" type="button" onclick="validateMeeting()" disabled>
                Valider la s√©ance
            </button>

            <button id="btn_report" type="button" onclick="openMeetingReport()" disabled style="margin-top:8px;">
                Voir le PV
            </button>
            
            <div id="post_validation_message" class="muted" style="margin-top:8px; display:none;">
                ‚úÖ S√©ance cl√¥tur√©e avec succ√®s. Vous pouvez maintenant passer √† la suivante.
            </div>
        </div>
    </div>

    <!-- Colonne droite : ODJ & r√©solutions -->
    <div>
        <div class="card">
            <div class="card-header">
                <h2 style="font-size:16px; margin:0;">üìã ODJ & r√©solutions</h2>
            </div>
            
            <div id="agendas_motions_list" class="list"></div>
            
            <div id="no_motions" class="muted" style="text-align:center; padding:20px;">
                Aucune r√©solution d√©finie pour cette s√©ance.
            </div>
        </div>
        
        
        <div class="card" id="motionsCard">
            <div class="card-header">
                <h2 style="font-size:16px; margin:0;">üìå Motions & d√©cisions</h2>
                <div class="muted" style="font-size:12px;">Source officielle¬†: manuel si saisi, sinon e-vote.</div>
            </div>
            <div class="table-wrap">
                <table class="table" style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th style="text-align:left;">Motion</th>
                            <th style="text-align:left; width:90px;">Source</th>
                            <th style="width:70px;">Pour</th>
                            <th style="width:70px;">Contre</th>
                            <th style="width:90px;">Abst.</th>
                            <th style="text-align:left; width:110px;">D√©cision</th>
                        </tr>
                    </thead>
                    <tbody id="motionsTbody"></tbody>
                </table>
                <div id="motionsEmpty" class="muted" style="padding:12px; display:none;">Aucune motion √† afficher.</div>
            </div>
        </div>

<!-- Carte : Informations de d√©bogage (optionnelle) -->
        <div class="card" style="background:#f8fafc;">
            <h3 style="font-size:14px; margin-top:0; color:#64748b;">üíª Informations syst√®me</h3>
            <div class="status-line">
                <div>Dernier rafra√Æchissement : <span id="last_refresh">‚Äì</span></div>
                <div style="margin-top:4px;">S√©ance ID : <span id="debug_meeting_id">‚Äì</span></div>
                <div>Motions charg√©es : <span id="debug_motions_count">0</span></div>
                <div>Pr√©sidents disponibles : <span id="debug_presidents_count">0</span></div>
            </div>
        </div>
    </div>
</div>
<script src="/assets/js/realtime-core.js"></script>
<script>
let state = {
    meeting: null,
    motions: [],
    currentMotionId: null,
    lastValidated: null,
    loading: false,
    presidents: [],
    currentPresidentMemberId: null,
    lastRefresh: null
};

let presidentSelectInitialized = false;

const stateLabelMap = {
    draft:   { text: "Brouillon",  className: "badge muted" },
    open:    { text: "Ouverte",    className: "badge live" },
    closed:  { text: "Cl√¥tur√©e",   className: "badge closed" },
};

function setNotif(type, message) {
    const box = document.getElementById("notif_box");
    if (!message) {
        box.style.display = 'none';
        box.textContent = '';
        box.className = 'notif';
        box.setAttribute('role', 'status');
        box.setAttribute('aria-live', 'polite');
        return;
    }
    box.textContent = message;
    box.className = 'notif ' + type;
    box.style.display = 'block';

    if (type === 'error') {
        box.setAttribute('role', 'alert');
        box.setAttribute('aria-live', 'assertive');
    } else {
        box.setAttribute('role', 'status');
        box.setAttribute('aria-live', 'polite');
    }
    
    if (type === 'success') {
        setTimeout(() => {
            box.style.display = 'none';
        }, 5000);
    }

    const tt = (type === 'success') ? 'ok' : (type === 'warning' ? 'warn' : (type === 'error' ? 'err' : 'ok'));
    toast(type === 'error' ? 'Erreur' : (type === 'warning' ? 'Attention' : 'Info'), message, tt);
}


function motionState(m) {
    if (m.closed_at) return 'closed';
    if (m.opened_at) return 'open';
    return 'draft';
}

function motionStatusBadge(m) {
    const s = motionState(m);
    const conf = stateLabelMap[s] || { text: "Inconnu", className: "badge unknown" };
    const span = document.createElement("span");
    span.className = conf.className + " small";
    span.textContent = conf.text;
    return span;
}

function decisionLabel(decision) {
    switch (decision) {
        case 'adopted': return 'Adopt√©e';
        case 'rejected': return 'Rejet√©e';
        case 'pending': return 'En attente';
        default: return decision || '‚Äî';
    }
}

function renderLastValidatedBlock() {
    const block = document.getElementById("last_validated_block");
    const content = document.getElementById("last_validated_content");

    if (!state.lastValidated) {
        block.style.display = 'none';
        return;
    }

    const v = state.lastValidated;
    const validatedAt = new Date(v.validated_at);
    const diffMs = new Date() - validatedAt;
    const timeAgoMinutes = Math.floor(diffMs / 60000);

    block.style.display = 'block';
    content.innerHTML = `
        <div><strong>${v.title}</strong></div>
        <div>Valid√©e par ${v.validated_by}</div>
        <div class="time-ago">Le ${validatedAt.toLocaleString()} (il y a ${timeAgoMinutes} min)</div>
    `;
}

window.APP_API_KEY = window.APP_API_KEY || "dev-trust-key";

function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = (text ?? "").toString();
    return div.innerHTML;
}
function apiHeaders() {
    return {
        "X-Api-Key": window.APP_API_KEY,
        "Accept": "application/json"
    };
}

// Pack 8: Motions & d√©cisions (table officielle)
async function loadMotionsOverview(meetingId) {
    const tbody = document.getElementById("motionsTbody");
    const empty = document.getElementById("motionsEmpty");
    if (!tbody) return;
    if (!meetingId) {
        tbody.innerHTML = "";
        if (empty) empty.style.display = "block";
        return;
    }
    try {
        const r = await UI.fetchJson(`/api/v1/trust_overview.php?meeting_id=${encodeURIComponent(meetingId)}`, {
            headers: apiHeaders()
        });
        const motions = (r?.data?.motions || []);
        tbody.innerHTML = "";
        if (empty) empty.style.display = motions.length ? "none" : "block";
        motions.forEach((m) => {
            const t = m.tallies || {};
            const dec = m.decision || {};
            const forW = t.for?.weight ?? 0;
            const agW  = t.against?.weight ?? 0;
            const abW  = t.abstain?.weight ?? 0;
            const src  = m.official_source || "‚Äî";
            const ds   = dec.status || "‚Äî";
            const badge =
                ds === "adopted" ? "badge success" :
                ds === "rejected" ? "badge danger" :
                "badge unknown";
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>
                    <div><strong>${escapeHtml(m.title || "Motion")}</strong></div>
                    <div class="muted" style="font-size:12px;">${escapeHtml(m.description || "")}</div>
                </td>
                <td><span class="badge muted">${escapeHtml(src)}</span></td>
                <td style="text-align:center;">${forW}</td>
                <td style="text-align:center;">${agW}</td>
                <td style="text-align:center;">${abW}</td>
                <td><span class="${badge}">${escapeHtml(ds)}</span></td>
            `;
            tbody.appendChild(tr);
        });
    } catch (e) {
        console.error("Erreur loadMotionsOverview:", e);
        if (empty) empty.style.display = "block";
        // toast discret (√©vite d‚Äô√™tre bruyant)
        if (window.UI?.toast) UI.toast("Motions", "Impossible de charger l‚Äôaper√ßu des d√©cisions.", "warning");
    }
}

// CORRECTION: Fonction api unique et correctement d√©clar√©e
async function api(url, data = null) {
    const opts = {};
    opts.headers = { "X-Api-Key": window.APP_API_KEY };

    if (data) {
        opts.method = "POST";
        opts.headers["Content-Type"] = "application/json";
        opts.body = JSON.stringify(data);
    }

    const res = await fetch(url, opts);
    const body = await res.json().catch(() => null);
    return { status: res.status, body };
}

async function loadPresidents() {
    try {
        const { status, body } = await api("/api/v1/presidents.php");
        if (!body || body.ok === false) {
            console.warn("Erreur chargement pr√©sidents:", body || status);
            return;
        }
        state.presidents = (body.data && body.data.presidents) || body.presidents || [];
        renderPresidentSelect();
        
        const dbg = document.getElementById('debug_presidents_count');
        if (dbg) dbg.textContent = state.presidents.length;
    } catch (e) {
        console.error("Erreur loadPresidents:", e);
    }
}

function renderPresidentSelect() {
    const sel = document.getElementById("president_select");
    if (!sel) return;

    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "‚Äì S√©lectionner un pr√©sident ‚Äì";
    sel.appendChild(opt0);

    state.presidents.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.full_name + (p.role ? " (" + p.role + ")" : "");
        sel.appendChild(opt);
    });

    if (!presidentSelectInitialized) {
        sel.addEventListener("change", () => {
            const id = sel.value || null;
            state.currentPresidentMemberId = id;
            if (!id) return;
            const chosen = state.presidents.find(p => p.id === id);
            if (chosen) {
                const input = document.getElementById("president_name");
                if (input && !input.value.trim()) {
                    input.value = chosen.full_name;
                }
            }
        });
        presidentSelectInitialized = true;
    }
}

/** Pas de s√©ance en cours */
function handleNoLiveMeeting(extraMessage) {
    const badge = document.getElementById("meeting_badge");
    const mt = document.getElementById("meeting_title");
    const mi = document.getElementById("meeting_info");
    const btnValidate = document.getElementById("btn_validate");
    const lastValidatedBlock = document.getElementById("last_validated_block");
    const validationBlock = document.getElementById("validation_block");
    const debugMeetingId = document.getElementById("debug_meeting_id");
    const debugMotionsCount = document.getElementById("debug_motions_count");
    const signInfo = document.getElementById("sign_status_info");

    badge.className = "badge unknown";
    badge.textContent = "hors s√©ance";
    mt.textContent = "Aucune s√©ance en cours";
    mi.textContent = extraMessage || "Attente d'une nouvelle s√©ance...";

    btnValidate.disabled = true;
    const btnReport = document.getElementById("btn_report");
    if (btnReport) btnReport.disabled = true;

    if (debugMeetingId) debugMeetingId.textContent = "‚Äì";
    if (debugMotionsCount) debugMotionsCount.textContent = "0";

    validationBlock.textContent =
        "Aucune s√©ance en cours pour le moment. Cet √©cran se mettra √† jour d√®s qu'une nouvelle s√©ance sera ouverte.";

    if (signInfo) {
        signInfo.textContent = "";
        signInfo.style.color = '#6b7280';
    }

    state.meeting = null;
    state.motions = [];
    state.currentMotionId = null;

    renderCurrentMotion();
    renderAgendasAndMotions();
    updateValidationWarning();
    setNotif("", "");
}

async function refreshPresidentView() {
    if (state.loading) return;
    state.loading = true;

    try {
        const statusRes = await api("/api/v1/meeting_status.php");
        const badge = document.getElementById("meeting_badge");
        const mt = document.getElementById("meeting_title");
        const mi = document.getElementById("meeting_info");
        const btnValidate = document.getElementById("btn_validate");
        const lastValidatedBlock = document.getElementById("last_validated_block");
        const postValidationMessage = document.getElementById("post_validation_message");
        const validationBlock = document.getElementById("validation_block");
        const debugMeetingId = document.getElementById("debug_meeting_id");
        const debugMotionsCount = document.getElementById("debug_motions_count");
        const signInfo = document.getElementById("sign_status_info");

        state.lastRefresh = new Date();
        const lr = document.getElementById('last_refresh');
        if (lr) lr.textContent = state.lastRefresh.toLocaleTimeString();

        if (!statusRes.body || !statusRes.body.ok) {
            if (statusRes.body && statusRes.body.error === 'no_live_meeting') {
                handleNoLiveMeeting();
        loadMotionsOverview(null);
                state.loading = false;
                return;
            }
            setNotif('error', "Erreur statut s√©ance : " + (statusRes.body && statusRes.body.error || statusRes.status));
            state.loading = false;
            return;
        }

        const s = statusRes.body.data;
        state.meeting = s;
        loadMotionsOverview(state.meeting?.id);

        // Archiv√©e c√¥t√© back ? (normalement meeting_status n'en renvoie pas, mais on garde la s√©curit√©)
        if (s.meeting_status === 'archived' || s.archived_at) {
            state.lastValidated = {
                meeting_id: s.meeting_id,
                title: s.meeting_title || "S√©ance",
                validated_by: s.validated_by || "Pr√©sident",
                validated_at: s.validated_at || s.archived_at || new Date().toISOString()
            };
            handleNoLiveMeeting(`Derni√®re s√©ance (statut : ${s.meeting_status}). En attente d'une nouvelle s√©ance.`);
            state.loading = false;
            return;
        }

        if (debugMeetingId) debugMeetingId.textContent = s.meeting_id || "‚Äì";

        let badgeText = "";
        let badgeClass = "unknown";

        if (s.meeting_status === 'live') {
            badgeText = "en s√©ance";
            badgeClass = "live";
        } else if (s.meeting_status === 'closed') {
            badgeText = "cl√¥tur√©e";
            badgeClass = "closed";
        } else {
            badgeText = s.meeting_status || "en pr√©paration";
            badgeClass = "unknown";
        }

        badge.className = "badge " + badgeClass;
        badge.textContent = badgeText;

        mt.textContent = s.meeting_title || "S√©ance sans titre";

        const infoParts = [];
        if (s.meeting_status) {
            infoParts.push(`Statut : ${s.meeting_status}`);
        }
        if (s.started_at) {
            const started = new Date(s.started_at);
            const now = new Date();
            const diffMinutes = Math.floor((now - started) / 60000);
            infoParts.push(`D√©but : ${started.toLocaleTimeString()} (il y a ${diffMinutes} min)`);
        }
        if (s.meeting_id) {
            infoParts.push(`ID : ${s.meeting_id.substring(0, 8)}...`);
        }
        mi.textContent = infoParts.join(" ‚Ä¢ ");

        // Statut de signature (ready_to_sign / missing_tally / open_motions / archived)
        if (signInfo) {
            signInfo.textContent = s.sign_message || '';
            if (s.sign_status === 'ready') {
                signInfo.style.color = '#16a34a';
            } else if (s.sign_status === 'missing_tally' || s.sign_status === 'open_motions') {
                signInfo.style.color = '#b45309';
            } else {
                signInfo.style.color = '#6b7280';
            }
        }

        lastValidatedBlock.style.display = 'none';
        postValidationMessage.style.display = 'none';

        validationBlock.textContent =
            "S√©ance en cours (ou en pr√©paration). Vous pourrez la signer une fois toutes les r√©solutions cl√¥tur√©es et compt√©es.";

        const motionsRes = await api("/api/v1/motions_for_meeting.php?meeting_id=" + encodeURIComponent(s.meeting_id));
        if (!motionsRes.body || !motionsRes.body.ok) {
            setNotif('error', "Erreur chargement r√©solutions : " + (motionsRes.body && motionsRes.body.error || motionsRes.status));
            state.motions = [];
            state.currentMotionId = null;
            if (debugMotionsCount) debugMotionsCount.textContent = '0';
        } else {
            state.motions = motionsRes.body.data.motions || [];
            state.currentMotionId = motionsRes.body.data.current_motion_id || null;
            if (debugMotionsCount) debugMotionsCount.textContent = state.motions.length;
        }

        renderCurrentMotion();
        renderAgendasAndMotions();
        updateValidationWarning();

        const btnReport = document.getElementById("btn_report");
        const isArchived = (state.meeting && (state.meeting.meeting_status === 'archived' || state.meeting.archived_at));
        btnValidate.disabled = isArchived;
        if (btnReport) btnReport.disabled = !isArchived;
        setNotif('', '');
    } catch (e) {
        setNotif('error', "Erreur r√©seau : " + e.message);
    } finally {
        state.loading = false;
    }
}

function findCurrentMotion() {
    if (!state.currentMotionId) return null;
    return state.motions.find(m => m.motion_id === state.currentMotionId) || null;
}

function renderCurrentMotion() {
    const cmTitle = document.getElementById("current_motion_title");
    const cmStatus = document.getElementById("current_motion_status");
    const evoteResults = document.getElementById("evote_results");
    const noCurrentMotion = document.getElementById("no_current_motion");

    if (!state.meeting) {
        cmTitle.textContent = "Aucune r√©solution ouverte.";
        cmStatus.textContent = "";
        evoteResults.style.display = 'none';
        noCurrentMotion.style.display = 'block';
        return;
    }

    const cur = findCurrentMotion();

    if (!cur) {
        cmTitle.textContent = "Aucune r√©solution ouverte.";
        cmStatus.textContent = "";
        evoteResults.style.display = 'none';
        noCurrentMotion.style.display = 'block';
        return;
    }

    cmTitle.textContent = cur.motion_title || "(sans titre)";
    noCurrentMotion.style.display = 'none';

    const s = motionState(cur);
    let statusText = "";
    let statusClass = "statut-draft";

    if (s === 'open') {
        statusText = "üü¢ Vote en cours";
        statusClass = "statut-open";
    } else if (s === 'closed') {
        if (cur.decision === 'adopted') {
            statusText = "‚úÖ Adopt√©e";
            statusClass = "statut-closed-adopted";
        } else if (cur.decision === 'rejected') {
            statusText = "‚ùå Rejet√©e";
            statusClass = "statut-closed-rejected";
        } else {
            statusText = "üî¥ Cl√¥tur√©e";
            statusClass = "statut-draft";
        }
    } else {
        statusText = "üìù Brouillon";
        statusClass = "statut-draft";
    }

    let extra = "";
    if (cur.opened_at) {
        const opened = new Date(cur.opened_at);
        const now = new Date();
        const diffMinutes = Math.floor((now - opened) / 60000);
        extra = `‚Ä¢ Ouverte il y a ${diffMinutes} min`;
    }
    if (cur.closed_at) {
        const closed = new Date(cur.closed_at);
        extra = `‚Ä¢ Cl√¥tur√©e √† ${closed.toLocaleTimeString()}`;
    }

    cmStatus.textContent = `${statusText} ${extra}`;
    cmStatus.className = `statut-line ${statusClass}`;

    if (cur.evote_results) {
        evoteResults.style.display = 'block';
        refreshCurrentMotionResults(cur);
    } else {
        evoteResults.style.display = 'none';
    }
}

function refreshCurrentMotionResults(motion) {
    if (!motion.evote_results) return;
    
    const results = motion.evote_results;
    
    document.getElementById('cm_for_count').textContent = results.for?.count ?? 0;
    document.getElementById('cm_for_weight').textContent = results.for?.weight ?? 0;
    document.getElementById('cm_against_count').textContent = results.against?.count ?? 0;
    document.getElementById('cm_against_weight').textContent = results.against?.weight ?? 0;
    document.getElementById('cm_abstain_count').textContent = results.abstain?.count ?? 0;
    document.getElementById('cm_abstain_weight').textContent = results.abstain?.weight ?? 0;
    
    const decisionLine = document.getElementById("cm_decision_line");
    if (decisionLine) {
        let decisionText = "";
        if (results.decision) {
            decisionText = `D√©cision : ${decisionLabel(results.decision.status)}`;
            if (results.decision.reason) {
                decisionText += ` (${results.decision.reason})`;
            }
        } else {
            decisionText = "D√©cision en attente...";
        }
        decisionLine.textContent = decisionText;
    }
    
    const quorumStatus = document.getElementById('cm_quorum_status');
    const quorumRatio = document.getElementById('cm_quorum_ratio');
    const quorumThreshold = document.getElementById('cm_quorum_threshold');

    if (results.quorum) {
        quorumStatus.textContent = results.quorum.met ? "Atteint ‚úì" : "Non atteint ‚úó";
        quorumRatio.textContent = (results.quorum.ratio ?? '‚Äî');
        quorumThreshold.textContent = (results.quorum.threshold ?? '‚Äî');
    } else {
        quorumStatus.textContent = "‚Äî";
        quorumRatio.textContent = "‚Äî";
        quorumThreshold.textContent = "‚Äî";
    }
}

function renderAgendasAndMotions() {
    const box = document.getElementById("agendas_motions_list");
    const noMotions = document.getElementById("no_motions");
    
    box.innerHTML = "";

    if (!state.meeting) {
        box.style.display = 'none';
        noMotions.style.display = 'block';
        noMotions.textContent = "Aucune s√©ance en cours.";
        return;
    }

    if (!state.motions.length) {
        box.style.display = 'none';
        noMotions.style.display = 'block';
        noMotions.textContent = "Aucune r√©solution d√©finie pour cette s√©ance.";
        return;
    }

    noMotions.style.display = 'none';
    box.style.display = 'block';

    const agendasMap = new Map();
    state.motions.forEach(m => {
        const key = m.agenda_id;
        if (!agendasMap.has(key)) {
            agendasMap.set(key, {
                agenda_id: m.agenda_id,
                agenda_title: m.agenda_title,
                agenda_idx: m.agenda_idx,
                motions: []
            });
        }
        agendasMap.get(key).motions.push(m);
    });

    const agendas = Array.from(agendasMap.values())
        .sort((a, b) => (a.agenda_idx || 0) - (b.agenda_idx || 0));

    agendas.forEach(a => {
        const wrapper = document.createElement("div");
        wrapper.className = "item";
        wrapper.style.marginBottom = "12px";

        const h = document.createElement("div");
        h.className = "agenda-title";
        h.textContent = `${a.agenda_idx}. ${a.agenda_title}`;
        wrapper.appendChild(h);

        const motionsBox = document.createElement("div");
        motionsBox.style.marginLeft = "4px";

        a.motions.forEach(motion => {
            const line = document.createElement("div");
            line.className = "motion-line";
            
            if (state.currentMotionId && state.currentMotionId === motion.motion_id) {
                line.classList.add("current");
            }

            const titleSpan = document.createElement("span");
            titleSpan.textContent = motion.motion_title || "(sans titre)";
            
            const badge = motionStatusBadge(motion);
            line.appendChild(titleSpan);
            line.appendChild(badge);

            const statusPieces = [];
            const st = motionState(motion);

            if (st === 'open') {
                statusPieces.push("Vote en cours");
            } else if (st === 'closed') {
                statusPieces.push("Vote cl√¥tur√©");
            } else {
                statusPieces.push("Brouillon");
            }

            if (st === 'closed') {
                if (motion.tally_status === 'done') {
                    statusPieces.push("Comptage enregistr√©");
                } else {
                    statusPieces.push("Comptage en attente");
                }
            }

            if (motion.decision) {
                statusPieces.push("D√©cision : " + decisionLabel(motion.decision));
            }

            if (statusPieces.length) {
                const infoSpan = document.createElement("span");
                infoSpan.className = "muted";
                infoSpan.style.fontSize = "11px";
                infoSpan.style.marginLeft = "6px";
                infoSpan.textContent = " - " + statusPieces.join(" ‚Ä¢ ");
                line.appendChild(infoSpan);
            }
            
            motionsBox.appendChild(line);
        });

        wrapper.appendChild(motionsBox);
        box.appendChild(wrapper);
    });
}

function updateValidationWarning() {
    const warningDiv = document.getElementById("validation_warning");
    const btnValidate = document.getElementById("btn_validate");

    if (!state.meeting || !state.motions.length) {
        warningDiv.classList.remove("show");
        btnValidate.classList.remove("warning");
        btnValidate.textContent = "Valider la s√©ance";
        return;
    }

    const m = state.meeting;
    const open = (m.open_motions !== undefined) ? m.open_motions : state.motions.filter(x => motionState(x) === 'open').length;
    const missing = m.closed_without_tally !== undefined ? m.closed_without_tally : 0;
    const ready = !!m.ready_to_sign;

    if (ready) {
        warningDiv.classList.remove("show");
        btnValidate.classList.remove("warning");
        btnValidate.textContent = "Signer la s√©ance";
        return;
    }

    if (open > 0) {
        warningDiv.textContent = `‚ö†Ô∏è ${open} r√©solution(s) encore ouverte(s). Voulez-vous vraiment signer la s√©ance ?`;
        warningDiv.classList.add("show");
        btnValidate.classList.add("warning");
        btnValidate.textContent = `Signer quand m√™me (${open} ouverte(s))`;
        return;
    }

    if (missing > 0) {
        warningDiv.textContent = `‚ö†Ô∏è ${missing} r√©solution(s) cl√¥tur√©e(s) sans comptage complet. Voulez-vous vraiment signer la s√©ance ?`;
        warningDiv.classList.add("show");
        btnValidate.classList.add("warning");
        btnValidate.textContent = `Signer quand m√™me (${missing} non compt√©e(s))`;
        return;
    }

    warningDiv.classList.remove("show");
    btnValidate.classList.remove("warning");
    btnValidate.textContent = "Signer la s√©ance";
}

function openMeetingReport() {
    if (!state.meeting || !state.meeting.meeting_id) return;
    const key = (document.getElementById("api_key")?.value || "").trim();
    const url = `/api/v1/meeting_report.php?meeting_id=${encodeURIComponent(state.meeting.meeting_id)}&api_key=${encodeURIComponent(key)}`;
    window.open(url, "_blank");
}

async function validateMeeting() {
    const inputName = document.getElementById("president_name");
    const btnValidate = document.getElementById("btn_validate");
    const selPres = document.getElementById("president_select");
    const warningDiv = document.getElementById("validation_warning");

    let name = inputName.value.trim();
    if (!state.meeting) {
        setNotif('error', "Aucune s√©ance √† valider.");
        return;
    }

    const open = (state.meeting.open_motions !== undefined)
        ? state.meeting.open_motions
        : state.motions.filter(m => motionState(m) === 'open').length;

    if (open > 0) {
        if (!confirm(`Il reste ${open} r√©solution(s) ouverte(s). Voulez-vous vraiment signer la s√©ance ?`)) {
            return;
        }
    }

    if (!name && selPres && selPres.value) {
        const chosen = state.presidents.find(p => p.id === selPres.value);
        if (chosen) {
            name = chosen.full_name;
            inputName.value = name;
            state.currentPresidentMemberId = chosen.id;
        }
    }

    if (!name) {
        setNotif('error', "Veuillez s√©lectionner un Pr√©sident ou renseigner un nom.");
        return;
    }

    btnValidate.disabled = true;
    const btnReport = document.getElementById("btn_report");
    if (btnReport) btnReport.disabled = true;
    warningDiv.classList.remove("show");
    setNotif('', '');

    const payload = {
        meeting_id: state.meeting.meeting_id,
        president_name: name,
        president_source: state.currentPresidentMemberId ? 'db' : 'temp'
    };
    if (state.currentPresidentMemberId) {
        payload.president_member_id = state.currentPresidentMemberId;
    }

    try {
        const { status, body } = await api("/api/v1/meeting_validate.php", payload);

        if (!body || !body.ok) {
            setNotif('error', "Erreur validation s√©ance : " + (body?.error || status));
            const btnReport = document.getElementById("btn_report");
        const isArchived = (state.meeting && (state.meeting.meeting_status === 'archived' || state.meeting.archived_at));
        btnValidate.disabled = isArchived;
        if (btnReport) btnReport.disabled = !isArchived;
            return;
        }

        const m = body.meeting || (body.data && body.data.meeting) || body.data;

        state.lastValidated = {
            meeting_id: m.id,
            title: m.title,
            validated_by: m.president_name || "Pr√©sident",
            validated_at: m.validated_at
        };

        setNotif('success', `S√©ance valid√©e avec succ√®s par ${state.lastValidated.validated_by}.`);
        document.getElementById('post_validation_message').style.display = 'block';

        renderLastValidatedBlock();

        state.meeting = null;
        state.motions = [];
        state.currentMotionId = null;
        
        renderCurrentMotion();
        renderAgendasAndMotions();
        updateValidationWarning();
        
        btnValidate.disabled = true;
    const btnReport = document.getElementById("btn_report");
    if (btnReport) btnReport.disabled = true;
        
        setTimeout(refreshPresidentView, 1000);
        
    } catch (error) {
        setNotif('error', "Erreur r√©seau lors de la validation : " + error.message);
        const btnReport = document.getElementById("btn_report");
        const isArchived = (state.meeting && (state.meeting.meeting_status === 'archived' || state.meeting.archived_at));
        btnValidate.disabled = isArchived;
        if (btnReport) btnReport.disabled = !isArchived;
    }
}

document.addEventListener("DOMContentLoaded", () => {
    loadPresidents();
    refreshPresidentView();
    
    setInterval(refreshPresidentView, 3000);
    
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            refreshPresidentView();
        }
    });
});
</script>


</body>
</html>