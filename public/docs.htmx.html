<!doctype html>
<html lang="fr" data-page-role="viewer">
<head>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Documentation - AG-VOTE">
  <title>Documentation — AG-VOTE</title>
  <link rel="stylesheet" href="/assets/css/app.css">
  <link rel="stylesheet" href="/assets/css/doc.css">
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
</head>
<body>
  <div class="app-shell">
    <aside class="app-sidebar" data-include-sidebar data-page="help"></aside>

    <div class="doc-page-header">
      <div class="doc-breadcrumb">
        <a href="/help.htmx.html">Aide</a>
        <svg class="icon icon-xs" aria-hidden="true"><use href="/assets/icons.svg#icon-chevron-right"></use></svg>
        <span id="breadcrumbDir" style="display:none"></span>
        <svg class="icon icon-xs" id="breadcrumbDirSep" aria-hidden="true" style="display:none"><use href="/assets/icons.svg#icon-chevron-right"></use></svg>
        <span id="breadcrumbCurrent">Documentation</span>
      </div>
      <h1 id="docTitle">Documentation</h1>
    </div>

    <main class="app-main doc-main">
      <div class="doc-layout">
        <!-- LEFT: Doc Index -->
        <aside class="doc-sidebar">
          <nav class="doc-index" id="docIndex" aria-label="Index des documents">
            <h4>Documentation</h4>
            <div class="text-muted text-sm" style="padding:0.5rem">Chargement...</div>
          </nav>
        </aside>

        <!-- CENTER: rendered Markdown -->
        <article class="doc-content prose" id="docContent">
          <div style="text-align:center;padding:3rem;color:var(--color-text-muted)">Chargement du document...</div>
        </article>

        <!-- RIGHT: Table of Contents (sticky) -->
        <aside class="doc-toc-rail" id="docTocRail" aria-label="Sommaire" style="display:none">
          <nav class="doc-toc">
            <h4>Sommaire</h4>
            <ul id="tocList"></ul>
          </nav>
        </aside>
      </div>
    </main>
  </div>

  <!-- Drawer -->
  <div id="drawerOverlay" class="drawer-backdrop" data-drawer-close></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <div id="drawerTitle" class="font-semibold">Menu</div>
      <button class="btn btn-ghost btn-icon btn-sm" type="button" data-drawer-close title="Fermer">&#10005;</button>
    </div>
    <div id="drawerBody" class="drawer-body"></div>
  </aside>

  <script type="module" src="/assets/js/components/index.js"></script>
  <script src="/assets/js/core/utils.js"></script>
  <script src="/assets/js/core/shared.js"></script>
  <script src="/assets/js/core/shell.js"></script>
  <script src="/assets/js/services/meeting-context.js"></script>

  <script>
  (function() {
    'use strict';

    // =========================================================================
    // CONFIGURATION
    // =========================================================================

    var DOC_TITLES = {
      'ANALYTICS_ETHICS': 'Éthique des Analytics',
      'FAQ': 'Foire aux questions',
      'README': 'Documentation',
      'INSTALLATION': 'Guide d\'installation',
      'ARCHITECTURE': 'Architecture',
      'API': 'Documentation API',
      'SECURITY': 'Sécurité',
      'MIGRATION': 'Migration',
      'TESTS': 'Tests',
      'UTILISATION_LIVE': 'Utilisation en direct',
      'RECETTE_DEMO': 'Recette de démonstration',
      'AUDIT_RAPPORT': 'Rapport d\'audit',
      'CONFORMITE_CDC': 'Conformité au cahier des charges',
      'WEB_COMPONENTS': 'Composants Web',
      'DOCKER_INSTALL': 'Installation Docker (Linux)',
      'INSTALL_MAC': 'Installation macOS',
    };

    // =========================================================================
    // HELPERS
    // =========================================================================

    function esc(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function getDocPage() {
      var params = new URLSearchParams(window.location.search);
      var file = params.get('file') || 'docs/README.md';
      // Normalize: strip leading "docs/" and trailing ".md"
      return file.replace(/^docs\//, '').replace(/\.md$/i, '');
    }

    function getTitleFromPage(page) {
      var filename = page.split('/').pop();
      return DOC_TITLES[filename] || filename.replace(/_/g, ' ');
    }

    // =========================================================================
    // DOC INDEX (sidebar)
    // =========================================================================

    function loadDocIndex(currentPage) {
      var container = document.getElementById('docIndex');

      fetch('/api/v1/doc_index.php')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!data.ok || !data.data) throw new Error('Index unavailable');

          var html = '<h4>Documentation</h4>';
          data.data.forEach(function(cat) {
            html += '<div class="doc-index-section">';
            html += '<div class="doc-index-title">' + esc(cat.category) + '</div>';
            html += '<ul>';
            cat.items.forEach(function(item) {
              var isActive = (item.page === currentPage) ? ' class="active"' : '';
              html += '<li' + isActive + '><a href="/docs.htmx.html?file=docs/'
                + encodeURIComponent(item.page) + '.md">'
                + esc(item.label) + '</a></li>';
            });
            html += '</ul></div>';
          });
          container.innerHTML = html;
        })
        .catch(function() {
          container.innerHTML = '<h4>Documentation</h4><p class="text-muted text-sm" style="padding:0.5rem">Index non disponible</p>';
        });
    }

    // =========================================================================
    // TOC GENERATION
    // =========================================================================

    function generateTOC(contentEl) {
      var headings = contentEl.querySelectorAll('h2, h3');
      var tocRail = document.getElementById('docTocRail');
      var tocList = document.getElementById('tocList');

      if (headings.length < 3) {
        tocRail.style.display = 'none';
        return;
      }

      var html = '';
      headings.forEach(function(heading, index) {
        var id = heading.id || 'heading-' + index;
        heading.id = id;
        var cls = heading.tagName === 'H3' ? ' class="toc-sub"' : '';
        html += '<li' + cls + '><a href="#' + id + '">' + esc(heading.textContent) + '</a></li>';
      });
      tocList.innerHTML = html;
      tocRail.style.display = '';

      // Scroll spy
      var tocLinks = tocList.querySelectorAll('a');
      var headingEls = [];
      tocLinks.forEach(function(link) {
        var el = document.getElementById(link.getAttribute('href').slice(1));
        if (el) headingEls.push({ el: el, link: link });
      });

      function updateActive() {
        var scrollTop = window.scrollY + 120;
        var current = null;
        for (var i = headingEls.length - 1; i >= 0; i--) {
          if (headingEls[i].el.offsetTop <= scrollTop) {
            current = headingEls[i];
            break;
          }
        }
        tocLinks.forEach(function(l) { l.classList.remove('active'); });
        if (current) current.link.classList.add('active');
      }

      window.addEventListener('scroll', updateActive, { passive: true });
      updateActive();

      // Smooth scroll on click
      tocLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
          var target = document.getElementById(this.getAttribute('href').slice(1));
          if (target) {
            e.preventDefault();
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            history.replaceState(null, '', this.getAttribute('href'));
          }
        });
      });
    }

    // =========================================================================
    // INTERNAL LINK REWRITING
    // =========================================================================

    function rewriteLinks(contentEl, currentPage) {
      var currentDir = currentPage.split('/').slice(0, -1).join('/');

      contentEl.querySelectorAll('a').forEach(function(link) {
        var href = link.getAttribute('href');
        if (!href) return;

        // Rewrite .md links to use the viewer
        if (href.match(/\.md$/i) && !href.match(/^https?:\/\//)) {
          var resolved = href;
          if (href.startsWith('./')) {
            resolved = (currentDir ? currentDir + '/' : '') + href.substring(2);
          } else if (href.startsWith('../')) {
            var parts = currentDir ? currentDir.split('/') : [];
            parts.pop();
            resolved = (parts.length ? parts.join('/') + '/' : '') + href.substring(3);
          } else if (!href.startsWith('/') && currentDir) {
            resolved = currentDir + '/' + href;
          } else if (href.startsWith('/')) {
            resolved = href.substring(1);
          }
          // Ensure docs/ prefix for the viewer URL
          if (!resolved.startsWith('docs/')) {
            resolved = 'docs/' + resolved;
          }
          link.setAttribute('href', '/docs.htmx.html?file=' + encodeURIComponent(resolved));
          link.removeAttribute('target');
          return;
        }

        // External links open in new tab
        if (href.match(/^https?:\/\//)) {
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener');
        }
      });
    }

    // =========================================================================
    // CODE BLOCK COPY BUTTONS
    // =========================================================================

    function addCopyButtons(contentEl) {
      contentEl.querySelectorAll('pre').forEach(function(pre) {
        var wrapper = document.createElement('div');
        wrapper.className = 'code-block-wrapper';
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);

        var copyBtn = document.createElement('button');
        copyBtn.className = 'code-copy-btn';
        copyBtn.textContent = 'Copier';
        copyBtn.title = 'Copier le code';
        copyBtn.addEventListener('click', function() {
          var code = pre.querySelector('code');
          var text = code ? code.textContent : pre.textContent;
          navigator.clipboard.writeText(text).then(function() {
            copyBtn.textContent = 'Copié !';
            setTimeout(function() { copyBtn.textContent = 'Copier'; }, 2000);
          });
        });
        wrapper.appendChild(copyBtn);
      });
    }

    // =========================================================================
    // LOAD DOCUMENT
    // =========================================================================

    function loadDocument() {
      var page = getDocPage();
      var title = getTitleFromPage(page);
      var container = document.getElementById('docContent');

      // Update page chrome
      document.getElementById('docTitle').textContent = title;
      document.getElementById('breadcrumbCurrent').textContent = title;
      document.title = title + ' — Documentation AG-VOTE';

      // Show directory in breadcrumb if nested
      var dirParts = page.split('/');
      if (dirParts.length > 1) {
        document.getElementById('breadcrumbDir').textContent = dirParts.slice(0, -1).join('/');
        document.getElementById('breadcrumbDir').style.display = '';
        document.getElementById('breadcrumbDirSep').style.display = '';
      }

      // Load sidebar index
      loadDocIndex(page);

      // Fetch markdown via PHP API (reliable, no symlink dependency)
      fetch('/api/v1/doc_content.php?page=' + encodeURIComponent(page))
        .then(function(resp) {
          if (!resp.ok) {
            throw new Error(resp.status === 404
              ? 'Document non trouvé : ' + page + '.md'
              : 'Erreur serveur (' + resp.status + ')');
          }
          return resp.text();
        })
        .then(function(markdown) {
          // Render markdown with marked
          var html = marked.parse(markdown);
          container.innerHTML = '<div class="prose">' + html + '</div>';

          // Post-processing
          generateTOC(container);
          rewriteLinks(container, page);
          addCopyButtons(container);
        })
        .catch(function(err) {
          container.innerHTML =
            '<div class="doc-not-found">' +
            '<h2>Document non disponible</h2>' +
            '<p>' + esc(err.message) + '</p>' +
            '<a href="/help.htmx.html" class="btn btn-primary">Retour à l\'aide</a>' +
            '</div>';
          document.getElementById('docTocRail').style.display = 'none';
        });
    }

    // =========================================================================
    // INIT
    // =========================================================================

    loadDocument();
  })();
  </script>
</body>
</html>
