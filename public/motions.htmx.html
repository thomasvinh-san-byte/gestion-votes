<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Motions</title>
    <link rel="stylesheet" href="/assets/css/app.css">
</head>
  <body class="app-shell">
  <div class="app">
    <header class="app-header">
      <div class="header-left">
        <div class="brand">
          <strong>Gestion des votes</strong>
          <span>v1.0</span>
        </div>
      </div>

      <div class="header-center">
        <div class="page-title">R√©solutions</div>
        <div class="page-subtitle">Ordre du jour, votes & quorum</div>
      </div>

      <div class="header-right">
        <button class="icon-btn" data-drawer="readiness" title="Readiness">‚úÖ</button>
        <button class="icon-btn" data-drawer="infos" title="Informations">‚ö†Ô∏è</button>
        <button class="icon-btn" data-drawer="menu" title="Menu">‚ò∞</button>
      </div>
    </header>

    <aside class="app-sidebar">
      <div class="sidebar-inner">
        <div class="sidebar-brand">
          <div class="sidebar-brand-icon">GV</div>
          <div class="sidebar-brand-text">
            Gestion des votes
            <small>Assemblees &amp; Conseils</small>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Preparation</div>
          <nav class="nav">
            <a href="/meetings.htmx.html"><span class="ico">&#9783;</span><span class="lbl">Tableau de bord</span></a>
            <a href="/preparation.htmx.html"><span class="ico">&#9776;</span><span class="lbl">Preparation</span></a>
            <a href="/members.htmx.html"><span class="ico">&#9734;</span><span class="lbl">Membres</span></a>
            <a class="active" href="/motions.htmx.html"><span class="ico">&#9998;</span><span class="lbl">Resolutions</span></a>
          </nav>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Seance</div>
          <nav class="nav">
            <a href="/operator.htmx.html"><span class="ico">&#9881;</span><span class="lbl">Fiche seance</span></a>
            <a href="/operator_flow.htmx.html"><span class="ico">&#9654;</span><span class="lbl">Conduite live</span></a>
            <a href="/president.htmx.html"><span class="ico">&#9733;</span><span class="lbl">President</span></a>
          </nav>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Post-seance</div>
          <nav class="nav">
            <a href="/trust.htmx.html"><span class="ico">&#10003;</span><span class="lbl">Audit &amp; Trust</span></a>
            <a href="/report.htmx.html"><span class="ico">&#9993;</span><span class="lbl">Proces-verbal</span></a>
            <a href="/archives.htmx.html"><span class="ico">&#9635;</span><span class="lbl">Archives</span></a>
          </nav>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Administration</div>
          <nav class="nav">
            <a href="/admin.htmx.html"><span class="ico">&#9881;</span><span class="lbl">Parametres</span></a>
          </nav>
        </div>

        <div class="sidebar-foot">Gestion des Votes v1.0</div>
      </div>
    </aside>


    <main class="app-main">
      <div class="main-inner">

<div id="header"
  hx-get="/partials/meeting_header.htmx.html"
  hx-trigger="load"
  hx-swap="outerHTML"></div>

<div class="container" id="app">
  <div class="page-header">
    <div>
      <h1>Motions</h1>
      <div class="subline">Pr√©pare les r√©solutions avant le workflow op√©rateur.</div>
    </div>
    <div class="row">
      <button id="seedAttendBtn" class="btn">üß™ Remplir pr√©sences</button>
      <button id="addBtn" class="btn primary">‚ûï Ajouter motion</button>
    </div>
  </div>

  <div class="stack" id="list"></div>
</div>

<script src="https://unpkg.com/htmx.org@1.9.12"></script>
<script src="/assets/js/utils.js"></script>
<script src="/assets/js/auth-ui.js"></script>
<script>
(function(){
  const app = document.getElementById('app');
  const meetingId = Utils.requireMeetingId(app);
  const listEl = document.getElementById('list');
  const addBtn = document.getElementById('addBtn');
  const seedBtn = document.getElementById('seedAttendBtn');

  let votePoliciesById = {};
  let quorumPoliciesById = {};
  let meetingVotePolicyId = null;
  let meetingQuorumPolicyId = null;

  function pill(label, cls='badge'){
    return `<span class="${cls}">${Utils.escapeHtml(label)}</span>`;
  }

  async function loadPolicyMaps(){
    const [vp, qp, mv, mq] = await Promise.all([
      Utils.apiGet('/api/v1/vote_policies.php').catch(()=>({})),
      Utils.apiGet('/api/v1/quorum_policies.php').catch(()=>({})),
      Utils.apiGet('/api/v1/meeting_vote_settings.php?meeting_id='+encodeURIComponent(meetingId)).catch(()=>({})),
      Utils.apiGet('/api/v1/meeting_quorum_settings.php?meeting_id='+encodeURIComponent(meetingId)).catch(()=>({}))
    ]);
    votePoliciesById = {};
    (vp?.data?.items || vp?.items || []).forEach(p => votePoliciesById[p.id] = p);
    quorumPoliciesById = {};
    (qp?.data?.items || qp?.items || []).forEach(p => quorumPoliciesById[p.id] = p);
    meetingVotePolicyId = (mv?.data?.vote_policy_id ?? mv?.vote_policy_id ?? null);
    meetingQuorumPolicyId = (mq?.data?.quorum_policy_id ?? mq?.quorum_policy_id ?? null);
  }

  function statusBadge(m){
    const s = (m.opened_at && !m.closed_at) ? 'Ouverte' : (m.closed_at ? 'Ferm√©e' : 'Non ouverte');
    const cls = (s==='Ouverte') ? 'badge ok' : (s==='Ferm√©e' ? 'badge' : 'badge warn');
    return `<span class="${cls}">${s}</span>`;
  }

  function policyBadges(m){
    const badges = [];
    const secret = !!m.secret;
    if (secret) badges.push(pill('SECRET', 'badge danger'));

    const motionVoteId = m.vote_policy_id || null;
    const motionQuorumId = m.quorum_policy_id || null;

    const effVoteId = motionVoteId || meetingVotePolicyId;
    const effQuorumId = motionQuorumId || meetingQuorumPolicyId;

    if (effVoteId) {
      const vp = votePoliciesById[effVoteId];
      const name = vp?.name || 'Majorit√©';
      const star = motionVoteId ? '‚òÖ' : '';
      badges.push(pill(`MAJORIT√â${star}: ${name}`, motionVoteId ? 'badge warn' : 'badge'));
    }
    if (effQuorumId) {
      const qp = quorumPoliciesById[effQuorumId];
      const name = qp?.name || 'Quorum';
      const star = motionQuorumId ? '‚òÖ' : '';
      badges.push(pill(`QUORUM${star}: ${name}`, motionQuorumId ? 'badge warn' : 'badge'));
    }
    return badges.length ? `<div class="row" style="gap:6px; flex-wrap:wrap; margin-top:8px;">${badges.join('')}</div>` : '';
  }

  function render(items){
    if(!items || !items.length){
      listEl.innerHTML = '<div class="card"><div class="muted">Aucune motion.</div></div>';
      return;
    }
    listEl.innerHTML = items.map(m => `
      <div class="card">
        <div class="row space" style="flex-wrap:wrap;">
          <div class="grow">
            <div style="font-weight:700;">${Utils.escapeHtml(m.motion_title || m.title || '(sans titre)')}</div>
            <div class="muted">${Utils.escapeHtml(m.motion_description || m.description || '')}</div>
            ${policyBadges(m)}
          </div>
          ${statusBadge(m)}
        </div>
      </div>
    `).join('');
  }

  async function load(){
    listEl.innerHTML = '<div class="card"><div class="muted">Chargement‚Ä¶</div></div>';
    try {
      await loadPolicyMaps();
      const r = await Utils.apiGet('/api/v1/motions_for_meeting.php?meeting_id=' + encodeURIComponent(meetingId));
      render(r.items || r.motions || r || []);
    } catch (_) {
      listEl.innerHTML = '<div class="card"><div class="muted">Erreur chargement motions.</div></div>';
    }
  }

  addBtn.addEventListener('click', () => {
    const title = prompt('Titre de la motion ?', 'Approbation du budget');
    if(!title) return;
    const description = prompt('Description (optionnel) ?', '') || '';
    // Best-effort: some installs need agenda_id; we first try to create a default agenda,
    // then create motion with meeting_id (backend can resolve agenda).
    Utils.apiPost('/api/v1/agendas.php', { meeting_id: meetingId, title: 'R√©solutions' })
      .catch(()=>{})
      .finally(() => {
        Utils.withLoading(addBtn, Utils.apiPost('/api/v1/motions.php', { meeting_id: meetingId, title, description }))
          .then(() => { Utils.toast('Motion ajout√©e'); load(); })
          .catch(e => Utils.toast((e.data && (e.data.error||e.data.message)) || 'Erreur ajout motion', 'danger'));
      });
  });

  seedBtn.addEventListener('click', () => {
    const limit = Number(prompt('Combien de pr√©sences √† cr√©er ? (0=tous)', '0') || '0');
    Utils.withLoading(seedBtn, Utils.apiPost('/api/v1/dev_seed_attendances.php', { meeting_id: meetingId, limit }))
      .then(() => Utils.toast('Pr√©sences g√©n√©r√©es (dev)'))
      .then(load)
      .catch(() => Utils.toast('Erreur seed pr√©sences', 'danger'));
  });

  load();
})();
</script>
<script src="/assets/js/ui-states.js"></script>

      </div>
    </main>

    <div class="drawer-overlay" data-drawer-close hidden></div>
    <aside class="drawer" hidden>
      <div class="drawer-header">
        <div class="drawer-title">Panneau</div>
        <button class="icon-btn" data-drawer-close title="Fermer">‚úï</button>
      </div>
      <div class="drawer-body" id="drawerBody"></div>
    </aside>
  </div>

  <script src="/assets/js/shell.js"></script>
  <script src="/assets/js/meeting-context.js"></script>
  </body>

</html>
