<!doctype html>
<html lang="fr" data-page-role="operator">
<head>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Gestion des résolutions - AG-VOTE">
  <title>Résolutions — AG-VOTE</title>
  <link rel="stylesheet" href="/assets/css/app.css">
  <style>
    /* Page header - Diligent style */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem;
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
    }

    .page-header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0;
    }

    .page-header-subtitle {
      font-size: 0.875rem;
      color: var(--color-text-muted);
      margin-top: 0.25rem;
    }

    .page-header-actions {
      display: flex;
      gap: 0.5rem;
    }

    /* Stats bar */
    .stats-bar {
      display: flex;
      gap: 2rem;
      padding: 1rem 1.5rem;
      background: var(--color-bg-subtle);
      border-bottom: 1px solid var(--color-border);
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      text-transform: uppercase;
    }

    .stat-item.total .stat-value { color: var(--color-primary); }
    .stat-item.open .stat-value { color: var(--color-warning); }
    .stat-item.closed .stat-value { color: var(--color-success); }
    .stat-item.pending .stat-value { color: var(--color-text-muted); }

    /* Content area */
    .page-content {
      padding: 1.5rem;
    }

    /* Create card */
    .create-card {
      background: var(--color-surface);
      border: 2px dashed var(--color-border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .create-card h3 {
      margin: 0 0 1rem 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .create-form {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      align-items: end;
    }

    .create-form .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .create-form .form-group label {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      text-transform: uppercase;
    }

    .create-form .form-group.grow {
      flex: 1;
      min-width: 250px;
    }

    /* Filter tabs */
    .filter-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .filter-tab {
      padding: 0.5rem 1rem;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      background: var(--color-surface);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .filter-tab:hover {
      border-color: var(--color-primary);
    }

    .filter-tab.active {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }

    /* Section header */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--color-border);
    }

    .section-title {
      font-weight: 600;
      font-size: 1rem;
    }

    /* Motion list */
    .motion-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .motion-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.15s;
    }

    .motion-card:hover {
      border-color: var(--color-primary);
    }

    .motion-card.is-open {
      border-left: 4px solid var(--color-warning);
    }

    .motion-card.is-closed {
      border-left: 4px solid var(--color-success);
    }

    .motion-card-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem 1.25rem;
      cursor: pointer;
    }

    .motion-number {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-bg-subtle);
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .motion-card.is-open .motion-number {
      background: var(--color-warning);
      color: #fff;
    }

    .motion-card.is-closed .motion-number {
      background: var(--color-success);
      color: #fff;
    }

    .motion-info {
      flex: 1;
      min-width: 0;
    }

    .motion-title {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .motion-meta {
      font-size: 0.8rem;
      color: var(--color-text-muted);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.25rem;
    }

    .motion-actions {
      display: flex;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .motion-chevron {
      font-size: 0.85rem;
      color: var(--color-text-muted);
      transition: transform 0.2s;
    }

    .motion-card.expanded .motion-chevron {
      transform: rotate(90deg);
    }

    .motion-card-body {
      display: none;
      padding: 1rem 1.25rem;
      background: var(--color-bg-subtle);
      border-top: 1px solid var(--color-border);
    }

    .motion-card.expanded .motion-card-body {
      display: block;
    }

    .motion-description {
      color: var(--color-text-secondary);
      margin-bottom: 1rem;
    }

    /* Results inline */
    .results-inline {
      display: flex;
      gap: 1rem;
      font-size: 0.85rem;
      padding: 0.75rem 1rem;
      background: var(--color-surface);
      border-radius: 6px;
      border: 1px solid var(--color-border);
    }

    .result-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .result-item.for { color: var(--color-success); }
    .result-item.against { color: var(--color-danger); }
    .result-item.abstain { color: var(--color-text-muted); }

    .result-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .result-badge.adopted {
      background: var(--color-success-subtle);
      color: var(--color-success);
    }

    .result-badge.rejected {
      background: var(--color-danger-subtle);
      color: var(--color-danger);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: var(--color-bg-subtle);
      border-radius: 8px;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .empty-state h3 {
      margin: 0 0 0.5rem 0;
    }

    .empty-state p {
      color: var(--color-text-muted);
      margin: 0;
    }

    /* No meeting alert */
    .no-meeting-alert {
      text-align: center;
      padding: 4rem 2rem;
      background: var(--color-bg-subtle);
      border-radius: 8px;
    }

    .no-meeting-alert h3 {
      margin: 0 0 0.5rem 0;
    }

    .no-meeting-alert p {
      color: var(--color-text-muted);
      margin: 0 0 1.5rem 0;
    }

    /* Modal styles */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 100;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--color-surface);
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      z-index: 101;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--color-border);
    }

    .modal-title {
      font-weight: 600;
      font-size: 1.125rem;
      margin: 0;
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--color-border);
      background: var(--color-bg-subtle);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .form-label-required::after {
      content: ' *';
      color: var(--color-danger);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="app-sidebar" data-include-sidebar data-page="operator"></aside>

    <!-- Page header -->
    <div class="page-header">
      <div>
        <h1>Résolutions</h1>
        <div class="page-header-subtitle" id="meetingTitle">Aucune séance sélectionnée</div>
      </div>
      <div class="page-header-actions">
        <button class="btn btn-primary" id="btnAddMotion" style="display: none;">Ajouter</button>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="menu" title="Menu"></button>
      </div>
    </div>

    <!-- Stats bar -->
    <div class="stats-bar" id="statsBar" style="display: none;">
      <div class="stat-item total">
        <div class="stat-value" id="statTotal">0</div>
        <div class="stat-label">Total</div>
      </div>
      <div class="stat-item open">
        <div class="stat-value" id="statOpen">0</div>
        <div class="stat-label">En cours</div>
      </div>
      <div class="stat-item closed">
        <div class="stat-value" id="statClosed">0</div>
        <div class="stat-label">Terminés</div>
      </div>
      <div class="stat-item pending">
        <div class="stat-value" id="statPending">0</div>
        <div class="stat-label">En attente</div>
      </div>
    </div>

    <main class="app-main" style="padding: 0;">
      <div class="page-content">
        <div id="notif_box" class="alert hidden mb-4"></div>

        <!-- No meeting alert -->
        <div id="noMeetingAlert" class="no-meeting-alert" style="display: none;">
          <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
          <h3>Aucune séance sélectionnée</h3>
          <p>Sélectionnez une séance pour gérer les résolutions.</p>
          <a href="/meetings.htmx.html" class="btn btn-primary">Choisir une séance</a>
        </div>

        <!-- Main content -->
        <div id="mainContent" style="display: none;">
          <!-- Create card -->
          <div class="create-card" id="createCard">
            <h3>Nouvelle résolution</h3>
            <div class="create-form">
              <div class="form-group grow">
                <label for="quickTitle">Titre *</label>
                <input class="form-input" type="text" id="quickTitle" placeholder="Ex: Approbation du budget 2024">
              </div>
              <div class="form-group">
                <label>&nbsp;</label>
                <label class="flex items-center gap-2">
                  <input type="checkbox" id="quickSecret">
                  <span>Vote secret</span>
                </label>
              </div>
              <div class="form-group">
                <label>&nbsp;</label>
                <button class="btn btn-primary" id="btnQuickAdd">Ajouter</button>
              </div>
            </div>
          </div>

          <!-- Filter tabs -->
          <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">Toutes</button>
            <button class="filter-tab" data-filter="open">En cours</button>
            <button class="filter-tab" data-filter="closed">Terminées</button>
            <button class="filter-tab" data-filter="pending">En attente</button>
          </div>

          <!-- Section header -->
          <div class="section-header">
            <span class="section-title">Liste des résolutions</span>
            <span class="text-sm text-muted" id="motionsCount">0 résolutions</span>
          </div>

          <!-- Motions list -->
          <div class="motion-list" id="motionsList">
            <div class="text-center p-6 text-muted">Chargement...</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add Motion Modal -->
  <div class="modal-backdrop" id="modalBackdrop" style="display: none;"></div>
  <div class="modal" id="addMotionModal" style="display: none;">
    <div class="modal-header">
      <h3 class="modal-title">Nouvelle résolution</h3>
      <button class="btn btn-ghost btn-icon btn-sm" id="btnCloseModal"></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label form-label-required" for="motionTitle">Titre</label>
        <input class="form-input" type="text" id="motionTitle" placeholder="Ex: Approbation du budget 2024">
      </div>
      <div class="form-group">
        <label class="form-label" for="motionDesc">Description</label>
        <textarea class="form-input" id="motionDesc" rows="3" placeholder="Détails optionnels..."></textarea>
      </div>
      <div class="form-group">
        <label class="flex items-center gap-2">
          <input type="checkbox" id="motionSecret">
          <span>Vote secret</span>
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" id="btnCancelModal">Annuler</button>
      <button class="btn btn-primary" id="btnSaveMotion">Créer</button>
    </div>
  </div>

  <!-- Drawer -->
  <div class="drawer-backdrop" data-drawer-close></div>
  <aside class="drawer" id="drawer">
    <div class="drawer-header">
      <div id="drawerTitle" class="font-semibold">Menu</div>
      <button class="btn btn-ghost btn-icon btn-sm" type="button" data-drawer-close></button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
  </aside>

  <script src="/assets/js/utils.js"></script>
  <script src="/assets/js/shared.js"></script>
  <script src="/assets/js/shell.js"></script>
  <script src="/assets/js/meeting-context.js"></script>
  <script src="/assets/js/session-wizard.js"></script>

  <script>
  (function() {
    'use strict';

    const motionsList = document.getElementById('motionsList');
    const motionsCount = document.getElementById('motionsCount');
    const filterTabs = document.querySelectorAll('.filter-tab');
    const statsBar = document.getElementById('statsBar');
    const mainContent = document.getElementById('mainContent');
    const noMeetingAlert = document.getElementById('noMeetingAlert');
    const createCard = document.getElementById('createCard');
    const btnAddMotion = document.getElementById('btnAddMotion');

    let allMotions = [];
    let currentFilter = 'all';
    let meetingId = null;
    let isLocked = false;

    // Get meeting ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    meetingId = urlParams.get('meeting_id');

    // Check meeting context
    async function checkMeeting() {
      if (!meetingId) {
        noMeetingAlert.style.display = 'block';
        mainContent.style.display = 'none';
        statsBar.style.display = 'none';
        return false;
      }

      try {
        const { body } = await api(`/api/v1/meetings.php?meeting_id=${meetingId}`);
        if (body?.data?.meeting) {
          const meeting = body.data.meeting;
          document.getElementById('meetingTitle').textContent = meeting.title || 'Séance';

          isLocked = ['validated', 'archived'].includes(meeting.status);
          createCard.style.display = isLocked ? 'none' : 'block';
          btnAddMotion.style.display = isLocked ? 'none' : 'inline-flex';

          noMeetingAlert.style.display = 'none';
          mainContent.style.display = 'block';
          statsBar.style.display = 'flex';
          return true;
        }
      } catch (err) {
        console.error('Error loading meeting:', err);
      }

      noMeetingAlert.style.display = 'block';
      return false;
    }

    // Update stats
    function updateStats(motions) {
      const total = motions.length;
      const open = motions.filter(m => m.status === 'open').length;
      const closed = motions.filter(m => m.status === 'closed').length;
      const pending = motions.filter(m => m.status === 'pending' || m.status === 'draft').length;

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statOpen').textContent = open;
      document.getElementById('statClosed').textContent = closed;
      document.getElementById('statPending').textContent = pending;
    }

    // Filter motions
    function filterMotions(motions, filter) {
      if (filter === 'all') return motions;
      if (filter === 'open') return motions.filter(m => m.status === 'open');
      if (filter === 'closed') return motions.filter(m => m.status === 'closed');
      if (filter === 'pending') return motions.filter(m => m.status === 'pending' || m.status === 'draft');
      return motions;
    }

    // Render motions
    function renderMotions(motions) {
      const filtered = filterMotions(motions, currentFilter);
      motionsCount.textContent = `${filtered.length} résolution${filtered.length > 1 ? 's' : ''}`;

      if (!filtered.length) {
        motionsList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon"></div>
            <h3>Aucune résolution</h3>
            <p>Ajoutez des résolutions avec le formulaire ci-dessus.</p>
          </div>
        `;
        return;
      }

      motionsList.innerHTML = filtered.map((m, idx) => {
        const isOpen = m.status === 'open';
        const isClosed = m.status === 'closed';
        const cardClass = isOpen ? 'is-open' : (isClosed ? 'is-closed' : '');
        const statusBadge = isOpen
          ? '<span class="badge badge-warning badge-sm">En cours</span>'
          : (isClosed
              ? '<span class="badge badge-success badge-sm">Terminé</span>'
              : '<span class="badge badge-neutral badge-sm">En attente</span>');

        const secretBadge = m.is_secret ? '<span class="badge badge-info badge-sm">Secret</span>' : '';

        // Results display for closed motions
        let resultsHtml = '';
        if (isClosed && m.results) {
          const r = m.results;
          const outcomeClass = r.adopted ? 'adopted' : 'rejected';
          const outcomeText = r.adopted ? 'Adoptée' : 'Rejetée';
          resultsHtml = `
            <div class="results-inline">
              <div class="result-item for"><strong>${r.for || 0}</strong> Pour</div>
              <div class="result-item against"><strong>${r.against || 0}</strong> Contre</div>
              <div class="result-item abstain"><strong>${r.abstain || 0}</strong> Abstention</div>
              <span class="result-badge ${outcomeClass}">${outcomeText}</span>
            </div>
          `;
        }

        // Actions
        let actionsHtml = '';
        if (!isLocked) {
          if (!isOpen && !isClosed) {
            actionsHtml = `<button class="btn btn-sm btn-warning" onclick="openVote('${m.id}')">Ouvrir le vote</button>`;
          } else if (isOpen) {
            actionsHtml = `<button class="btn btn-sm btn-success" onclick="closeVote('${m.id}')">Clôturer</button>`;
          }
        }

        return `
          <div class="motion-card ${cardClass}" data-motion-id="${m.id}">
            <div class="motion-card-header" onclick="toggleMotion('${m.id}')">
              <div class="motion-number">${m.order_index || idx + 1}</div>
              <div class="motion-info">
                <div class="motion-title">${escapeHtml(m.title || '—')}</div>
                <div class="motion-meta">
                  ${statusBadge}
                  ${secretBadge}
                </div>
              </div>
              <div class="motion-actions">
                ${actionsHtml}
              </div>
              <span class="motion-chevron">&#9654;</span>
            </div>
            <div class="motion-card-body">
              ${m.description ? `<div class="motion-description">${escapeHtml(m.description)}</div>` : ''}
              ${resultsHtml}
              ${!isLocked && !isClosed ? `
                <div class="flex gap-2 mt-3">
                  <button class="btn btn-sm btn-danger" onclick="deleteMotion('${m.id}')">Supprimer</button>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Toggle motion card expand
    window.toggleMotion = function(motionId) {
      const card = document.querySelector(`[data-motion-id="${motionId}"]`);
      if (card) {
        card.classList.toggle('expanded');
      }
    };

    // Load motions
    async function fetchMotions() {
      motionsList.innerHTML = '<div class="text-center p-6 text-muted">Chargement...</div>';

      try {
        const { body } = await api(`/api/v1/motions_list.php?meeting_id=${meetingId}`);
        allMotions = body?.data?.motions || [];
        updateStats(allMotions);
        renderMotions(allMotions);
      } catch (err) {
        motionsList.innerHTML = `<div class="alert alert-danger">Erreur: ${escapeHtml(err.message)}</div>`;
      }
    }

    // Quick add motion
    document.getElementById('btnQuickAdd').addEventListener('click', async () => {
      const title = document.getElementById('quickTitle').value.trim();
      const is_secret = document.getElementById('quickSecret').checked;

      if (!title) {
        setNotif('error', 'Le titre est requis');
        document.getElementById('quickTitle').focus();
        return;
      }

      const btn = document.getElementById('btnQuickAdd');
      Shared.btnLoading(btn, true);

      try {
        const { body } = await api('/api/v1/motions.php', {
          meeting_id: meetingId,
          title,
          is_secret
        });

        if (body?.ok) {
          setNotif('success', 'Résolution ajoutée');
          document.getElementById('quickTitle').value = '';
          document.getElementById('quickSecret').checked = false;
          await fetchMotions();
        } else {
          setNotif('error', body?.error || 'Erreur');
        }
      } catch (err) {
        setNotif('error', err.message);
      } finally {
        Shared.btnLoading(btn, false);
      }
    });

    // Open vote
    window.openVote = async function(motionId) {
      try {
        const { body } = await api('/api/v1/motions_transition.php', {
          motion_id: motionId,
          to_status: 'open'
        });

        if (body?.ok) {
          setNotif('success', 'Vote ouvert');
          await fetchMotions();
        } else {
          setNotif('error', body?.error || 'Erreur');
        }
      } catch (err) {
        setNotif('error', err.message);
      }
    };

    // Close vote
    window.closeVote = async function(motionId) {
      try {
        const { body } = await api('/api/v1/motions_transition.php', {
          motion_id: motionId,
          to_status: 'closed'
        });

        if (body?.ok) {
          setNotif('success', 'Vote clôturé');
          await fetchMotions();
        } else {
          setNotif('error', body?.error || 'Erreur');
        }
      } catch (err) {
        setNotif('error', err.message);
      }
    };

    // Delete motion
    window.deleteMotion = async function(motionId) {
      if (!confirm('Supprimer cette résolution ?')) return;

      try {
        const { body } = await api('/api/v1/motions_delete.php', { motion_id: motionId });

        if (body?.ok) {
          setNotif('success', 'Résolution supprimée');
          await fetchMotions();
        } else {
          setNotif('error', body?.error || 'Erreur');
        }
      } catch (err) {
        setNotif('error', err.message);
      }
    };

    // Filter tabs
    filterTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        filterTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFilter = tab.dataset.filter;
        renderMotions(allMotions);
      });
    });

    // Enter key on title field
    document.getElementById('quickTitle').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('btnQuickAdd').click();
    });

    // Modal (full form)
    const modal = document.getElementById('addMotionModal');
    const backdrop = document.getElementById('modalBackdrop');

    btnAddMotion.addEventListener('click', () => {
      modal.style.display = 'block';
      backdrop.style.display = 'block';
      document.getElementById('motionTitle').focus();
    });

    function closeModal() {
      modal.style.display = 'none';
      backdrop.style.display = 'none';
      document.getElementById('motionTitle').value = '';
      document.getElementById('motionDesc').value = '';
      document.getElementById('motionSecret').checked = false;
    }

    document.getElementById('btnCloseModal').addEventListener('click', closeModal);
    document.getElementById('btnCancelModal').addEventListener('click', closeModal);
    backdrop.addEventListener('click', closeModal);

    document.getElementById('btnSaveMotion').addEventListener('click', async () => {
      const title = document.getElementById('motionTitle').value.trim();
      const description = document.getElementById('motionDesc').value.trim();
      const is_secret = document.getElementById('motionSecret').checked;

      if (!title) {
        setNotif('error', 'Le titre est requis');
        document.getElementById('motionTitle').focus();
        return;
      }

      const btn = document.getElementById('btnSaveMotion');
      Shared.btnLoading(btn, true);

      try {
        const { body } = await api('/api/v1/motions.php', {
          meeting_id: meetingId,
          title,
          description: description || null,
          is_secret
        });

        if (body?.ok) {
          setNotif('success', 'Résolution créée');
          closeModal();
          await fetchMotions();
        } else {
          setNotif('error', body?.error || 'Erreur');
        }
      } catch (err) {
        setNotif('error', err.message);
      } finally {
        Shared.btnLoading(btn, false);
      }
    });

    // Init
    checkMeeting().then(ok => {
      if (ok) fetchMotions();
    });
  })();
  </script>
</body>
</html>
