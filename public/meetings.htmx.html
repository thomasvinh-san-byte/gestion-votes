<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Tableau de bord des s√©ances - AG-VOTE">
  <title>S√©ances ‚Äî AG-VOTE</title>
  <link rel="stylesheet" href="/assets/css/app.css">
</head>
<body>
  <div class="app-shell">
        <!-- Sidebar -->
    <aside class="app-sidebar">
      <div class="p-4 border-b">
        <a href="/" class="brand">
          <span class="brand-logo">AG-VOTE</span>
        </a>
      </div>
      <nav class="nav">
        <a class="nav-item active" href="/meetings.htmx.html">
          <span class="nav-item-icon">üèõÔ∏è</span>
          <span>Tableau de bord</span>
        </a>
        <a class="nav-item" href="/operator.htmx.html">
          <span class="nav-item-icon">üóÇÔ∏è</span>
          <span>Fiche s√©ance</span>
        </a>
        <a class="nav-item" href="/members.htmx.html">
          <span class="nav-item-icon">üë•</span>
          <span>Membres</span>
        </a>
        <a class="nav-item" href="/trust.htmx.html">
          <span class="nav-item-icon">üõ°Ô∏è</span>
          <span>Contr√¥le</span>
        </a>
        <a class="nav-item" href="/archives.htmx.html">
          <span class="nav-item-icon">üìö</span>
          <span>Archives</span>
        </a>
        <div class="border-t mt-4 pt-4">
          <a class="nav-item" href="/admin.htmx.html">
            <span class="nav-item-icon">‚öôÔ∏è</span>
            <span>Administration</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Header -->
    <header class="app-header">
      <div class="flex items-center gap-4">
        <div>
          <h1 class="text-xl font-bold">S√©ances</h1>
          <p class="text-sm text-secondary">Cr√©er, ouvrir et g√©rer une s√©ance</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="readiness" title="√âtat de pr√©paration">
          ‚úÖ
        </button>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="info" title="Informations">
          ‚ÑπÔ∏è
        </button>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="menu" title="Menu">
          ‚ò∞
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
      <div class="container">
        <!-- Notification area -->
        <div id="notif_box" class="alert hidden mb-4"></div>

        <!-- Quick Actions -->
        <div class="kpi-grid mb-6">
          <div class="kpi-card">
            <div class="kpi-value primary" id="kpi_active">-</div>
            <div class="kpi-label">S√©ances actives</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value success" id="kpi_closed">-</div>
            <div class="kpi-label">S√©ances termin√©es</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value" id="kpi_draft">-</div>
            <div class="kpi-label">Brouillons</div>
          </div>
        </div>

        <!-- Actions Cards Grid -->
        <div class="grid grid-cols-2 gap-6 mb-6">
          <!-- Create Meeting Card -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">‚ûï Cr√©er une s√©ance</h3>
              <p class="card-description">Nouvelle assembl√©e g√©n√©rale ou r√©union</p>
            </div>
            <div class="card-body">
              <div class="form-group mb-4">
                <label class="form-label form-label-required" for="meeting_title">Titre</label>
                <input class="form-input" type="text" id="meeting_title" 
                       placeholder="Ex: Assembl√©e G√©n√©rale 2026">
              </div>
              <div class="form-group mb-4">
                <label class="form-label" for="meeting_desc">Description</label>
                <input class="form-input" type="text" id="meeting_desc" 
                       placeholder="Description optionnelle">
              </div>
              <button class="btn btn-primary w-full" id="create_meeting_btn">
                <span class="htmx-indicator spinner spinner-sm"></span>
                <span>Cr√©er la s√©ance</span>
              </button>
            </div>
          </div>

          <!-- Open Meeting Card -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üìÇ Ouvrir une s√©ance</h3>
              <p class="card-description">Acc√©der √† une s√©ance existante</p>
            </div>
            <div class="card-body">
              <div class="form-group mb-4">
                <label class="form-label" for="meeting_select">S√©ance active</label>
                <select class="form-input" id="meeting_select">
                  <option value="">‚Äî S√©lectionner une s√©ance ‚Äî</option>
                </select>
              </div>
              <div class="flex gap-2">
                <a class="btn btn-secondary flex-1" id="btnOpenMotions" href="/motions.htmx.html">
                  üìã R√©solutions
                </a>
                <a class="btn btn-primary flex-1" id="btnOpenOperator" href="/operator.htmx.html">
                  ‚ñ∂Ô∏è Conduire
                </a>
              </div>
              <p class="form-helper mt-3">
                üí° Les liens conservent automatiquement l'ID de s√©ance
              </p>
            </div>
          </div>
        </div>

        <!-- Meetings Lists -->
        <div class="grid grid-cols-2 gap-6">
          <!-- Active Meetings -->
          <div class="card">
            <div class="card-header flex justify-between items-center">
              <h3 class="card-title">üü¢ S√©ances actives</h3>
              <span class="badge badge-success badge-dot" id="badge_active">0</span>
            </div>
            <div class="card-body">
              <div id="active_meetings_list">
                <div class="empty-state">
                  <div class="empty-state-icon">üì≠</div>
                  <div class="empty-state-title">Aucune s√©ance active</div>
                  <div class="empty-state-description">
                    Cr√©ez une nouvelle s√©ance pour commencer
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- History -->
          <div class="card">
            <div class="card-header flex justify-between items-center">
              <h3 class="card-title">üìö Historique</h3>
              <span class="badge badge-neutral" id="badge_history">0</span>
            </div>
            <div class="card-body">
              <div id="history_meetings_list">
                <div class="empty-state">
                  <div class="empty-state-icon">üì≠</div>
                  <div class="empty-state-title">Aucune s√©ance archiv√©e</div>
                  <div class="empty-state-description">
                    Les s√©ances valid√©es appara√Ætront ici
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Debug log (hidden by default) -->
        <pre id="log_box" class="hidden mt-4 p-4 bg-surface rounded-lg text-sm font-mono overflow-auto"></pre>
      </div>
    </main>
  </div>

  <!-- Drawer Overlay -->
  <div id="drawerOverlay" class="drawer-backdrop" data-drawer-close></div>
  
  <!-- Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <div id="drawerTitle" class="font-semibold">Menu</div>
      <button class="btn btn-ghost btn-icon btn-sm" type="button" data-drawer-close title="Fermer">‚úï</button>
    </div>
    <div id="drawerBody" class="drawer-body"></div>
  </aside>

  <!-- Scripts -->
  <script src="/assets/js/utils.js"></script>
  <script src="/assets/js/shell.js"></script>

  <script>
  // Global state required by meetings.js
  var state = { meetings: [], currentMeetingId: null, currentAgendaId: null, currentMotion: null };
  // Stub for meetings.js selectMeeting ‚Üí loadAgendasAndMotions
  async function loadAgendasAndMotions() { /* no-op on this page */ }
  </script>
  <script src="/assets/js/meetings.js"></script>

  <script>
  (function() {
    'use strict';

    const sel = document.getElementById('meeting_select');
    const createBtn = document.getElementById('create_meeting_btn');
    const titleInput = document.getElementById('meeting_title');
    const descInput = document.getElementById('meeting_desc');
    const btnMotions = document.getElementById('btnOpenMotions');
    const btnOperator = document.getElementById('btnOpenOperator');

    // Navigation guard: disable links until a meeting is selected
    function setMeetingLinks(meetingId) {
      [['btnOpenMotions', '/motions.htmx.html'], ['btnOpenOperator', '/operator.htmx.html']].forEach(([id, base]) => {
        const a = document.getElementById(id);
        if (!a) return;
        if (!meetingId) {
          a.removeAttribute('href');
          a.classList.add('disabled');
          a.setAttribute('aria-disabled', 'true');
          a.style.opacity = '0.5';
          a.style.pointerEvents = 'none';
        } else {
          a.href = base + '?meeting_id=' + encodeURIComponent(meetingId);
          a.classList.remove('disabled');
          a.removeAttribute('aria-disabled');
          a.style.opacity = '';
          a.style.pointerEvents = '';
        }
      });
    }

    // Update KPIs from loaded meetings
    function updateKPIs() {
      const meetings = state.meetings || [];
      const active = meetings.filter(m => m.status === 'live' || m.status === 'scheduled').length;
      const closed = meetings.filter(m => m.status === 'closed' || m.status === 'archived').length;
      const draft = meetings.filter(m => m.status === 'draft').length;

      const kpiActive = document.getElementById('kpi_active');
      const kpiClosed = document.getElementById('kpi_closed');
      const kpiDraft = document.getElementById('kpi_draft');
      const badgeActive = document.getElementById('badge_active');
      const badgeHistory = document.getElementById('badge_history');

      if (kpiActive) kpiActive.textContent = active;
      if (kpiClosed) kpiClosed.textContent = closed;
      if (kpiDraft) kpiDraft.textContent = draft;
      if (badgeActive) badgeActive.textContent = active;
      if (badgeHistory) badgeHistory.textContent = closed;
    }

    // Handle selection change
    if (sel) {
      sel.addEventListener('change', () => {
        setMeetingLinks(sel.value);
        state.currentMeetingId = sel.value || null;
      });
    }

    // Handle create button
    if (createBtn) {
      createBtn.addEventListener('click', async () => {
        const title = (titleInput?.value || '').trim();
        const description = (descInput?.value || '').trim();

        if (!title) {
          setNotif('error', 'Le titre est requis');
          titleInput?.focus();
          return;
        }

        createBtn.classList.add('loading');
        createBtn.disabled = true;

        try {
          const { status, body } = await api('/api/v1/meetings.php', { title, description });

          if (!body || !body.ok) {
            setNotif('error', 'Erreur cr√©ation: ' + (body?.error || status));
            return;
          }

          setNotif('success', 'S√©ance cr√©√©e avec succ√®s');
          titleInput.value = '';
          descInput.value = '';

          await loadMeetings();
          updateKPIs();
          const mid = body.data?.meeting_id;
          if (mid && sel) {
            sel.value = mid;
            setMeetingLinks(mid);
          }
        } catch (err) {
          setNotif('error', 'Erreur r√©seau: ' + err.message);
        } finally {
          createBtn.classList.remove('loading');
          createBtn.disabled = false;
        }
      });
    }

    // Handle Enter key on title input
    if (titleInput) {
      titleInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') createBtn?.click();
      });
    }

    // Initial load
    setMeetingLinks(null); // disable navigation links initially
    loadMeetings().then(() => {
      updateKPIs();
      if (sel && sel.value) {
        setMeetingLinks(sel.value);
      }
    }).catch(() => {
      setNotif('error', 'Impossible de charger les s√©ances');
    });

    window.updateKPIs = updateKPIs;
  })();
  </script>
</body>
</html>