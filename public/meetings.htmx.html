<!doctype html>
<html lang="fr" data-page-role="viewer">
<head>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#1650E0" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)">
  <meta name="description" content="Gestion des séances - AG-VOTE">
  <title>Séances — AG-VOTE</title>
  <script src="/assets/js/theme-init.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,300;12..96,400;12..96,500;12..96,600;12..96,700;12..96,800&family=Fraunces:opsz,wght@9..144,600;9..144,700;9..144,800&family=JetBrains+Mono:wght@400;500;600;700&display=swap">
  <link rel="stylesheet" href="/assets/css/app.css">
  <link rel="stylesheet" href="/assets/css/meetings.css">
</head>
<body>
  <!-- Skip links for accessibility -->
  <a href="#main-content" class="skip-link">Aller au contenu principal</a>
  <a href="#main-nav" class="skip-link">Aller à la navigation</a>

  <div class="app-shell">
    <aside class="app-sidebar" data-include-sidebar data-page="meetings"></aside>

    <!-- Header -->
    <header class="app-header">
      <div class="flex items-center gap-4">
        <div>
          <h1 class="text-xl font-bold">
            <svg class="icon icon-text icon-md" aria-hidden="true"><use href="/assets/icons.svg#icon-clipboard-list"></use></svg>
            Séances
          </h1>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="context" title="Séance en cours" aria-label="Séance en cours">
          <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-menu"></use></svg>
        </button>
      </div>
    </header>

    <main class="app-main meetings-main" id="main-content" role="main">
      <!-- Stats bar -->
      <div class="stats-bar">
        <div class="stat-item live">
          <div class="stat-value" id="statLive">0</div>
          <div class="stat-label">En cours</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statScheduled">0</div>
          <div class="stat-label">Planifiées</div>
        </div>
        <div class="stat-item draft">
          <div class="stat-value" id="statDraft">0</div>
          <div class="stat-label">Brouillons</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="statResolutions">0</span>
          <span class="stat-label">Résolutions</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="statAvgParticipation">—</span>
          <span class="stat-label">Participation moy.</span>
        </div>
      </div>
      <div class="page-content">
        <div id="notif_box" class="alert hidden mb-4"></div>

        <!-- Wizard — Création de séance (5 étapes) -->
        <div class="create-card" id="wizardCard">
          <h3>
            <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-plus"></use></svg>
            Pr&eacute;parer une nouvelle s&eacute;ance
          </h3>

          <!-- Wizard stepper -->
          <div class="wiz-progress-wrap" id="wizStepper" role="list" aria-label="&Eacute;tapes de cr&eacute;ation">
            <div class="wiz-step-item active" data-step="1" role="listitem" aria-current="step">
              <span class="wiz-step-dot">1</span>
              <span class="wiz-step-label">Infos</span>
            </div>
            <div class="wiz-step-item" data-step="2" role="listitem">
              <span class="wiz-step-dot">2</span>
              <span class="wiz-step-label">Participants</span>
            </div>
            <div class="wiz-step-item" data-step="3" role="listitem">
              <span class="wiz-step-dot">3</span>
              <span class="wiz-step-label">R&eacute;solutions</span>
            </div>
            <div class="wiz-step-item" data-step="4" role="listitem">
              <span class="wiz-step-dot">4</span>
              <span class="wiz-step-label">R&eacute;cap</span>
            </div>
          </div>

          <!-- Step 1: Infos générales -->
          <div class="wiz-step-panel active" id="wizStep1" data-wiz-step="1">
            <div class="wiz-form-grid">
              <div class="form-group">
                <label class="form-label" for="meeting_title">Titre de la s&eacute;ance <span class="text-danger">*</span></label>
                <input class="form-input" type="text" id="meeting_title" placeholder="Ex : Assembl&eacute;e G&eacute;n&eacute;rale 2024" required autocomplete="off" maxlength="255">
              </div>
              <div class="form-group">
                <label class="form-label" for="meeting_date">Date <span class="text-danger">*</span></label>
                <input class="form-input date-picker-input" type="date" id="meeting_date" required>
              </div>
              <div class="form-group">
                <label class="form-label" for="wizTime">Heure <span class="text-danger">*</span></label>
                <input class="form-input" type="time" id="wizTime" value="14:00">
              </div>
              <div class="form-group">
                <label class="form-label" for="wizLieu">Lieu</label>
                <input class="form-input" type="text" id="wizLieu" placeholder="Salle du conseil, Mairie...">
              </div>
              <div class="form-group wiz-form-full">
                <label class="form-label">Type</label>
                <div class="meeting-type-chips">
                  <label class="type-chip"><input type="radio" name="meetingTypeCreate" value="ag_ordinaire" checked><span class="type-chip-label">AG ordinaire</span></label>
                  <label class="type-chip"><input type="radio" name="meetingTypeCreate" value="ag_extraordinaire"><span class="type-chip-label">AG extra.</span></label>
                  <label class="type-chip"><input type="radio" name="meetingTypeCreate" value="conseil"><span class="type-chip-label">Conseil</span></label>
                  <label class="type-chip"><input type="radio" name="meetingTypeCreate" value="bureau"><span class="type-chip-label">Bureau</span></label>
                  <label class="type-chip"><input type="radio" name="meetingTypeCreate" value="autre"><span class="type-chip-label">Autre</span></label>
                </div>
              </div>
              <div class="form-group wiz-form-full">
                <label class="form-label" for="wizQuorum">R&egrave;gle de quorum</label>
                <select class="form-input" id="wizQuorum">
                  <option value="majority">Majorit&eacute; simple (50%+1)</option>
                  <option value="two_thirds">Majorit&eacute; qualifi&eacute;e (2/3)</option>
                  <option value="unanimity">Unanimit&eacute;</option>
                </select>
              </div>
              <!-- 21-day deadline alert (shown dynamically) -->
              <div class="wiz-deadline-alert wiz-form-full" id="wizDeadlineAlert" hidden>
                <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-alert-triangle"></use></svg>
                <span>La date choisie est dans moins de 21 jours &mdash; les d&eacute;lais l&eacute;gaux de convocation pourraient ne pas &ecirc;tre respect&eacute;s.</span>
              </div>
            </div>
            <div class="wiz-nav">
              <span class="wiz-nav-hint">&Eacute;tape 1 sur 4</span>
              <button class="btn btn-primary" id="wizNext1" type="button">
                Suivant : Participants
                <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-arrow-right"></use></svg>
              </button>
            </div>
          </div>

          <!-- Step 2: Participants -->
          <div class="wiz-step-panel" id="wizStep2" data-wiz-step="2">
            <div class="wiz-form-grid">
              <div class="form-group wiz-form-full">
                <label class="form-label">Importer des participants</label>
                <div class="file-drop-zone" id="wizParticipantsDrop">
                  <input type="file" id="wizParticipantsFile" accept=".csv,.xlsx" hidden>
                  <div class="file-drop-content">
                    <svg class="icon icon-lg" aria-hidden="true"><use href="/assets/icons.svg#icon-download"></use></svg>
                    <span>Glisser-d&eacute;poser un fichier CSV/XLSX ou <button type="button" class="btn-link" id="wizParticipantsBrowse">parcourir</button></span>
                    <span class="text-xs text-muted">Format : Nom, Pr&eacute;nom, Email, Poids (optionnel)</span>
                  </div>
                </div>
              </div>
              <div class="form-group wiz-form-full">
                <label class="form-label">ou ajouter manuellement</label>
                <div class="flex gap-2">
                  <input class="form-input" type="text" id="wizParticipantName" placeholder="Nom complet">
                  <input class="form-input" type="email" id="wizParticipantEmail" placeholder="Email">
                  <button class="btn btn-secondary btn-sm" id="wizAddParticipant" type="button">
                    <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-plus"></use></svg> Ajouter
                  </button>
                </div>
              </div>
              <div class="wiz-form-full">
                <table class="wiz-participants-table" id="wizParticipantsTable">
                  <thead>
                    <tr>
                      <th>Nom</th>
                      <th>Email</th>
                      <th>Poids</th>
                      <th>Cl&eacute;</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="wizParticipantsBody">
                    <tr><td colspan="5" class="text-center text-muted p-4">Aucun participant ajout&eacute;</td></tr>
                  </tbody>
                </table>
                <div class="flex items-center gap-4 mt-3">
                  <span class="tag tag-success" id="wizParticipantsCount">0 participants</span>
                  <span class="text-xs text-muted" id="wizVoixSummary">0 voix &bull; quorum : —</span>
                </div>
              </div>
            </div>
            <div class="wiz-nav">
              <button class="btn btn-ghost" id="wizPrev2" type="button">
                <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-arrow-left"></use></svg> Retour
              </button>
              <span class="wiz-nav-hint">&Eacute;tape 2 sur 4</span>
              <button class="btn btn-primary" id="wizNext2" type="button">
                Suivant : R&eacute;solutions
                <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-arrow-right"></use></svg>
              </button>
            </div>
          </div>

          <!-- Step 3: Résolutions -->
          <div class="wiz-step-panel" id="wizStep3" data-wiz-step="3">
            <div class="wiz-form-grid">
              <div class="form-group wiz-form-full">
                <label class="form-label" for="wizResTitle">Ajouter une r&eacute;solution</label>
                <div class="flex gap-2">
                  <input class="form-input" type="text" id="wizResTitle" placeholder="Titre de la r&eacute;solution *" style="flex:2">
                  <select class="form-input" id="wizResMajority" style="flex:1">
                    <option value="simple">Majorit&eacute; simple</option>
                    <option value="qualified">2/3</option>
                    <option value="unanimity">Unanimit&eacute;</option>
                  </select>
                  <button class="btn btn-secondary btn-sm" id="wizAddResolution" type="button">
                    <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-plus"></use></svg> Ajouter
                  </button>
                </div>
              </div>
              <div class="form-group wiz-form-full">
                <label class="form-label" for="wizResDesc">Description (optionnel)</label>
                <textarea class="form-input" id="wizResDesc" rows="2" placeholder="D&eacute;tails de la r&eacute;solution..."></textarea>
              </div>
              <div class="form-group wiz-form-full">
                <div class="flex items-center gap-3">
                  <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" id="wizResSecret"> Vote secret
                  </label>
                </div>
              </div>
              <div class="wiz-form-full" id="wizResolutionsList">
                <!-- Dynamically populated resolution items -->
                <p class="text-center text-muted p-4">Aucune r&eacute;solution ajout&eacute;e</p>
              </div>
            </div>
            <div class="wiz-nav">
              <button class="btn btn-ghost" id="wizPrev3" type="button">
                <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-arrow-left"></use></svg> Retour
              </button>
              <span class="wiz-nav-hint">&Eacute;tape 3 sur 4</span>
              <button class="btn btn-primary" id="wizNext3" type="button">
                Suivant : R&eacute;capitulatif
                <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-arrow-right"></use></svg>
              </button>
            </div>
          </div>

          <!-- Step 4: Récapitulatif -->
          <div class="wiz-step-panel" id="wizStep4" data-wiz-step="4">
            <div class="wiz-recap-grid" id="wizRecapGrid">
              <div class="wiz-recap-card">
                <h4>S&eacute;ance</h4>
                <div class="wiz-recap-value" id="wizRecapTitle">—</div>
              </div>
              <div class="wiz-recap-card">
                <h4>Date &amp; heure</h4>
                <div class="wiz-recap-value" id="wizRecapDate">—</div>
              </div>
              <div class="wiz-recap-card">
                <h4>Type</h4>
                <div class="wiz-recap-value" id="wizRecapType">—</div>
              </div>
              <div class="wiz-recap-card">
                <h4>Participants</h4>
                <div class="wiz-recap-value" id="wizRecapParticipants">0</div>
              </div>
              <div class="wiz-recap-card">
                <h4>R&eacute;solutions</h4>
                <div class="wiz-recap-value" id="wizRecapResolutions">0</div>
              </div>
              <div class="wiz-recap-card">
                <h4>Quorum</h4>
                <div class="wiz-recap-value" id="wizRecapQuorum">—</div>
              </div>
            </div>

            <!-- Validation alerts -->
            <div id="wizRecapAlerts" class="mt-4"></div>

            <div class="form-group wiz-form-full mt-4">
              <label class="form-label">Pi&egrave;ces jointes PDF (optionnel)</label>
              <div class="file-drop-zone" id="fileDropZone">
                <input type="file" id="meeting_files" accept=".pdf,application/pdf" multiple hidden>
                <div class="file-drop-content">
                  <svg class="icon icon-lg" aria-hidden="true"><use href="/assets/icons.svg#icon-download"></use></svg>
                  <span>Glisser-d&eacute;poser vos PDF ici ou <button type="button" class="btn-link" id="fileBrowseBtn">parcourir</button></span>
                  <span class="text-xs text-muted">PDF uniquement, 10 Mo max par fichier</span>
                </div>
                <div class="file-list" id="fileList"></div>
              </div>
            </div>

            <div class="wiz-nav">
              <button class="btn btn-ghost" id="wizPrev4" type="button">
                <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-arrow-left"></use></svg> Retour
              </button>
              <span class="wiz-nav-hint">&Eacute;tape 4 sur 4</span>
              <button class="btn btn-primary btn-lg" id="create_meeting_btn">
                <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-check"></use></svg>
                Cr&eacute;er la s&eacute;ance
              </button>
            </div>
          </div>

          <!-- Step 5: Confirmation (shown after creation) -->
          <div class="wiz-step-panel" id="wizStep5" data-wiz-step="5">
            <div class="wiz-success">
              <div class="wiz-success-icon">
                <svg class="icon icon-lg" aria-hidden="true"><use href="/assets/icons.svg#icon-check"></use></svg>
              </div>
              <h3>S&eacute;ance cr&eacute;&eacute;e avec succ&egrave;s !</h3>
              <p>Votre s&eacute;ance a &eacute;t&eacute; enregistr&eacute;e en brouillon. Vous pouvez maintenant envoyer les convocations ou continuer la configuration.</p>
              <div class="wiz-success-links">
                <a class="btn btn-primary" id="wizGoToOperator" href="/operator.htmx.html">
                  <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-arrow-right"></use></svg>
                  Configurer la s&eacute;ance
                </a>
                <button class="btn btn-secondary" id="wizNewMeeting" type="button">
                  <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-plus"></use></svg>
                  Nouvelle s&eacute;ance
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter tabs -->
        <div class="filter-tabs">
          <button class="filter-tab active" data-filter="all">Toutes</button>
          <button class="filter-tab" data-filter="live">En cours</button>
          <button class="filter-tab" data-filter="scheduled">Planifiées</button>
          <button class="filter-tab" data-filter="draft">Brouillons</button>
          <button class="filter-tab" data-filter="archived">Archives</button>
        </div>

        <!-- Search and Sort -->
        <div class="meetings-toolbar">
          <div class="form-group form-group-search">
            <input class="form-input" type="search" id="meetingsSearch" placeholder="Rechercher par titre..." aria-label="Rechercher une séance">
          </div>
          <div class="form-group">
            <select class="form-input form-input-sm" id="meetingsSort" aria-label="Trier par">
              <option value="status">Trier par statut</option>
              <option value="date_desc">Date (récent d'abord)</option>
              <option value="date_asc">Date (ancien d'abord)</option>
              <option value="title">Titre A-Z</option>
            </select>
          </div>
        </div>

        <!-- Section header -->
        <div class="section-header">
          <span class="section-title">Liste des séances</span>
          <div class="flex items-center gap-4">
            <span class="text-sm text-muted" id="meetingsCount">0 séances</span>
            <div class="view-toggle">
              <button class="view-toggle-btn active" data-view="grid" title="Vue grille" aria-label="Vue grille">
                <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-grid"></use></svg>
              </button>
              <button class="view-toggle-btn" data-view="calendar" title="Vue calendrier" aria-label="Vue calendrier">
                <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-calendar"></use></svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Meetings grid -->
        <div class="meetings-grid" id="meetingsList">
          <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
          <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
          <div class="skeleton-row"><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div></div>
        </div>

        <!-- Pagination -->
        <div class="meetings-pagination" id="meetingsPagination"></div>

        <!-- Calendar view -->
        <div class="calendar-container" id="calendarContainer">
          <div class="calendar-header">
            <div class="calendar-nav">
              <button class="calendar-nav-btn" id="calendarPrev" title="Mois précédent">
                <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-chevron-left"></use></svg>
              </button>
              <span class="calendar-title" id="calendarTitle">Janvier 2026</span>
              <button class="calendar-nav-btn" id="calendarNext" title="Mois suivant">
                <svg class="icon" aria-hidden="true"><use href="/assets/icons.svg#icon-chevron-right"></use></svg>
              </button>
            </div>
            <button class="btn btn-sm btn-ghost calendar-today-btn" id="calendarToday">Aujourd'hui</button>
          </div>
          <div class="calendar-grid" id="calendarGrid">
            <!-- Generated by JS -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Edit meeting modal -->
  <div class="modal-backdrop" id="editMeetingModal" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
      <header class="modal-header">
        <h3 class="modal-title" id="editModalTitle">Modifier la séance</h3>
        <button class="btn btn-icon btn-ghost modal-close-btn" data-close-modal aria-label="Fermer">&times;</button>
      </header>
      <div class="modal-body">
        <input type="hidden" id="editMeetingId">
        <div class="form-group">
          <label class="form-label" for="editMeetingTitle">Titre <span class="text-danger">*</span></label>
          <input class="form-input" type="text" id="editMeetingTitle" required autocomplete="off">
        </div>
        <div class="form-group">
          <label class="form-label" for="editMeetingDate">Date</label>
          <input class="form-input date-picker-input" type="date" id="editMeetingDate">
        </div>
        <div class="form-group">
          <label class="form-label">Type</label>
          <div class="meeting-type-chips">
            <label class="type-chip"><input type="radio" name="editMeetingType" value="ag_ordinaire"><span class="type-chip-label">AG ordinaire</span></label>
            <label class="type-chip"><input type="radio" name="editMeetingType" value="ag_extraordinaire"><span class="type-chip-label">AG extra.</span></label>
            <label class="type-chip"><input type="radio" name="editMeetingType" value="conseil"><span class="type-chip-label">Conseil</span></label>
            <label class="type-chip"><input type="radio" name="editMeetingType" value="bureau"><span class="type-chip-label">Bureau</span></label>
            <label class="type-chip"><input type="radio" name="editMeetingType" value="autre"><span class="type-chip-label">Autre</span></label>
          </div>
        </div>
      </div>
      <footer class="modal-footer">
        <button class="btn btn-secondary" data-close-modal>Annuler</button>
        <button class="btn btn-primary" id="editMeetingSaveBtn">
          <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-check"></use></svg>
          Enregistrer
        </button>
      </footer>
    </div>
  </div>

  <!-- Delete meeting confirmation modal -->
  <div class="modal-backdrop" id="deleteMeetingModal" hidden>
    <div class="modal modal-sm" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle">
      <header class="modal-header">
        <h3 class="modal-title" id="deleteModalTitle">Supprimer la séance</h3>
        <button class="btn btn-icon btn-ghost modal-close-btn" data-close-modal aria-label="Fermer">&times;</button>
      </header>
      <div class="modal-body">
        <p>Êtes-vous sûr de vouloir supprimer cette séance ?</p>
        <p class="text-sm text-muted">Cette action est irréversible. Seules les séances en brouillon peuvent être supprimées.</p>
        <p class="font-semibold mt-2" id="deleteMeetingName"></p>
        <input type="hidden" id="deleteMeetingId">
      </div>
      <footer class="modal-footer">
        <button class="btn btn-secondary" data-close-modal>Annuler</button>
        <button class="btn btn-danger" id="deleteMeetingConfirmBtn">
          <svg class="icon icon-text" aria-hidden="true"><use href="/assets/icons.svg#icon-trash"></use></svg>
          Supprimer
        </button>
      </footer>
    </div>
  </div>

  <!-- Drawer -->
  <div class="drawer-backdrop" data-drawer-close aria-hidden="true"></div>
  <aside class="drawer" id="drawer" role="dialog" aria-modal="true" aria-labelledby="drawerTitle" aria-hidden="true">
    <header class="drawer-header">
      <button data-drawer-close class="btn btn-icon btn-ghost" aria-label="Fermer le panneau">✕</button>
      <h2 class="drawer-title" id="drawerTitle">Menu</h2>
    </header>
    <div class="drawer-body" id="drawerBody"></div>
  </aside>

  <script src="/assets/js/core/utils.js"></script>
  <script type="module" src="/assets/js/components/index.js"></script>
  <script src="/assets/js/core/shared.js"></script>
  <script src="/assets/js/core/shell.js"></script>
  <script src="/assets/js/services/meeting-context.js"></script>
  <script src="/assets/js/core/page-components.js"></script>
  <script src="/assets/js/pages/meetings.js"></script>
</body>
</html>
