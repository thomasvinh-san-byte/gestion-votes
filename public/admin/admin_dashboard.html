<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Tableau de bord — Archives des séances</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    :root {
        --primary: #2563eb;
        --bg: #f3f4f6;
        --muted: #6b7280;
    }
    * { box-sizing: border-box; }
    body {
        margin: 0;
        padding: 20px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg);
        color: #111827;
    }
    h1 { margin-top: 0; }
    .layout {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: 1.1fr 1.9fr;
        gap: 20px;
    }
    .card {
        background: white;
        border-radius: 10px;
        padding: 16px 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,.08);
        margin-bottom: 16px;
    }
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .section-title {
        font-size: 15px;
        font-weight: 600;
    }
    .muted {
        color: var(--muted);
        font-size: 13px;
    }
    .list {
        margin-top: 8px;
        max-height: 260px;
        overflow-y: auto;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        padding: 6px;
    }
    .item {
        padding: 6px 8px;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
    }
    .item:hover {
        background: #e5e7eb;
    }
    .item.selected {
        background: #dbeafe;
        border-left: 4px solid var(--primary);
    }
    .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #e5e7eb;
        color: #4b5563;
        margin-left: 4px;
    }
    .badge.closed {
        background: #fee2e2;
        color: #b91c1c;
    }
    .badge.archived {
        background: #e5e7eb;
        color: #6b7280;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    th, td {
        padding: 6px 8px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
    }
    th {
        background: #f3f4f6;
        font-weight: 600;
    }
    .notif {
        max-width: 1200px;
        margin: 0 auto 12px auto;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 13px;
        display: none;
    }
    .notif.error {
        display: block;
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
    }
    .filters {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }
    .filters input {
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        font-size: 13px;
        background: #f9fafb;
    }
    .filters button {
        padding: 6px 10px;
        border-radius: 6px;
        border: none;
        background: var(--primary);
        color: white;
        font-size: 12px;
        cursor: pointer;
    }
    .filters button:hover {
        background: #1d4ed8;
    }
    .export-buttons {
        display: flex;
        gap: 6px;
    }
    .export-buttons button {
        padding: 4px 8px;
        border-radius: 6px;
        border: none;
        background: #e5e7eb;
        color: #374151;
        font-size: 11px;
        cursor: pointer;
    }
    .export-buttons button:hover {
        background: #d1d5db;
    }
</style>
  <link rel="stylesheet" href="/assets/css/app.css">
</head>
<body>

<h1>Tableau de bord — Archives des séances</h1>
<p class="muted">
    Visualisez les séances clôturées/archivées, leurs résolutions, les résultats de vote et le journal d’audit.
</p>

<div id="notif_box" class="notif"></div>

<div class="layout">
    <!-- Colonne gauche : liste des séances archivées -->
    <div class="card">
        <div class="card-header">
            <span class="section-title">Séances archivées</span>
        </div>

        <div class="filters">
            <span class="muted">Période :</span>
            <input type="date" id="filter_from">
            <span class="muted">au</span>
            <input type="date" id="filter_to">
            <button onclick="applyFilters()">Filtrer</button>
        </div>

        <div class="export-buttons" style="margin-top:6px;">
            <button onclick="exportArchiveJSON()">Exporter liste (JSON)</button>
            <button onclick="exportArchiveCSV()">Exporter liste (CSV)</button>
        </div>

        <div id="meetings_list" class="list" style="margin-top:8px;"></div>
    </div>

    <!-- Colonne droite : détails séance -->
    <div>
        <div class="card">
            <div class="section-title">Détails de la séance</div>
            <div id="meeting_details" class="muted">
                Sélectionnez une séance pour voir les détails.
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="section-title">Statistiques de vote</span>
                <div class="export-buttons">
                    <button onclick="exportStatsJSON()">Stats JSON</button>
                    <button onclick="exportStatsCSV()">Stats CSV</button>
                </div>
            </div>
            <div id="meeting_stats_block" class="muted">
                (aucune donnée)
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="section-title">Journal d’audit</span>
                <div class="export-buttons">
                    <button onclick="exportAuditJSON()">Audit JSON</button>
                </div>
            </div>
            <div id="meeting_audit_block" class="muted" style="max-height:200px;overflow-y:auto;white-space:pre-wrap;">
                (aucun événement)
            </div>
        </div>
    </div>
</div>

<script>
let archiveState = {
    meetings: [],
    selectedId: null,
    lastStats: null,
    lastAudit: null,
};

function setNotif(type, message) {
    const box = document.getElementById("notif_box");
    if (!message) {
        box.style.display = 'none';
        box.textContent = '';
        box.className = 'notif';
        return;
    }
    box.textContent = message;
    box.className = 'notif ' + type;
}

async function api(url) {
    const res = await fetch(url);
    const body = await res.json().catch(() => null);
    return { status: res.status, body };
}

function buildArchiveUrl() {
    const from = document.getElementById("filter_from").value;
    const to   = document.getElementById("filter_to").value;
    const params = [];
    if (from) params.push("from=" + encodeURIComponent(from));
    if (to)   params.push("to="   + encodeURIComponent(to));
    const qs = params.length ? "?" + params.join("&") : "";
    return "/api/v1/meetings_archive.php" + qs;
}

async function loadArchiveMeetings() {
    const url = buildArchiveUrl();
    const { status, body } = await api(url);
    if (!body || !body.ok) {
        setNotif('error', "Erreur chargement archive : " + (body?.error || status));
        archiveState.meetings = [];
        renderMeetingsList();
        return;
    }
    archiveState.meetings = body.data.meetings || [];
    setNotif('', '');
    renderMeetingsList();
}

function applyFilters() {
    archiveState.selectedId = null;
    archiveState.lastStats = null;
    archiveState.lastAudit = null;
    document.getElementById("meeting_details").textContent = "Sélectionnez une séance pour voir les détails.";
    document.getElementById("meeting_stats_block").textContent = "(aucune donnée)";
    document.getElementById("meeting_audit_block").textContent = "(aucun événement)";
    loadArchiveMeetings();
}

function renderMeetingsList() {
    const div = document.getElementById("meetings_list");
    div.innerHTML = "";

    if (!archiveState.meetings.length) {
        div.textContent = "Aucune séance clôturée/archivée pour cette période.";
        return;
    }

    archiveState.meetings.forEach(m => {
        const el = document.createElement("div");
        el.className = "item" + (m.id === archiveState.selectedId ? " selected" : "");
        el.onclick = () => selectMeeting(m.id);

        let html = `<strong>${m.title}</strong>`;
        html += ` <span class="badge ${m.status === 'archived' ? 'archived' : 'closed'}">${m.status}</span>`;
        html += `<br><span class="muted">${new Date(m.created_at).toLocaleString()}</span>`;

        if (m.validated_by) {
            html += `<br><span class="muted">Validée par ${m.validated_by} le ${new Date(m.validated_at).toLocaleString()}</span>`;
        }

        el.innerHTML = html;
        div.appendChild(el);
    });
}

async function selectMeeting(meetingId) {
    archiveState.selectedId = meetingId;
    renderMeetingsList();

    setNotif('', '');
    await Promise.all([
        loadMeetingDetails(meetingId),
        loadMeetingStats(meetingId),
        loadMeetingAudit(meetingId),
    ]);
}

async function loadMeetingDetails(meetingId) {
    const meeting = archiveState.meetings.find(m => m.id === meetingId);
    const box = document.getElementById("meeting_details");

    if (!meeting) {
        box.textContent = "Séance introuvable.";
        return;
    }

    let html = `<div><strong>${meeting.title}</strong> <span class="badge">${meeting.status}</span></div>`;
    html += `<div class="muted">ID : ${meeting.id}</div>`;
    html += `<div class="muted">Créée le ${new Date(meeting.created_at).toLocaleString()}</div>`;

    if (meeting.validated_by) {
        html += `<div class="muted">Validée par ${meeting.validated_by} le ${new Date(meeting.validated_at).toLocaleString()}</div>`;
    } else {
        html += `<div class="muted">Non validée</div>`;
    }

    box.innerHTML = html;
}

async function loadMeetingStats(meetingId) {
    const box = document.getElementById("meeting_stats_block");
    box.textContent = "Chargement des statistiques…";

    const { status, body } = await api("/api/v1/meeting_stats.php?meeting_id=" + encodeURIComponent(meetingId));
    if (!body || !body.ok) {
        box.textContent = "Erreur chargement stats : " + (body?.error || status);
        archiveState.lastStats = null;
        return;
    }

    const d = body.data;
    archiveState.lastStats = d;

    let html = "";
    html += `<div class="muted">Nombre de résolutions : <strong>${d.motions_count}</strong></div>`;
    html += `<div class="muted">Nombre de votants distincts : <strong>${d.distinct_voters}</strong></div>`;

    if (!d.motions.length) {
        html += `<p class="muted" style="margin-top:8px;">Aucun vote enregistré pour cette séance.</p>`;
        box.innerHTML = html;
        return;
    }

    html += `<table style="margin-top:8px;">
        <thead>
            <tr>
                <th>Résolution</th>
                <th>Total</th>
                <th>Pour</th>
                <th>Contre</th>
                <th>Abstention</th>
                <th>NSP</th>
                <th>Source</th>
            </tr>
        </thead>
        <tbody>
    `;

    d.motions.forEach(m => {
        const source = m.tally_source || 'ballots';
        let sourceLabel = '';
        if (source === 'manual') {
            sourceLabel = '<span class="muted">(manuelle)</span>';
        } else {
            sourceLabel = ''; // "(bulletins)" si tu veux l'afficher
        }

        html += `<tr>
            <td>${m.title}</td>
            <td>${m.total}</td>
            <td>${m.votes_for}</td>
            <td>${m.votes_against}</td>
            <td>${m.votes_abstain}</td>
            <td>${m.votes_nsp}</td>
            <td>${sourceLabel}</td>
        </tr>`;
    });

    html += `</tbody></table>`;
    box.innerHTML = html;
}

async function loadMeetingAudit(meetingId) {
    const box = document.getElementById("meeting_audit_block");
    box.textContent = "Chargement du journal…";

    const { status, body } = await api("/api/v1/meeting_audit.php?meeting_id=" + encodeURIComponent(meetingId));
    if (!body || !body.ok) {
        box.textContent = "Erreur chargement audit : " + (body?.error || status);
        archiveState.lastAudit = null;
        return;
    }

    const events = body.data.events || [];
    archiveState.lastAudit = events;

    if (!events.length) {
        box.textContent = "(aucun événement)";
        return;
    }

    let text = "";
    events.forEach(ev => {
        const t = new Date(ev.created_at).toLocaleString();
        text += `[${t}] ${ev.action} (${ev.resource_type} ${ev.resource_id})\n`;
        if (ev.payload) {
            text += "  payload: " + JSON.stringify(ev.payload) + "\n";
        }
        text += "\n";
    });

    box.textContent = text;
}

// ---------- Export helpers ----------

function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}

function exportArchiveJSON() {
    if (!archiveState.meetings.length) {
        setNotif('error', "Aucune donnée à exporter.");
        return;
    }
    const json = JSON.stringify(archiveState.meetings, null, 2);
    downloadFile("meetings_archive.json", json, "application/json");
}

function exportArchiveCSV() {
    if (!archiveState.meetings.length) {
        setNotif('error', "Aucune donnée à exporter.");
        return;
    }
    const rows = [
        ["id","title","status","created_at","validated_by","validated_at"]
    ];
    archiveState.meetings.forEach(m => {
        rows.push([
            m.id,
            m.title || "",
            m.status || "",
            m.created_at || "",
            m.validated_by || "",
            m.validated_at || ""
        ]);
    });

    const csv = rows.map(r =>
        r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(";")
    ).join("\n");

    downloadFile("meetings_archive.csv", csv, "text/csv;charset=utf-8;");
}

function exportStatsJSON() {
    if (!archiveState.lastStats) {
        setNotif('error', "Aucune statistique chargée à exporter.");
        return;
    }
    const json = JSON.stringify(archiveState.lastStats, null, 2);
    downloadFile("meeting_stats.json", json, "application/json");
}

function exportStatsCSV() {
    if (!archiveState.lastStats || !archiveState.lastStats.motions?.length) {
        setNotif('error', "Aucune statistique à exporter.");
        return;
    }
    const rows = [
        ["title","total","votes_for","votes_against","votes_abstain","votes_nsp","tally_source"]
    ];
    archiveState.lastStats.motions.forEach(m => {
        rows.push([
            m.title || "",
            m.total || 0,
            m.votes_for || 0,
            m.votes_against || 0,
            m.votes_abstain || 0,
            m.votes_nsp || 0,
            m.tally_source || "ballots",
        ]);
    });

    const csv = rows.map(r =>
        r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(";")
    ).join("\n");

    downloadFile("meeting_stats.csv", csv, "text/csv;charset=utf-8;");
}

function exportAuditJSON() {
    if (!archiveState.lastAudit) {
        setNotif('error', "Aucun audit chargé à exporter.");
        return;
    }
    const json = JSON.stringify(archiveState.lastAudit, null, 2);
    downloadFile("meeting_audit.json", json, "application/json");
}

// Initialisation
loadArchiveMeetings();
</script>

</body>
</html>
