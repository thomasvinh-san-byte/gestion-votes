<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Conduite (Op√©rateur)</title>

  <!-- Styles existants -->
  <!-- Shell + live polish -->
  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <link rel="stylesheet" href="/assets/css/app.css">
</head>

<body class="app-shell live">
<div class="app">
  <header class="app-header">
    <div class="header-left">
      <div class="brand">
        <strong>Gestion des votes</strong>
        <span>v1.0</span>
      </div>
    </div>

    <div class="header-center">
      <div class="page-title">Conduite (Op√©rateur)</div>
      <div class="page-subtitle">Workflow live : pr√©sences ‚Üí procurations ‚Üí r√©solutions ‚Üí votes</div>
    </div>

    <div class="header-right">
      <button class="icon-btn" data-drawer="readiness" title="Readiness">‚úÖ</button>
      <button class="icon-btn" data-drawer="infos" title="Informations">‚ö†Ô∏è</button>
      <button class="icon-btn" data-drawer="menu" title="Menu">‚ò∞</button>
    </div>
  </header>

  <aside class="app-sidebar">
    <div class="sidebar-inner">
      <div class="sidebar-brand">
        <div class="sidebar-brand-icon">GV</div>
        <div class="sidebar-brand-text">
          Gestion des votes
          <small>Assemblees &amp; Conseils</small>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Preparation</div>
        <nav class="nav">
          <a href="/meetings.htmx.html"><span class="ico">&#9783;</span><span class="lbl">Tableau de bord</span></a>
          <a href="/preparation.htmx.html"><span class="ico">&#9776;</span><span class="lbl">Preparation</span></a>
          <a href="/members.htmx.html"><span class="ico">&#9734;</span><span class="lbl">Membres</span></a>
          <a href="/motions.htmx.html"><span class="ico">&#9998;</span><span class="lbl">Resolutions</span></a>
        </nav>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Seance</div>
        <nav class="nav">
          <a href="/operator.htmx.html"><span class="ico">&#9881;</span><span class="lbl">Fiche seance</span></a>
          <a class="active" href="/operator_flow.htmx.html"><span class="ico">&#9654;</span><span class="lbl">Conduite live</span></a>
          <a href="/president.htmx.html"><span class="ico">&#9733;</span><span class="lbl">President</span></a>
        </nav>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Post-seance</div>
        <nav class="nav">
          <a href="/trust.htmx.html"><span class="ico">&#10003;</span><span class="lbl">Audit &amp; Trust</span></a>
          <a href="/report.htmx.html"><span class="ico">&#9993;</span><span class="lbl">Proces-verbal</span></a>
          <a href="/archives.htmx.html"><span class="ico">&#9635;</span><span class="lbl">Archives</span></a>
        </nav>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Administration</div>
        <nav class="nav">
          <a href="/admin.htmx.html"><span class="ico">&#9881;</span><span class="lbl">Parametres</span></a>
        </nav>
      </div>

      <div class="sidebar-foot">Gestion des Votes v1.0</div>
    </div>
  </aside>

  <main class="app-main">
    <div class="main-inner">

      <!-- Poller Live (OOB) : met √† jour operatorLiveSummary + badgeLive (+ currentMotionId si pr√©sent c√¥t√© fragment) -->
      <div id="operatorPoll"
           hx-get="/fragments/operator_live_oob.php"
           hx-trigger="load, every 3s, refreshNow from:body"
           hx-vals="js:{meeting_id:(new URL(window.location.href)).searchParams.get('meeting_id')}"
           hx-swap="none"></div>

      <div class="toolbar" style="justify-content:space-between; align-items:flex-start; gap:14px;">
        <div>
          <div class="h1">Conduite (Op√©rateur)</div>
          <div class="muted">Actions live : ouvrir/cl√¥turer les votes, g√©rer le flux. D√©tails via le panneau lat√©ral (‚úÖ/‚ò∞/‚ö†Ô∏è).</div>
        </div>
        <div class="toolbar" style="justify-content:flex-end;">
          <a class="btn" data-meeting-link href="/operator.htmx.html">üóÇÔ∏è Fiche s√©ance</a>
          <a class="btn" data-meeting-link href="/president.htmx.html">üßë‚Äç‚öñÔ∏è Pr√©sident</a>
        </div>
      </div>

      <div style="height:12px;"></div>

      <div class="stepper card pad">
        <div class="step active">1. Pr√©sences</div>
        <div class="step">2. Procurations</div>
        <div class="step">3. R√©solutions</div>
        <div class="step">4. Votes</div>
        <div class="step">5. Consolidation</div>
      </div>

      <div style="height:12px;"></div>

      <div class="live-grid">
        <div class="live-left">
          <div class="card">
            <div class="card-head">
              <div>
                <div class="h2" style="margin:0;">R√©solutions & pilotage</div>
                <div class="tiny muted">Ouvrir / cl√¥turer ‚Äî g√©n√©ration tokens ‚Äî incidents</div>
              </div>
              <button class="btn" data-drawer="menu">‚ò∞ Menu s√©ance</button>
            </div>
            <div class="card-body">
              <div id="operatorResolutionList">
                <div class="callout tiny muted">
                  Utilise ‚ò∞ Menu s√©ance pour l‚Äô√©tat des r√©solutions. (Le rendu ‚Äúliste d√©taill√©e‚Äù pourra √™tre branch√© ensuite en HTMX.)
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="live-right">
          <div class="card">
            <div class="card-head">
              <div>
                <div class="h2" style="margin:0;">Synth√®se</div>
                <div class="tiny muted">Quorum / votes / incidents (informatif)</div>
              </div>
              <span class="badge neutral" id="badgeLive">Live</span>
            </div>
            <div class="card-body">
              <div id="operatorLiveSummary" class="callout">‚Äî</div>
              <div class="toolbar" style="margin-top:10px;">
                <button class="btn" data-drawer="readiness">‚úÖ Readiness</button>
                <button class="btn" data-drawer="anomalies">üö® Anomalies</button>
                <button class="btn" data-drawer="infos">‚ö†Ô∏è Informations</button>
              </div>
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="card">
            <div class="card-head">
              <div>
                <div class="h2" style="margin:0;">Mode d√©grad√©</div>
                <div class="tiny muted">Saisie manuelle / incidents r√©seau</div>
              </div>
              <span class="badge neutral">Option</span>
            </div>
            <div class="card-body">
              <div class="callout tiny muted">
                Acc√®s via les actions de la r√©solution (ou panneau Infos). Aucun blocage par d√©faut.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Motion active (rempli par fragments OOB si pr√©sent) -->
      <input type="hidden" id="currentMotionId" value="">

      <div class="footer-actionbar">
        <div class="muted tiny">Actions critiques contextualis√©es (si autoris√©es).</div>
        <div class="toolbar" style="justify-content:flex-end;">

          <!-- Ouvrir vote = ouvre une r√©solution + g√©n√®re tokens -->
          <button
            class="btn primary"
            id="btnOpenVote"
            hx-post="/api/v1/operator_open_vote.php"
            hx-vals="js:{meeting_id:(new URL(window.location.href)).searchParams.get('meeting_id')}"
            hx-swap="none"
            hx-on="htmx:afterRequest: htmx.trigger(document.body,'refreshNow')"
            data-busy
          >
            Ouvrir le vote
          </button>

          <!-- Cl√¥turer vote = motion_id (currentMotionId) -->
          <button
            class="btn"
            id="btnCloseVoteOp"
            hx-post="/api/v1/motions_close.php"
            hx-vals="js:{
              meeting_id:(new URL(window.location.href)).searchParams.get('meeting_id'),
              motion_id:(document.getElementById('currentMotionId')||{}).value || ''
            }"
            hx-swap="none"
            hx-on="htmx:afterRequest: htmx.trigger(document.body,'refreshNow')"
            data-busy
          >
            Cl√¥turer le vote
          </button>

        </div>
      </div>

    </div>
  <div class="card pad" style="margin-top:12px;" id="stateDebugPanel">
  <div class="row between" style="gap:10px; flex-wrap:wrap;">
    <div>
      <div style="font-weight:800;">State debug</div>
      <div class="muted tiny">Vue compacte pour it√©rer vite (meeting, motion active, ballots, tokens, anomalies).</div>
    </div>
    <div class="row" style="gap:8px; align-items:center;">
      <button class="btn" id="btnDbgRefresh" type="button">Rafra√Æchir</button>
    </div>
  </div>
  <div class="hr"></div>
  <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
    <div class="tiny"><span class="muted">meeting_id:</span> <code id="dbgMeetingId">‚Äî</code></div>
    <div class="tiny"><span class="muted">motion:</span> <span id="dbgCurrentMotion">‚Äî</span> <span class="muted">(<span id="dbgCurrentMotionState">‚Äî</span>)</span></div>

    <div class="tiny"><span class="muted">√©ligibles:</span> <strong id="dbgEligible">‚Äî</strong> <span class="muted">(fallback:</span> <span id="dbgFallback">‚Äî</span><span class="muted">)</span></div>
    <div class="tiny"><span class="muted">motions ouvertes:</span> <strong id="dbgOpenMotions">‚Äî</strong></div>

    <div class="tiny"><span class="muted">ballots (motion active):</span> <strong id="dbgBallots">‚Äî</strong> <span class="muted">/ manquants:</span> <strong id="dbgMissing">‚Äî</strong></div>
    <div class="tiny"><span class="muted">tokens actifs:</span> <strong id="dbgTokensActive">‚Äî</strong> <span class="muted">/ expir√©s:</span> <strong id="dbgTokensExpired">‚Äî</strong></div>

    <div class="tiny"><span class="muted">votes hors statut:</span> <strong id="dbgUnexpectedBallots">‚Äî</strong></div>
    <div class="tiny"><span class="muted">tokens expir√©s (global):</span> <strong id="dbgExpiredTokens">‚Äî</strong></div>
  </div>
</div>

</main>

  <div class="drawer-overlay" data-drawer-close hidden></div>
  <aside class="drawer" hidden>
    <div class="drawer-header">
      <div class="drawer-title">Panneau</div>
      <button class="icon-btn" data-drawer-close title="Fermer">‚úï</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
  </aside>
</div>

<script src="/assets/js/shell.js"></script>
<script src="/assets/js/meeting-context.js"></script>

<script src="/assets/js/utils.js"></script>

<script src="/assets/js/state-debug.js"></script>
</body>
</html>
