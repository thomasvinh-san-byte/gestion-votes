<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Conduite (OpÃ©rateur)</title>

  <!-- Styles existants -->
  <!-- Shell + live polish -->
  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <link rel="stylesheet" href="/assets/css/app.css">
</head>

<body class="app-shell live">
<div class="app">
  <header class="app-header">
    <div class="header-left">
      <div class="brand">
        <strong>Gestion des assemblÃ©es</strong>
        <span>Live</span>
      </div>
    </div>

    <div class="header-center">
      <div class="page-title">Conduite (OpÃ©rateur)</div>
      <div class="page-subtitle">Workflow live : prÃ©sences â†’ procurations â†’ rÃ©solutions â†’ votes</div>
    </div>

    <div class="header-right">
      <button class="icon-btn" data-drawer="readiness" title="Readiness">âœ…</button>
      <button class="icon-btn" data-drawer="infos" title="Informations">âš ï¸</button>
      <button class="icon-btn" data-drawer="menu" title="Menu">â˜°</button>
    </div>
  </header>

  <aside class="app-sidebar">
    <div class="sidebar-inner">
      <nav class="nav">
        <a href="/meetings.htmx.html"><span class="ico">ğŸ </span><span class="lbl">Tableau de bord</span></a>
        <a href="/operator.htmx.html"><span class="ico">ğŸ—‚ï¸</span><span class="lbl">SÃ©ance</span></a>
        <a class="active" href="/operator_flow.htmx.html"><span class="ico">ğŸ§‘â€ğŸ’¼</span><span class="lbl">Conduite</span></a>
        <a href="/president.htmx.html"><span class="ico">ğŸ§‘â€âš–ï¸</span><span class="lbl">PrÃ©sident</span></a>
        <a href="/archives.htmx.html"><span class="ico">ğŸ—„ï¸</span><span class="lbl">Archives</span></a>
      </nav>

      <div class="sidebar-foot muted tiny" style="margin-top:14px;">
        ZÃ©ro scroll global â€” dÃ©tails via panneau latÃ©ral.
      </div>
    </div>
  </aside>

  <main class="app-main">
    <div class="main-inner">

      <!-- Poller Live (OOB) : met Ã  jour operatorLiveSummary + badgeLive (+ currentMotionId si prÃ©sent cÃ´tÃ© fragment) -->
      <div id="operatorPoll"
           hx-get="/fragments/operator_live_oob.php"
           hx-trigger="load, every 3s, refreshNow from:body"
           hx-vals="js:{meeting_id:(new URL(window.location.href)).searchParams.get('meeting_id')}"
           hx-swap="none"></div>

      <div class="toolbar" style="justify-content:space-between; align-items:flex-start; gap:14px;">
        <div>
          <div class="h1">Conduite (OpÃ©rateur)</div>
          <div class="muted">Actions live : ouvrir/clÃ´turer les votes, gÃ©rer le flux. DÃ©tails via le panneau latÃ©ral (âœ…/â˜°/âš ï¸).</div>
        </div>
        <div class="toolbar" style="justify-content:flex-end;">
          <a class="btn" data-meeting-link href="/operator.htmx.html">ğŸ—‚ï¸ Fiche sÃ©ance</a>
          <a class="btn" data-meeting-link href="/president.htmx.html">ğŸ§‘â€âš–ï¸ PrÃ©sident</a>
        </div>
      </div>

      <div style="height:12px;"></div>

      <div class="stepper card pad">
        <div class="step active">1. PrÃ©sences</div>
        <div class="step">2. Procurations</div>
        <div class="step">3. RÃ©solutions</div>
        <div class="step">4. Votes</div>
        <div class="step">5. Consolidation</div>
      </div>

      <div style="height:12px;"></div>

      <div class="live-grid">
        <div class="live-left">
          <div class="card">
            <div class="card-head">
              <div>
                <div class="h2" style="margin:0;">RÃ©solutions & pilotage</div>
                <div class="tiny muted">Ouvrir / clÃ´turer â€” gÃ©nÃ©ration tokens â€” incidents</div>
              </div>
              <button class="btn" data-drawer="menu">â˜° Menu sÃ©ance</button>
            </div>
            <div class="card-body">
              <div id="operatorResolutionList">
                <div class="callout tiny muted">
                  Utilise â˜° Menu sÃ©ance pour lâ€™Ã©tat des rÃ©solutions. (Le rendu â€œliste dÃ©taillÃ©eâ€ pourra Ãªtre branchÃ© ensuite en HTMX.)
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="live-right">
          <div class="card">
            <div class="card-head">
              <div>
                <div class="h2" style="margin:0;">SynthÃ¨se</div>
                <div class="tiny muted">Quorum / votes / incidents (informatif)</div>
              </div>
              <span class="badge neutral" id="badgeLive">Live</span>
            </div>
            <div class="card-body">
              <div id="operatorLiveSummary" class="callout">â€”</div>
              <div class="toolbar" style="margin-top:10px;">
                <button class="btn" data-drawer="readiness">âœ… Readiness</button>
                <button class="btn" data-drawer="anomalies">ğŸš¨ Anomalies</button>
                <button class="btn" data-drawer="infos">âš ï¸ Informations</button>
              </div>
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="card">
            <div class="card-head">
              <div>
                <div class="h2" style="margin:0;">Mode dÃ©gradÃ©</div>
                <div class="tiny muted">Saisie manuelle / incidents rÃ©seau</div>
              </div>
              <span class="badge neutral">Option</span>
            </div>
            <div class="card-body">
              <div class="callout tiny muted">
                AccÃ¨s via les actions de la rÃ©solution (ou panneau Infos). Aucun blocage par dÃ©faut.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Motion active (rempli par fragments OOB si prÃ©sent) -->
      <input type="hidden" id="currentMotionId" value="">

      <div class="footer-actionbar">
        <div class="muted tiny">Actions critiques contextualisÃ©es (si autorisÃ©es).</div>
        <div class="toolbar" style="justify-content:flex-end;">

          <!-- Ouvrir vote = ouvre une rÃ©solution + gÃ©nÃ¨re tokens -->
          <button
            class="btn primary"
            id="btnOpenVote"
            hx-post="/api/v1/operator_open_vote.php"
            hx-vals="js:{meeting_id:(new URL(window.location.href)).searchParams.get('meeting_id')}"
            hx-swap="none"
            hx-on="htmx:afterRequest: htmx.trigger(document.body,'refreshNow')"
            data-busy
          >
            Ouvrir le vote
          </button>

          <!-- ClÃ´turer vote = motion_id (currentMotionId) -->
          <button
            class="btn"
            id="btnCloseVoteOp"
            hx-post="/api/v1/motions_close.php"
            hx-vals="js:{
              meeting_id:(new URL(window.location.href)).searchParams.get('meeting_id'),
              motion_id:(document.getElementById('currentMotionId')||{}).value || ''
            }"
            hx-swap="none"
            hx-on="htmx:afterRequest: htmx.trigger(document.body,'refreshNow')"
            data-busy
          >
            ClÃ´turer le vote
          </button>

        </div>
      </div>

    </div>
  <div class="card pad" style="margin-top:12px;" id="stateDebugPanel">
  <div class="row between" style="gap:10px; flex-wrap:wrap;">
    <div>
      <div style="font-weight:800;">State debug</div>
      <div class="muted tiny">Vue compacte pour itÃ©rer vite (meeting, motion active, ballots, tokens, anomalies).</div>
    </div>
    <div class="row" style="gap:8px; align-items:center;">
      <button class="btn" id="btnDbgRefresh" type="button">RafraÃ®chir</button>
    </div>
  </div>
  <div class="hr"></div>
  <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
    <div class="tiny"><span class="muted">meeting_id:</span> <code id="dbgMeetingId">â€”</code></div>
    <div class="tiny"><span class="muted">motion:</span> <span id="dbgCurrentMotion">â€”</span> <span class="muted">(<span id="dbgCurrentMotionState">â€”</span>)</span></div>

    <div class="tiny"><span class="muted">Ã©ligibles:</span> <strong id="dbgEligible">â€”</strong> <span class="muted">(fallback:</span> <span id="dbgFallback">â€”</span><span class="muted">)</span></div>
    <div class="tiny"><span class="muted">motions ouvertes:</span> <strong id="dbgOpenMotions">â€”</strong></div>

    <div class="tiny"><span class="muted">ballots (motion active):</span> <strong id="dbgBallots">â€”</strong> <span class="muted">/ manquants:</span> <strong id="dbgMissing">â€”</strong></div>
    <div class="tiny"><span class="muted">tokens actifs:</span> <strong id="dbgTokensActive">â€”</strong> <span class="muted">/ expirÃ©s:</span> <strong id="dbgTokensExpired">â€”</strong></div>

    <div class="tiny"><span class="muted">votes hors statut:</span> <strong id="dbgUnexpectedBallots">â€”</strong></div>
    <div class="tiny"><span class="muted">tokens expirÃ©s (global):</span> <strong id="dbgExpiredTokens">â€”</strong></div>
  </div>
</div>

</main>

  <div class="drawer-overlay" data-drawer-close hidden></div>
  <aside class="drawer" hidden>
    <div class="drawer-header">
      <div class="drawer-title">Panneau</div>
      <button class="icon-btn" data-drawer-close title="Fermer">âœ•</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
  </aside>
</div>

<script src="/assets/js/shell.js"></script>
<script src="/assets/js/meeting-context.js"></script>

<script src="/assets/js/utils.js"></script>

<script src="/assets/js/state-debug.js"></script>
</body>
</html>
