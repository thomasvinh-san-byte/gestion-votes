<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Console op√©rateur - Fiche s√©ance AG-VOTE">
  <title>Fiche s√©ance ‚Äî AG-VOTE</title>
  <link rel="stylesheet" href="/assets/css/app.css">
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
</head>
<body>
  <div class="app-shell">
    <!-- Sidebar -->
    <aside class="app-sidebar">
      <div class="p-4 border-b">
        <a href="/" class="brand">
          <span class="brand-logo">AG-VOTE</span>
          <span class="brand-version">v2.0</span>
        </a>
      </div>
      <nav class="nav">
        <a class="nav-item" href="/meetings.htmx.html">
          <span class="nav-item-icon">üèõÔ∏è</span>
          <span>Tableau de bord</span>
        </a>
        <a class="nav-item active" href="/operator.htmx.html">
          <span class="nav-item-icon">üóÇÔ∏è</span>
          <span>Fiche s√©ance</span>
        </a>
        <a class="nav-item" href="/operator_flow.htmx.html">
          <span class="nav-item-icon">üßë‚Äçüíº</span>
          <span>Conduite live</span>
        </a>
        <a class="nav-item" href="/president.htmx.html">
          <span class="nav-item-icon">üßë‚Äç‚öñÔ∏è</span>
          <span>Pr√©sident</span>
        </a>
        <a class="nav-item" href="/trust.htmx.html">
          <span class="nav-item-icon">üõ°Ô∏è</span>
          <span>Contr√¥le</span>
        </a>
        <a class="nav-item" href="/archives.htmx.html">
          <span class="nav-item-icon">üìö</span>
          <span>Archives</span>
        </a>
        <div class="border-t mt-4 pt-4">
          <a class="nav-item" href="/admin.htmx.html">
            <span class="nav-item-icon">‚öôÔ∏è</span>
            <span>Administration</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Header -->
    <header class="app-header">
      <div class="flex items-center gap-4">
        <div>
          <h1 class="text-xl font-bold">Fiche s√©ance</h1>
          <p class="text-sm text-secondary">Orchestration & pr√©paration</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="readiness" title="√âtat de pr√©paration">
          ‚úÖ
        </button>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="quorum" title="Quorum">
          üìä
        </button>
        <button class="btn btn-ghost btn-icon" type="button" data-drawer="menu" title="Menu">
          ‚ò∞
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
      <div class="container">
        <!-- Notification area -->
        <div id="notif_box" class="hidden mb-4"></div>

        <!-- Quick Actions Bar -->
        <div class="quick-actions mb-6">
          <a class="quick-action" data-meeting-link href="/attendance.htmx.html">
            <span class="quick-action-icon">üë•</span>
            <span>Pr√©sences</span>
          </a>
          <a class="quick-action" data-meeting-link href="/proxies.htmx.html">
            <span class="quick-action-icon">üìù</span>
            <span>Procurations</span>
          </a>
          <a class="quick-action" data-meeting-link href="/motions.htmx.html">
            <span class="quick-action-icon">üìã</span>
            <span>R√©solutions</span>
          </a>
          <a class="quick-action" data-meeting-link href="/members.htmx.html">
            <span class="quick-action-icon">üë§</span>
            <span>Membres</span>
          </a>
          <a class="quick-action" data-meeting-link href="/operator_flow.htmx.html" style="background: var(--color-primary-subtle); color: var(--color-primary);">
            <span class="quick-action-icon">‚ñ∂Ô∏è</span>
            <span>Conduire</span>
          </a>
        </div>

        <!-- Context Selection -->
        <div class="card mb-6">
          <div class="card-header">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="card-title">üìå Contexte de s√©ance</h3>
                <p class="card-description">S√©lectionnez une s√©ance pour charger les donn√©es</p>
              </div>
              <span class="badge badge-primary" id="meetingStatusBadge">‚Äî</span>
            </div>
          </div>
          <div class="card-body">
            <div class="grid grid-cols-2 gap-6">
              <div class="form-group">
                <label class="form-label" for="meetingSelect">S√©ance active</label>
                <select class="form-input" id="meetingSelect">
                  <option value="">‚Äî Chargement des s√©ances ‚Äî</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">R√©sum√©</label>
                <div id="meetingSummary" class="p-3 bg-surface rounded-md border text-sm">
                  S√©lectionnez une s√©ance pour afficher le r√©sum√©
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- KPI Grid -->
        <div class="kpi-grid mb-6">
          <div class="kpi-card">
            <div class="kpi-value" id="kpiPresent">‚Äî</div>
            <div class="kpi-label">Pr√©sents</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value primary" id="kpiQuorum">‚Äî</div>
            <div class="kpi-label">Quorum</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value success" id="kpiVoted">‚Äî</div>
            <div class="kpi-label">Ont vot√©</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-value warning" id="kpiPending">‚Äî</div>
            <div class="kpi-label">En attente</div>
          </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-2 gap-6 mb-6">
          <!-- Attendance Card -->
          <div class="card">
            <div class="card-header">
              <div class="flex items-center justify-between">
                <h3 class="card-title">üë• Pr√©sences</h3>
                <span class="badge badge-success badge-dot" id="badgeAttendance">0</span>
              </div>
            </div>
            <div class="card-body">
              <div id="attendanceDetail" class="mb-4">
                <div class="stats-grid">
                  <div class="stat-item">
                    <div class="stat-value" id="statPresent">‚Äî</div>
                    <div class="stat-label">Pr√©sents</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value" id="statRemote">‚Äî</div>
                    <div class="stat-label">Distants</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value" id="statProxy">‚Äî</div>
                    <div class="stat-label">Repr√©sent√©s</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value" id="statAbsent">‚Äî</div>
                    <div class="stat-label">Absents</div>
                  </div>
                </div>
              </div>
              <a class="btn btn-secondary w-full" data-meeting-link href="/attendance.htmx.html">
                G√©rer les pr√©sences ‚Üí
              </a>
            </div>
          </div>

          <!-- Active Motion Card -->
          <div class="card">
            <div class="card-header">
              <div class="flex items-center justify-between">
                <h3 class="card-title">üó≥Ô∏è R√©solution active</h3>
                <span class="badge badge-neutral" id="badgeMotion">Aucune</span>
              </div>
            </div>
            <div class="card-body">
              <div id="motionDetail" class="mb-4">
                <div class="p-4 bg-surface rounded-lg border text-center">
                  <div class="text-muted mb-2">Aucune r√©solution ouverte</div>
                  <div class="text-sm text-secondary">
                    Ouvrez une r√©solution depuis la page R√©solutions ou Conduite
                  </div>
                </div>
              </div>
              <div class="flex gap-2">
                <button class="btn btn-primary flex-1" id="btnOpenMotion" disabled>
                  ‚ñ∂Ô∏è Ouvrir le vote
                </button>
                <button class="btn btn-secondary flex-1" id="btnCloseMotion" disabled>
                  ‚èπÔ∏è Cl√¥turer
                </button>
              </div>
              <div class="text-xs text-muted mt-2" id="degradedMotionLabel"></div>
            </div>
          </div>
        </div>

        <!-- Quorum Indicator -->
        <div class="card mb-6">
          <div class="card-header">
            <div class="flex items-center justify-between">
              <h3 class="card-title">üìä √âtat du quorum</h3>
              <span class="badge" id="quorumStatusBadge">‚Äî</span>
            </div>
          </div>
          <div class="card-body">
            <div class="quorum-indicator" id="quorumIndicator">
              <div class="quorum-header">
                <span class="text-sm font-medium">Progression vers le quorum</span>
                <span class="text-sm text-muted" id="quorumRatio">‚Äî / ‚Äî</span>
              </div>
              <div class="quorum-bar">
                <div class="quorum-fill partial" id="quorumFill" style="width: 0%"></div>
                <div class="quorum-threshold" id="quorumThreshold" style="left: 50%"></div>
              </div>
              <div class="quorum-stats">
                <span id="quorumCurrent">0 pr√©sents</span>
                <span id="quorumRequired">Seuil: 50%</span>
              </div>
            </div>
            <div class="mt-4 p-3 bg-surface rounded-md" id="quorumJustification">
              <div class="text-sm text-muted">
                La justification du quorum appara√Ætra ici une fois la s√©ance charg√©e.
              </div>
            </div>
          </div>
        </div>

        <!-- Notifications Card -->
        <div class="card">
          <div class="card-header">
            <div class="flex items-center justify-between">
              <h3 class="card-title">üîî Notifications</h3>
              <span class="badge badge-info" id="badgeNotifications">0</span>
            </div>
          </div>
          <div class="card-body">
            <div id="notificationsList">
              <div class="empty-state p-6">
                <div class="empty-state-icon text-3xl">üì≠</div>
                <div class="empty-state-title">Aucune notification</div>
                <div class="empty-state-description">
                  Les √©v√©nements importants appara√Ætront ici
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer note -->
        <div class="alert alert-info mt-6">
          <span>üí°</span>
          <span>Rappel : les exports (CSV / PDF) sont disponibles <strong>apr√®s validation</strong> de la s√©ance par le pr√©sident.</span>
        </div>
      </div>
    </main>
  </div>

  <!-- Drawer Overlay -->
  <div class="drawer-backdrop" data-drawer-close></div>
  
  <!-- Drawer -->
  <aside class="drawer" id="drawer">
    <div class="drawer-header">
      <div id="drawerTitle" class="font-semibold">Menu</div>
      <button class="btn btn-ghost btn-icon btn-sm" type="button" data-drawer-close>‚úï</button>
    </div>
    <div class="drawer-body" id="drawerBody"></div>
  </aside>

  <!-- Scripts -->
  <script src="/assets/js/utils.js"></script>
  <script src="/assets/js/shell.js"></script>
  <script src="/assets/js/meeting-context.js"></script>

  <script>
  (function() {
    'use strict';

    const meetingSelect = document.getElementById('meetingSelect');
    let currentMeetingId = null;

    // Get meeting_id from URL
    function getMeetingIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('meeting_id');
    }

    // Update all meeting links with current meeting_id
    function updateMeetingLinks(meetingId) {
      document.querySelectorAll('[data-meeting-link]').forEach(link => {
        const baseUrl = link.getAttribute('href').split('?')[0];
        if (meetingId) {
          link.href = `${baseUrl}?meeting_id=${meetingId}`;
        } else {
          link.href = baseUrl;
        }
      });
    }

    // Load meetings list
    async function loadMeetings() {
      try {
        const { status, body } = await api('/api/v1/meetings_index.php');
        
        if (body && body.ok && body.data && Array.isArray(body.data.meetings)) {
          meetingSelect.innerHTML = '<option value="">‚Äî S√©lectionner une s√©ance ‚Äî</option>';

          body.data.meetings.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.id;
            opt.textContent = `${m.title} (${m.status || 'draft'})`;
            meetingSelect.appendChild(opt);
          });

          // Pre-select if meeting_id in URL
          const urlMeetingId = getMeetingIdFromUrl();
          if (urlMeetingId) {
            meetingSelect.value = urlMeetingId;
            loadMeetingContext(urlMeetingId);
          }
        }
      } catch (err) {
        setNotif('error', 'Erreur chargement s√©ances: ' + err.message);
      }
    }

    // Load meeting context
    async function loadMeetingContext(meetingId) {
      if (!meetingId) {
        resetContext();
        return;
      }

      currentMeetingId = meetingId;
      updateMeetingLinks(meetingId);

      // Update URL
      const url = new URL(window.location);
      url.searchParams.set('meeting_id', meetingId);
      window.history.replaceState({}, '', url);

      try {
        // Load meeting details
        const { body } = await api(`/api/v1/meetings.php?id=${meetingId}`);
        
        if (body && body.ok && body.data) {
          const m = body.data;
          
          // Update summary
          document.getElementById('meetingSummary').innerHTML = `
            <div class="font-medium">${escapeHtml(m.title)}</div>
            <div class="text-muted text-sm mt-1">${m.description || 'Pas de description'}</div>
            <div class="text-xs text-secondary mt-2">Cr√©√©e le ${formatDate(m.created_at)}</div>
          `;

          // Update status badge
          const statusBadge = document.getElementById('meetingStatusBadge');
          const statusMap = {
            'draft': { class: 'badge-neutral', text: 'Brouillon' },
            'scheduled': { class: 'badge-info', text: 'Programm√©e' },
            'live': { class: 'badge-danger badge-dot', text: 'En cours' },
            'closed': { class: 'badge-success', text: 'Termin√©e' },
            'archived': { class: 'badge-neutral', text: 'Archiv√©e' }
          };
          const status = statusMap[m.status] || statusMap['draft'];
          statusBadge.className = `badge ${status.class}`;
          statusBadge.textContent = status.text;
        }

        // Load attendance stats
        await loadAttendanceStats(meetingId);
        
        // Load quorum status
        await loadQuorumStatus(meetingId);
        
        // Load active motion
        await loadActiveMotion(meetingId);

      } catch (err) {
        setNotif('error', 'Erreur: ' + err.message);
      }
    }

    // Load attendance stats
    async function loadAttendanceStats(meetingId) {
      try {
        const { body } = await api(`/api/v1/attendances.php?meeting_id=${meetingId}`);
        
        if (body && body.ok) {
          const stats = body.stats || {};
          document.getElementById('statPresent').textContent = stats.present || 0;
          document.getElementById('statRemote').textContent = stats.remote || 0;
          document.getElementById('statProxy').textContent = stats.proxy || 0;
          document.getElementById('statAbsent').textContent = stats.absent || 0;
          document.getElementById('badgeAttendance').textContent = stats.total || 0;
          document.getElementById('kpiPresent').textContent = (stats.present || 0) + (stats.remote || 0);
        }
      } catch (err) {
        console.error('Attendance error:', err);
      }
    }

    // Load quorum status
    async function loadQuorumStatus(meetingId) {
      try {
        const { body } = await api(`/api/v1/quorum_status.php?meeting_id=${meetingId}`);
        
        if (body && body.ok && body.data) {
          const q = body.data;
          
          // Update KPI
          document.getElementById('kpiQuorum').textContent = q.met ? '‚úì' : '‚úó';
          document.getElementById('kpiQuorum').className = `kpi-value ${q.met ? 'success' : 'danger'}`;
          
          // Update bar
          const fill = document.getElementById('quorumFill');
          const ratio = Math.min(100, Math.round((q.ratio || 0) * 100));
          fill.style.width = ratio + '%';
          fill.className = `quorum-fill ${q.met ? 'reached' : ratio > 30 ? 'partial' : 'critical'}`;
          
          // Update threshold marker
          const threshold = document.getElementById('quorumThreshold');
          threshold.style.left = Math.round((q.threshold || 0.5) * 100) + '%';
          
          // Update text
          document.getElementById('quorumRatio').textContent = `${ratio}% / ${Math.round((q.threshold || 0.5) * 100)}%`;
          document.getElementById('quorumCurrent').textContent = `${q.present || 0} pr√©sents`;
          document.getElementById('quorumRequired').textContent = `Seuil: ${Math.round((q.threshold || 0.5) * 100)}%`;
          
          // Update badge
          const badge = document.getElementById('quorumStatusBadge');
          badge.className = `badge ${q.met ? 'badge-success' : 'badge-warning'}`;
          badge.textContent = q.met ? 'Atteint' : 'Non atteint';
          
          // Update justification
          document.getElementById('quorumJustification').innerHTML = `
            <div class="text-sm">${q.justification || 'Aucune justification disponible'}</div>
          `;
        }
      } catch (err) {
        console.error('Quorum error:', err);
      }
    }

    // Load active motion
    async function loadActiveMotion(meetingId) {
      try {
        const { body } = await api(`/api/v1/motions.php?meeting_id=${meetingId}&status=open`);
        
        const btnOpen = document.getElementById('btnOpenMotion');
        const btnClose = document.getElementById('btnCloseMotion');
        const badge = document.getElementById('badgeMotion');
        const detail = document.getElementById('motionDetail');
        
        if (body && body.ok && body.data && body.data.motions && body.data.motions.length > 0) {
          const m = body.data.motions[0];
          
          badge.className = 'badge badge-warning badge-dot';
          badge.textContent = 'Vote ouvert';
          
          detail.innerHTML = `
            <div class="p-4 bg-warning-subtle rounded-lg border border-warning">
              <div class="font-semibold text-warning-text">${escapeHtml(m.title)}</div>
              <div class="text-sm text-muted mt-1">${m.description || ''}</div>
              <div class="flex items-center gap-4 mt-3 text-sm">
                <span>‚úÖ Pour: <strong id="voteFor">‚Äî</strong></span>
                <span>‚ùå Contre: <strong id="voteAgainst">‚Äî</strong></span>
                <span>‚ö™ Abstention: <strong id="voteAbstain">‚Äî</strong></span>
              </div>
            </div>
          `;
          
          btnOpen.disabled = true;
          btnClose.disabled = false;
          
          // Update vote counts
          document.getElementById('kpiVoted').textContent = m.votes_count || 0;
          document.getElementById('kpiPending').textContent = m.pending_count || 0;
        } else {
          badge.className = 'badge badge-neutral';
          badge.textContent = 'Aucune';
          
          detail.innerHTML = `
            <div class="p-4 bg-surface rounded-lg border text-center">
              <div class="text-muted mb-2">Aucune r√©solution ouverte</div>
              <div class="text-sm text-secondary">
                Ouvrez une r√©solution depuis la page R√©solutions
              </div>
            </div>
          `;
          
          btnOpen.disabled = false;
          btnClose.disabled = true;
          
          document.getElementById('kpiVoted').textContent = '‚Äî';
          document.getElementById('kpiPending').textContent = '‚Äî';
        }
      } catch (err) {
        console.error('Motion error:', err);
      }
    }

    // Reset context
    function resetContext() {
      currentMeetingId = null;
      document.getElementById('meetingSummary').innerHTML = 'S√©lectionnez une s√©ance';
      document.getElementById('meetingStatusBadge').textContent = '‚Äî';
      updateMeetingLinks(null);
    }

    // Event listeners
    meetingSelect.addEventListener('change', () => {
      loadMeetingContext(meetingSelect.value);
    });

    document.getElementById('btnOpenMotion').addEventListener('click', async () => {
      if (!currentMeetingId) return;
      // Redirect to motions page to select which motion to open
      window.location.href = `/motions.htmx.html?meeting_id=${currentMeetingId}`;
    });

    document.getElementById('btnCloseMotion').addEventListener('click', async () => {
      if (!currentMeetingId) return;
      
      if (!confirm('√ätes-vous s√ªr de vouloir cl√¥turer le vote en cours ?')) return;
      
      try {
        const { body } = await api('/api/v1/motions_close.php', { meeting_id: currentMeetingId });
        
        if (body && body.ok) {
          setNotif('success', 'Vote cl√¥tur√©');
          loadActiveMotion(currentMeetingId);
        } else {
          setNotif('error', body?.error || 'Erreur');
        }
      } catch (err) {
        setNotif('error', err.message);
      }
    });

    // Initial load
    loadMeetings();

    // Auto-refresh every 5s if meeting selected
    setInterval(() => {
      if (currentMeetingId) {
        loadAttendanceStats(currentMeetingId);
        loadQuorumStatus(currentMeetingId);
        loadActiveMotion(currentMeetingId);
      }
    }, 5000);

  })();
  </script>
</body>
</html>
